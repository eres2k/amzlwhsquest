<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMZL WHS Coordinator Quest (Gemini AI Enabled)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root { --bg-color: #050505; }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
            font-family: 'Press Start 2P', monospace; color: white; user-select: none;
        }

        #game-wrapper {
            position: relative; width: 768px; height: 672px;
            background: #000; border: 20px solid #222; border-radius: 20px;
            box-shadow: 0 0 100px rgba(0,0,0,1); overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        #crt-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%; pointer-events: none; z-index: 900;
            animation: flicker 0.15s infinite;
        }

        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none; z-index: 901; border-radius: 10px;
        }

        @keyframes flicker { 0% { opacity: 0.95; } 100% { opacity: 1; } }

        #ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: flex-end; padding: 20px; box-sizing: border-box; z-index: 1000;
        }

        #dialog-box {
            width: 100%; min-height: 140px; background: #0000a0; 
            border: 4px solid #fff; border-radius: 8px; display: none;
            flex-direction: row; padding: 16px; box-sizing: border-box;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5); pointer-events: auto; 
        }

        #portrait {
            width: 64px; height: 64px; background: #000; border: 2px solid white;
            margin-right: 20px; flex-shrink: 0; image-rendering: pixelated;
        }

        #text-content {
            flex-grow: 1; font-size: 14px; line-height: 1.6; color: white;
            text-shadow: 2px 2px #000; white-space: pre-wrap;
        }

        #press-space-hint {
            font-size: 10px; color: #ffff00; margin-top: 10px;
            animation: blink 1s infinite; display: block;
        }
        
        .gemini-badge {
            font-size: 10px; color: #00ffff; margin-bottom: 8px; display: none;
            text-transform: uppercase; text-shadow: 0 0 5px #00ffff;
        }
        
        @keyframes blink { 50% { opacity: 0; } }

        .hud-text {
            position: absolute; top: 20px; right: 20px; color: white;
            text-align: right; text-shadow: 2px 2px black; font-size: 12px;
            background: rgba(0,0,0,0.5); padding: 10px; border: 2px solid white;
        }
        
        #slogan-display {
            position: absolute; top: 20px; left: 20px; color: #ffff00;
            text-shadow: 2px 2px black; font-size: 12px; max-width: 350px;
            background: rgba(0,0,0,0.6); padding: 5px; border-left: 3px solid #eab308;
            display: none;
        }
        
        #boss-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 60%; display: none;
        }
        
        .boss-bar-bg { width: 100%; height: 10px; background: #333; border: 2px solid white; }
        .boss-bar-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }
        .boss-name { color: #ff0000; text-align: center; font-size: 10px; margin-bottom: 4px; text-shadow: 1px 1px black; }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="gameCanvas" width="256" height="224"></canvas>
        <div id="crt-overlay"></div>
        <div id="vignette"></div>

        <div id="ui-overlay">
            <div id="slogan-display"></div>

            <div class="hud-text" id="hud-layer" style="display:none;">
                <div style="color:#ff4444; margin-bottom:5px;">LIFE <span id="life-val">❤️❤️❤️❤️❤️</span></div>
                <div style="color:#44ff44;">HAZARDS: <span id="score-val">0/5</span></div>
            </div>
        
            <div id="boss-hud">
                <div class="boss-name" id="boss-name-el">BOSS NAME</div>
                <div class="boss-bar-bg"><div class="boss-bar-fill" id="boss-health-el"></div></div>
            </div>

            <div id="dialog-box">
                <canvas id="portrait" width="32" height="32"></canvas>
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div id="gemini-badge" class="gemini-badge">✨ SIMON IS ANALYZING...</div>
                    <div id="text-content"></div>
                    <div id="press-space-hint">▼ PRESS SPACE</div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
// --- CONFIG ---
// Gemini API key is fetched at runtime from Netlify Functions
let apiKey = null;
let apiKeyPromise = null;
const MODEL_NAME = "gemini-2.5-flash-lite";

// --- CHARACTER DATA ---
const CHAR_DATA = {
    "Carrie": { role: "Perfectionist Monk", backstory: "Meditates on 5S standards. Can spot a misaligned floor tape label from 50 meters away.", attack: "Zen Correction" },
    "Nevena": { role: "The Worrier", backstory: "Always expects the worst case scenario. Makes legendary Palatschinken to calm her nerves.", attack: "Anxiety Blast" },
    "Joao": { role: "Brazilian Fire", backstory: "Passionate, loud, and unstoppable. His safety shouts echo through the entire delivery station.", attack: "Samba Kick" },
    "Roman": { role: "Silent Warrior", backstory: "A man of few words but many audits. He moves like a shadow and fixes hazards before they exist.", attack: "Stealth Audit" }
};

// --- SIMULATED AI DATABASE (FALLBACKS) ---
const SIMULATED_AI = {
    slogans: [
        "ENTROPY IS THE ENEMY. ORDER IS THE ONLY SURVIVAL STRATEGY.",
        "YOUR SKELETON PREFERS TO STAY INSIDE YOUR BODY. ASSIST IT.",
        "ACCIDENTS ARE JUST PHYSICS TAKING REVENGE ON YOUR INCOMPETENCE.",
        "COMPLIANCE IS THE ONLY SHIELD AGAINST THE HEAT DEATH OF THE UNIVERSE.",
        "SAFETY REGULATIONS ARE WRITTEN IN BLOOD. DO NOT ADD A NEW CHAPTER."
    ],
    tips: [
        "A blocked exit? In a fire, that box becomes your tombstone. The fire marshal will not be amused by your charred remains. Move it immediately.",
        "Chemical spill. Entropy is leaking. If you step in it, you will dissolve, and I will have to fill out form 7B-9. Contain it before it spreads.",
        "Debris detected. Chaos on the floor leads to chaos in the metrics. If I trip on this, I will haunt you from the afterlife. Clean it up.",
        "Trip hazard. Gravity does not care about your excuses or your tenure. It pulls us all down equally. Tape that cable.",
        "Unstable stack. Isaac Newton is rolling in his grave looking at this abomination. The center of gravity is a suggestion to you? Fix it.",
        "Fire equipment blocked. Do you plan to fight the inferno with your bare hands and optimism? Clear the path or prepare to roast."
    ],
    runners: [
        "Halt! Your kinetic energy increases with the square of velocity. If you collide with a rack, the physics calculation will end in your termination.",
        "You are not a photon. You have mass. When you run, you invite disaster. Do not invite disaster into my warehouse; he is a terrible guest.",
        "Running? I've seen glaciers move with more urgency. And significantly more safety. Slow down before you become a statistic.",
        "We are fighting the inevitable decay of order, not the clock. Walk with purpose, not haste. My blood pressure cannot handle your velocity."
    ],
    taunts: [
        "My spreadsheet predicts your failure with 99% accuracy!",
        "You cannot audit the inevitable heat death of this facility!",
        "I am the final regulation! I am the red tape!",
        "Your compliance score is dropping faster than your will to live!",
        "Resistance is a safety violation! Prepare for a write-up!"
    ],
    simon_taunts: [
        "I AM THE SAFETY STANDARD! KNEEL BEFORE PROTOCOL!",
        "YOU CANNOT ESCAPE THE AUDIT! I SEE ALL!",
        "ENTROPY COMES FOR US ALL, BUT I COME FOR YOU FIRST!",
        "YOUR PPE IS INSUFFICIENT TO PROTECT YOU FROM ME!"
    ],
    banter: [
        "Coord: 'Safety First!' / Ops: 'But my rates will plummet!'",
        "Coord: 'Read the manual!' / Ops: 'I can't read!'",
        "Coord: 'Stop running!' / Ops: 'The packages need me!'",
        "Coord: 'That's a hazard!' / Ops: 'It's a feature!'"
    ],
    reviews_win: [
        "Performance: STATISTICALLY IMPROBABLE. You survived against overwhelming odds. The warehouse stands. The metrics align. I am... adequately pleased.",
        "You fought chaos and won. For today. Tomorrow, entropy returns, but for now, you may rest. Good job not dying.",
        "Adequate. You respected the laws of physics and the laws of Amazon. I have nothing to write up. This feels... strange."
    ],
    reviews_loss: [
        "Performance: CATASTROPHIC. Entropy has won. The warehouse is lost to chaos. As predicted by my models.",
        "You failed. Gravity, inertia, and stupidity have combined to destroy us all. My report will be scathing.",
        "Safety is binary. You are a zero. The metrics weep for what you have done today. Return your vest."
    ]
};

// --- AI STATUS HELPERS ---
const aiStatusEl = document.getElementById('ai-status');
let aiStatus = "init";

function setAIStatus(message, level = 'info') {
    aiStatus = level;
    if (!aiStatusEl) return;
    aiStatusEl.style.display = 'block';
    aiStatusEl.style.borderColor = level === 'error' ? '#f00' : '#fff';
    aiStatusEl.style.color = level === 'error' ? '#ffaaaa' : '#00ffff';
    aiStatusEl.innerText = message;
}
setAIStatus('AI: Waiting for first prompt...', 'info');

async function fetchApiKeyFromNetlify() {
    try {
        setAIStatus('AI: Fetching key from Netlify...', 'info');
        const res = await fetch('/.netlify/functions/get-gemini-key', { cache: 'no-store' });
        if (!res.ok) throw new Error(`Netlify key endpoint returned ${res.status}`);
        const data = await res.json();
        const key = (data && data.apiKey ? String(data.apiKey) : '').trim();
        if (!key) throw new Error('No apiKey field in Netlify response');
        apiKey = key;
        setAIStatus('AI key loaded from Netlify.', 'info');
        return apiKey;
    } catch (err) {
        setAIStatus(`AI key fetch failed: ${err.message || err}`, 'error');
        return null;
    }
}

async function ensureApiKey() {
    if (apiKey) return apiKey;
    if (!apiKeyPromise) apiKeyPromise = fetchApiKeyFromNetlify();
    return apiKeyPromise;
}

// --- GEMINI API ---
async function callGemini(prompt, category = 'generic', context = {}) {
    const activeKey = await ensureApiKey();
    if (!activeKey) {
        console.log("No valid API Key, using fallback.");
        setAIStatus('AI: Missing API key, using fallback.', 'error');
        return getRandomFallback(prompt, category, context);
    }

    // Using flash-lite model per latest instructions
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${activeKey}`;
    const payload = { 
        contents: [{ 
            parts: [{ text: prompt }] 
        }] 
    };
    const timeout = new Promise((r) => setTimeout(() => r("TIMEOUT"), 10000));

    try {
        setAIStatus('AI: Contacting Gemini...', 'info');
        const fetchPromise = fetch(url, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
        });
        const response = await Promise.race([fetchPromise, timeout]);
        
        if (response === "TIMEOUT") {
            console.log("Gemini Timed Out");
            setAIStatus('AI timeout — using fallback lines.', 'error');
            return getRandomFallback(prompt, category, context);
        }
        if (!response.ok) {
            let errText = '';
            try {
                const errJson = await response.clone().json();
                errText = errJson?.error?.message || '';
            } catch (err) {
                errText = await response.text().catch(() => '');
            }

            const normalized = errText.toLowerCase();
            const leakedKey = response.status === 403 && normalized.includes('reported as leaked');
            const userMessage = leakedKey
                ? 'AI blocked: API key was reported leaked — replace with a fresh server-side key.'
                : `AI error ${response.status}: ${errText || 'see console'}`;

            console.log("Gemini Error:", response.status, errText);
            setAIStatus(userMessage, 'error');
            return getRandomFallback(prompt, category, context);
        }
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text) {
            setAIStatus(`AI online (${MODEL_NAME})`, 'info');
            return text.trim();
        }
        setAIStatus('AI returned empty text, using fallback.', 'error');
        return getRandomFallback(prompt, category, context);

    } catch (e) { 
        console.error(e);
        setAIStatus(`AI request failed: ${e.message || e}`, 'error');
        return getRandomFallback(prompt, category, context); 
    }
}

function getRandomFallback(prompt, category = 'generic', context = {}) {
    const hazardName = context.hazardName;
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const is = (key) => category === key || prompt.includes(key);

    if (is("slogans")) return pick(SIMULATED_AI.slogans);
    if (is("runners")) return pick(SIMULATED_AI.runners);
    if (is("banter")) return pick(SIMULATED_AI.banter);
    if (is("taunt")) {
         if(prompt.includes("Simon")) return pick(SIMULATED_AI.simon_taunts);
         return pick(SIMULATED_AI.taunts);
    }
    if (is("reviews_loss")) return pick(SIMULATED_AI.reviews_loss);
    if (is("reviews_win")) return pick(SIMULATED_AI.reviews_win);

    if (is("hazard") || is("tips")) {
        if (hazardName) {
            return `Hazard "${hazardName}" cleared. Paperwork avoided, entropy delayed.`;
        }
        return pick(SIMULATED_AI.tips);
    }

    return pick(SIMULATED_AI.tips);
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 16;
const MAP_W = 60;
const MAP_H = 40;

// --- AUDIO ---
const AudioSys = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        if(!this.ctx) this.ctx = new AudioContext();
    },
    resume: function() {
        if (this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },
    playTone: function(freq, type, duration, vol=0.1) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    playNoise: function(duration, vol=0.1) {
        if(!this.ctx) return;
        const bufferSize = this.ctx.sampleRate * duration;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        noise.connect(gain);
        gain.connect(this.ctx.destination);
        noise.start();
    },
    sfx: {
        step: () => AudioSys.playNoise(0.05, 0.05),
        throw: () => AudioSys.playTone(400, 'square', 0.1, 0.1),
        hit: () => { AudioSys.playNoise(0.1, 0.2); AudioSys.playTone(100, 'sawtooth', 0.1, 0.2); },
        bossHit: () => { AudioSys.playNoise(0.2, 0.3); AudioSys.playTone(80, 'sawtooth', 0.2, 0.3); },
        alert: () => AudioSys.playTone(600, 'square', 0.2, 0.1),
        text: () => AudioSys.playTone(800, 'square', 0.03, 0.05),
        fix: () => { [440, 554, 659].forEach((f,i) => setTimeout(()=>AudioSys.playTone(f,'sine',0.2,0.1), i*100)); },
        hurt: () => AudioSys.playTone(150, 'sawtooth', 0.3, 0.2),
        start: () => { [440,440,440,660].forEach((f,i)=>setTimeout(()=>AudioSys.playTone(f,'square',0.2,0.2), i*150)); },
        angry: () => AudioSys.playTone(150, 'square', 0.5, 0.2),
        select: () => AudioSys.playTone(550, 'square', 0.1, 0.1),
        bossIntro: () => { 
            AudioSys.playTone(100, 'sawtooth', 1.0, 0.3);
            setTimeout(() => AudioSys.playTone(80, 'sawtooth', 1.0, 0.3), 200);
        },
        logo: () => {
             AudioSys.playTone(440, 'triangle', 0.1, 0.2);
             setTimeout(() => AudioSys.playTone(880, 'triangle', 0.4, 0.2), 100);
        }
    }
};

const MusicSys = {
    tracks: {
        title: new Audio('Pixel Reverie.mp3'),
        menu: new Audio('Game Over But Not Really.mp3'),
        ingame: new Audio('Pixel Warehouse Crawl.mp3'),
        boss: new Audio('Pixel Panic.mp3')
    },
    currentName: null,
    init() {
        Object.values(this.tracks).forEach(a => {
            a.loop = true;
            a.volume = 0.35;
            a.preload = 'auto';
        });
    },
    play(name) {
        const track = this.tracks[name];
        if (!track) return;
        if (this.currentName && this.currentName !== name) {
            this.stop();
        }
        this.currentName = name;
        const promise = track.play();
        if (promise) promise.catch(() => {});
    },
    stop() {
        if (this.currentName && this.tracks[this.currentName]) {
            const current = this.tracks[this.currentName];
            current.pause();
            current.currentTime = 0;
        }
        this.currentName = null;
    },
    resume() {
        if (this.currentName && this.tracks[this.currentName]?.paused) {
            const promise = this.tracks[this.currentName].play();
            if (promise) promise.catch(() => {});
        }
    },
    stopAll() {
        Object.values(this.tracks).forEach(a => { a.pause(); a.currentTime = 0; });
        this.currentName = null;
    }
};

// --- ASSETS ---
const GFX = {};
function generateAssets() {
    const c = (w,h,f) => { const c=document.createElement('canvas');c.width=w;c.height=h;f(c.getContext('2d'));return c;};

    GFX.logo = c(40, 40, ctx => { ctx.fillStyle = '#eab308'; ctx.fillRect(0, 0, 40, 40); ctx.fillStyle = '#fff'; ctx.font = '24px monospace'; ctx.fillText("EE", 5, 28); });
    const createPlayer = (hairColor, hairStyle) => c(16,16, ctx => {
        ctx.fillStyle = hairColor; 
        if (hairStyle === 'long') ctx.fillRect(4,1,8,6); if (hairStyle === 'short') ctx.fillRect(4,1,8,4); if (hairStyle === 'spiky') { ctx.fillRect(4,1,8,4); ctx.fillRect(6,0,4,1); }
        ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,5,8,4); ctx.fillStyle = '#2563eb'; ctx.fillRect(3,9,10,6); ctx.fillStyle = '#60a5fa'; ctx.fillRect(4,10,1,4); ctx.fillRect(11,10,1,4); ctx.fillStyle = '#1e3a8a'; ctx.fillRect(5,15,2,1); ctx.fillRect(9,15,2,1);
    });
    GFX.chars = { "Carrie": createPlayer('#fcd34d', 'long'), "Nevena": createPlayer('#27272a', 'long'), "Joao": createPlayer('#3f3f46', 'short'), "Roman": createPlayer('#a1a1aa', 'spiky') };
    GFX.simon = c(16,16, ctx => { ctx.fillStyle = '#222'; ctx.fillRect(4,1,8,5); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,5,8,4); ctx.fillStyle = '#000'; ctx.fillRect(4,7,8,1); ctx.fillStyle = '#aaddff'; ctx.fillRect(5,7,2,1); ctx.fillRect(9,7,2,1); ctx.fillStyle = '#eab308'; ctx.fillRect(3,9,10,6); ctx.fillStyle = '#fff'; ctx.fillRect(6,11,4,4); });
    GFX.simonFace = c(32,32, ctx => { ctx.imageSmoothingEnabled=false; ctx.drawImage(GFX.simon,0,0,16,16,0,0,32,32); });
    
    // SUPER SIMON BOSS SPRITE
    GFX.simonBoss = c(32,32, ctx => { 
        ctx.fillStyle = '#222'; ctx.fillRect(8,2,16,10); // Big Hair
        ctx.fillStyle = '#ffcc99'; ctx.fillRect(8,12,16,8); // Head
        ctx.fillStyle = '#000'; ctx.fillRect(8,14,16,2); // Shades
        ctx.fillStyle = '#ff0000'; ctx.fillRect(10,14,4,2); ctx.fillRect(18,14,4,2); // Glowing Eyes
        ctx.fillStyle = '#eab308'; ctx.fillRect(6,20,20,12); // Big Vest
    });

    GFX.ops = c(16,16, ctx => { ctx.fillStyle = '#333'; ctx.fillRect(4,2,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#dc2626'; ctx.fillRect(3,10,10,5); ctx.fillStyle = '#000'; ctx.fillRect(5,7,2,1); ctx.fillRect(9,7,2,1); });
    GFX.boss_manager = c(16,16, ctx => { ctx.fillStyle = '#000'; ctx.fillRect(0,0,16,16); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,2,8,6); ctx.fillStyle = '#f00'; ctx.fillRect(6,4,2,1); ctx.fillRect(10,4,2,1); });
    GFX.boss_hr = c(16,16, ctx => { ctx.fillStyle = '#4b5563'; ctx.fillRect(3,1,10,6); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#22c55e'; ctx.fillRect(2,10,12,5); ctx.fillStyle = '#000'; ctx.fillRect(6,7,2,1); ctx.fillRect(10,7,2,1); });
    GFX.boss_sebastian = c(16,16, ctx => { ctx.fillStyle = '#222'; ctx.fillRect(4,1,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,5,8,4); ctx.fillStyle = '#000080'; ctx.fillRect(2,9,12,6); ctx.fillStyle = '#000'; ctx.fillRect(5,6,2,1); ctx.fillRect(9,6,2,1); });
    GFX.boss_avetta = c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(2,2,12,12); ctx.fillStyle = '#0f0'; ctx.fillRect(4,4,2,2); ctx.fillRect(4,8,2,2); ctx.fillStyle = '#f00'; ctx.fillRect(10,4,2,2); });
    GFX.boss_bot = c(16,16, ctx => { ctx.fillStyle = '#555'; ctx.fillRect(2,2,12,12); ctx.fillStyle = '#0f0'; ctx.fillRect(4,6,8,2); });
    GFX.assoc = c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(4,2,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#eab308'; ctx.fillRect(3,10,10,5); });
    GFX.runner = c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(4,2,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#eab308'; ctx.fillRect(3,10,10,5); ctx.fillStyle = '#fff'; ctx.fillRect(1, 12, 2, 1); ctx.fillRect(14, 10, 2, 1); });
    GFX.clutter = { cart: c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(2,6,12,8); ctx.fillStyle = '#8b4513'; ctx.fillRect(4,4,8,6); }), coffee: c(8,8, ctx => { ctx.fillStyle='#fff'; ctx.fillRect(2,2,4,5); }), paper: c(8,8, ctx => { ctx.fillStyle='#eee'; ctx.fillRect(1,3,6,4); }), tape: c(8,8, ctx => { ctx.fillStyle='#d97706'; ctx.beginPath(); ctx.arc(4,4,3,0,Math.PI*2); ctx.fill(); }) };
    GFX.hazards = { spill: c(16,16, ctx => { ctx.fillStyle = '#4ade80aa'; ctx.beginPath(); ctx.arc(8,8,7,0,Math.PI*2); ctx.fill(); }), box: c(16,16, ctx => { ctx.fillStyle = '#8b4513'; ctx.fillRect(2,4,12,11); ctx.fillStyle = '#cd853f'; ctx.fillRect(4,6,8,7); }), drum: c(16,16, ctx => { ctx.fillStyle = '#1e3a8a'; ctx.fillRect(4,2,8,12); }), tall_pallet: c(16,16, ctx => { ctx.fillStyle = '#a855f7'; ctx.fillRect(3,2,10,12); }), debris: c(16,16, ctx => { ctx.fillStyle = '#8b4513'; ctx.translate(8,8); ctx.rotate(0.5); ctx.fillRect(-6,-2,12,4); }) };
    GFX.door = c(16,16, ctx => { ctx.fillStyle = '#16a34a'; ctx.fillRect(2,2,12,14); ctx.fillStyle='#fff'; ctx.fillRect(3,4,10,2); });
    GFX.floor = c(16,16, ctx => { ctx.fillStyle = '#4a4a4a'; ctx.fillRect(0,0,16,16); ctx.fillStyle = '#404040'; ctx.fillRect(0,15,16,1); });
    GFX.wall = c(16,16, ctx => { ctx.fillStyle = '#3e2723'; ctx.fillRect(0,0,16,16); ctx.fillStyle = '#5d4037'; ctx.fillRect(0,6,16,10); });
    GFX.shelf = c(16,16, ctx => { ctx.fillStyle = '#f59e0b'; ctx.fillRect(2,0,2,16); ctx.fillRect(12,0,2,16); ctx.fillStyle = '#d97706'; ctx.fillRect(2,4,12,2); });
    GFX.book = c(8,8, ctx => { ctx.fillStyle = '#fff'; ctx.fillRect(0,0,8,8); ctx.fillStyle='green'; ctx.fillRect(2,2,4,4); });
    GFX.req = c(10,10, ctx => { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(5,0); ctx.lineTo(10,5); ctx.lineTo(5,10); ctx.lineTo(0,5); ctx.fill(); ctx.fillStyle='red'; ctx.font='8px sans'; ctx.fillText("!",3,8); });
    GFX.bossProj = c(12,12, ctx => { ctx.fillStyle = '#ff00ff'; ctx.beginPath(); ctx.arc(6,6,5,0,Math.PI*2); ctx.fill(); });
}

// --- GAME STATE ---
const GAME = {
    state: 'LOGO', 
    stateTimer: 0, 
    nextState: 'PLAY', 
    ticks: 0,
    player: null,
    selectedChar: "Carrie",
    charList: ["Carrie", "Nevena", "Joao", "Roman"],
    charIndex: 0,
    camera: { x: 0, y: 0 },
    map: [], clutter: [], entities: [], projectiles: [], particles: [], activeIssues: [],
    issuesFixed: 0, lives: 5, genId: 0, gameOverTriggered: false, simonHits: 0, boss: null,
    shake: 0, flash: 0, 
    
    dialogText: "",
    dialogVisible: "",
    dialogTimer: 0,
    
    // STATS
    startTime: 0,
    booksFired: 0,
    opsPushed: 0,

    bossTypes: [
        { name: "Labour Inspector", sprite: "boss_manager", hp: 10, speed: 1.2, attackDelay: 50, title: "The Enforcer", desc: "Checks every corner.", attackName: "Citation Storm" },
        { name: "Compliance Auditor", sprite: "boss_manager", hp: 12, speed: 0.8, attackDelay: 70, title: "The Watcher", desc: "Nothing escapes.", attackName: "Audit Trail" },
        { name: "Jelena \"Jelly\"", sprite: "boss_hr", hp: 13, speed: 0.9, attackDelay: 65, title: "HR Visitor", desc: "Spreads policy and paperwork with a smile.", attackName: "Wellness Check" },
        { name: "Sebastian Sprigade", sprite: "boss_sebastian", hp: 15, speed: 1.0, attackDelay: 60, title: "Delivery Station Mgr", desc: "Obsessed with TPH.", attackName: "Volume Spike" },
        { name: "Senior Regional Mgr", sprite: "boss_manager", hp: 14, speed: 0.6, attackDelay: 90, title: "The Executive", desc: "Metrics first.", attackName: "Budget Cut" },
        { name: "Avetta Platform", sprite: "boss_avetta", hp: 18, speed: 0.4, attackDelay: 100, title: "Risk Mgmt AI", desc: "Judges all.", attackName: "Compliance Block" }
    ]
};

const SAFETY_ISSUES = [
    { name: "Chem Spill", type: "spill" }, { name: "Bad Pallet", type: "box" }, { name: "Trash", type: "box" }, 
    { name: "Cable Trip", type: "spill" }, { name: "Broken Glass", type: "spill" }, { name: "Unlabeled Chem", type: "drum" },
    { name: "Pallet Debris", type: "debris" }, { name: "Unstable Stack", type: "tall_pallet" }, { name: "Blocked Extinguisher", type: "box" }
];

// --- INPUT ---
const KEYS = { up: false, down: false, left: false, right: false, action: false };
window.addEventListener('keydown', e => {
    if(e.key==='w'||e.key==='ArrowUp') KEYS.up=true;
    if(e.key==='s'||e.key==='ArrowDown') KEYS.down=true;
    if(e.key==='a'||e.key==='ArrowLeft') KEYS.left=true;
    if(e.key==='d'||e.key==='ArrowRight') KEYS.right=true;
    if(e.code==='Space') { if(!KEYS.action) handleAction(); KEYS.action=true; }
});
window.addEventListener('keyup', e => {
    if(e.key==='w'||e.key==='ArrowUp') KEYS.up=false;
    if(e.key==='s'||e.key==='ArrowDown') KEYS.down=false;
    if(e.key==='a'||e.key==='ArrowLeft') KEYS.left=false;
    if(e.key==='d'||e.key==='ArrowRight') KEYS.right=false;
    if(e.code==='Space') KEYS.action=false;
});

function handleAction() {
    // Ensure Audio is active on first interaction
    AudioSys.init();
    AudioSys.resume();
    MusicSys.init();
    MusicSys.resume();
    updateMusicForState();

    // Intro Logic: ONLY Logo advances automatically. Others need space.
    if (GAME.state === 'LOGO') { advanceState(); }
    else if (['INTRO', 'STORY'].includes(GAME.state)) { AudioSys.sfx.start(); advanceState(); }
    else if (['TITLE', 'HOWTO'].includes(GAME.state)) { 
        GAME.state = (GAME.state==='TITLE')?'HOWTO':'SELECT'; 
        AudioSys.sfx.select(); 
        updateMusicForState();
    }
    else if (GAME.state === 'SELECT') { 
        AudioSys.sfx.select(); GAME.selectedChar = GAME.charList[GAME.charIndex]; resetGame(); 
    }
    else if (GAME.state === 'DIALOG') {
        // Fast forward text or close
        if (GAME.dialogVisible.length < GAME.dialogText.length) {
            GAME.dialogVisible = GAME.dialogText;
            document.getElementById('text-content').innerText = GAME.dialogVisible; // Sync DOM
        } else {
            closeDialog();
        }
    }
    else if (GAME.state === 'BOSS_INTRO') {
        GAME.state = 'BOSS';
        GAME.nextState = 'BOSS'; // FIX: Explicitly set next state to BOSS
        updateMusicForState();
    }
    else if (GAME.state === 'GAMEOVER' || GAME.state === 'WIN') { 
        document.getElementById('boss-hud').style.display = 'none';
        document.getElementById('slogan-display').style.display = 'none';
        GAME.state = 'TITLE'; 
        updateMusicForState();
    }
    else if (GAME.state === 'PLAY' || GAME.state === 'BOSS') {
        if (GAME.state === 'PLAY' && tryInteract()) return;
        throwBook();
    }
}

function init() {
    generateAssets();
    GAME.state = 'LOGO';
    updateMusicForState();
    requestAnimationFrame(loop);
}

function advanceState() {
    GAME.stateTimer = 0;
    if (GAME.state === 'LOGO') GAME.state = 'INTRO';
    else if (GAME.state === 'INTRO') GAME.state = 'STORY';
    else if (GAME.state === 'STORY') GAME.state = 'TITLE';
    else if (GAME.state === 'TITLE') GAME.state = 'HOWTO'; 
    updateMusicForState();
}

function resetGame() {
    GAME.state = 'PLAY';
    GAME.genId++;
    GAME.gameOverTriggered = false;
    GAME.player = { x: 100, y: 100, dir: 0, speed: 1.5, iframe: 0, cooldown: 0 };
    GAME.entities = []; GAME.projectiles = []; GAME.particles = [];
    GAME.activeIssues = []; GAME.clutter = [];
    GAME.issuesFixed = 0; GAME.lives = 5; GAME.simonHits = 0; GAME.boss = null;
    GAME.nextState = 'PLAY'; 
    
    // Stats Reset
    GAME.startTime = Date.now();
    GAME.booksFired = 0;
    GAME.opsPushed = 0;
    
    generateMap();
    GAME.entities.push({ type: 'simon', x: 100, y: 80, w: 16, h: 16 });
    document.getElementById('hud-layer').style.display = 'block';
    document.getElementById('boss-hud').style.display = 'none';
    
    const sloganEl = document.getElementById('slogan-display');
    sloganEl.style.display = 'block';
    sloganEl.innerText = "✨ SAFETY SYSTEM LOADING...";
    
    callGemini("You are Simon Unglaube, WHS Manager. Write a short, dark, dry, cynical corporate safety slogan for the start of the shift. ALL CAPS. Max 6 words.", "slogans").then(text => {
        if (GAME.state === 'PLAY') sloganEl.innerText = "✨ " + text;
    });

    showDialog(`Coordinator ${GAME.selectedChar}! Hazards detected!\nFind 5 Hazards immediately!`, "Simon Unglaube", GFX.simonFace, false);
    updateMusicForState();
}

function generateMap() {
    GAME.map = [];
    for(let y=0; y<MAP_H; y++) {
        GAME.map[y] = [];
        for(let x=0; x<MAP_W; x++) {
            if (x===0 || x===MAP_W-1 || y===0 || y===MAP_H-1) GAME.map[y][x] = 1;
            else if (x > 5 && x < 55 && y % 5 === 0 && x % 3 !== 0) GAME.map[y][x] = 2;
            else {
                GAME.map[y][x] = 0;
                if (Math.random() < 0.05) {
                    const type = ['coffee','paper','tape'][Math.floor(Math.random()*3)];
                    GAME.clutter.push({x: x*TILE_SIZE + 4, y: y*TILE_SIZE + 4, type: type});
                }
            }
        }
    }
    
    // Clear Central Arena for Boss (Fix for boss projectiles hitting walls instantly)
    for(let y=15; y<25; y++) {
        for(let x=25; x<35; x++) {
            GAME.map[y][x] = 0;
        }
    }

    let dx = 30, dy = 0; GAME.map[dy][dx] = 3; 
    GAME.activeIssues.push({ x: dx*TILE_SIZE, y: (dy+1)*TILE_SIZE, data: {name: "Blocked Exit", type: "box"}, fixed: false });

    spawnEntity('runner'); spawnEntity('runner');

    let count = 0;
    while(count < 3) { 
        let tx = Math.floor(Math.random()*(MAP_W-2))+1; let ty = Math.floor(Math.random()*(MAP_H-2))+1;
        if (GAME.map[ty][tx] === 0) {
            let rHazard = SAFETY_ISSUES[Math.floor(Math.random() * SAFETY_ISSUES.length)];
            GAME.activeIssues.push({ x:tx*TILE_SIZE, y:ty*TILE_SIZE, data: rHazard, fixed:false });
            count++;
        }
    }
    for(let i=0; i<8; i++) spawnEntity('ops');
    for(let i=0; i<10; i++) spawnEntity('assoc');
}

function spawnEntity(type) {
    let tx, ty;
    do { tx = Math.floor(Math.random()*(MAP_W-2))+1; ty = Math.floor(Math.random()*(MAP_H-2))+1; } while(GAME.map[ty][tx]!==0);
    GAME.entities.push({ type:type, x:tx*TILE_SIZE, y:ty*TILE_SIZE, dir:0, timer:0 });
}

function initSimonBoss() {
    GAME.state = 'BOSS_INTRO';
    AudioSys.sfx.bossIntro();
    GAME.boss = {
        name: "SIMON UNGLAUBE",
        sprite: "simonBoss",
        hp: 25, 
        speed: 1.5, 
        attackDelay: 30, 
        title: "THE WHS FINAL BOSS",
        desc: "He has seen your file. He is not impressed.",
        attackName: "TERMINATION PROTOCOL",
        tauntsTriggered: [],
        tauntThresholds: [0.75, 0.5, 0.25],
        maxHp: 25,
        x: MAP_W * TILE_SIZE / 2, 
        y: MAP_H * TILE_SIZE / 2,
        timer: 0 // FIX: Init timer
    };
    
    // Clear old stuff
    GAME.entities = [];
    GAME.projectiles = [];
    updateMusicForState();
}

function initBossEncounter() {
    GAME.state = 'BOSS_INTRO';
    AudioSys.sfx.bossIntro(); 
    const bossData = GAME.bossTypes[Math.floor(Math.random() * GAME.bossTypes.length)];
    GAME.boss = { 
        ...bossData, 
        x: MAP_W * TILE_SIZE / 2, 
        y: MAP_H * TILE_SIZE / 2, 
        w: 32, h: 32, 
        maxHp: bossData.hp, 
        timer: 0,
        tauntsTriggered: [],
        tauntThresholds: [0.75, 0.5, 0.25]
    };
    GAME.entities = []; GAME.projectiles = [];
    updateMusicForState();
}

function update() {
    GAME.ticks++;
    GAME.stateTimer++;
    
    if (GAME.shake > 0) GAME.shake--;
    if (GAME.flash > 0) GAME.flash--;

    // Auto-Advance ONLY for Logo
    if (GAME.state === 'LOGO' && GAME.stateTimer > 240) advanceState();
    
    if (GAME.state === 'SELECT') {
        if (KEYS.left && GAME.ticks % 10 === 0) { GAME.charIndex--; AudioSys.sfx.step(); }
        if (KEYS.right && GAME.ticks % 10 === 0) { GAME.charIndex++; AudioSys.sfx.step(); }
        if (GAME.charIndex < 0) GAME.charIndex = GAME.charList.length - 1;
        if (GAME.charIndex >= GAME.charList.length) GAME.charIndex = 0;
        return;
    }

    if (GAME.state === 'DIALOG') {
        if (GAME.dialogVisible.length < GAME.dialogText.length) {
            if (GAME.ticks % 2 === 0) { // Typing speed
                GAME.dialogVisible += GAME.dialogText[GAME.dialogVisible.length];
                document.getElementById('text-content').innerText = GAME.dialogVisible; // Sync DOM
                AudioSys.sfx.text();
            }
        }
        return; // Pause game
    }

    if (['LOGO', 'INTRO', 'STORY', 'TITLE', 'HOWTO', 'BOSS_INTRO'].includes(GAME.state)) return;

    if (GAME.state === 'PLAY' || GAME.state === 'BOSS') {
        updatePlayer();
        updateProjectiles();
        updateParticles();
        updateCamera();
    }

    if (GAME.state === 'PLAY') updateEntities();
    if (GAME.state === 'BOSS') updateBoss();
}

function updatePlayer() {
    const p = GAME.player;
    if (p.iframe>0) p.iframe--;
    if (p.cooldown>0) p.cooldown--;
    
    let dx=0, dy=0;
    if (KEYS.up) dy = -p.speed;
    if (KEYS.down) dy = p.speed;
    if (KEYS.left) dx = -p.speed;
    if (KEYS.right) dx = p.speed;
    if (dx!==0 && dy!==0) { dx *= 0.707; dy *= 0.707; }
    if (dx!==0 || dy!==0) {
        if (!checkCol(p.x+dx, p.y)) p.x+=dx;
        if (!checkCol(p.x, p.y+dy)) p.y+=dy;
        if (GAME.ticks % 20 === 0) { AudioSys.sfx.step(); spawnParticle(p.x+8, p.y+16, '#555', 0); }
    }
}

function updateEntities() {
    GAME.entities.forEach(e => {
        if (e.type === 'simon') return;
        if (e.type === 'ops') {
            let d = Math.hypot(GAME.player.x - e.x, GAME.player.y - e.y);
            if (d < 100) {
                if (GAME.player.x > e.x) e.x += 0.4; else e.x -= 0.4;
                if (GAME.player.y > e.y) e.y += 0.4; else e.y -= 0.4;
            }
            if (d < 80 && Math.random() < 0.01) {
                let angle = Math.atan2(GAME.player.y - e.y, GAME.player.x - e.x);
                GAME.projectiles.push({ type: 'req', x: e.x, y: e.y, vx: Math.cos(angle)*2, vy: Math.sin(angle)*2, life: 80 });
                AudioSys.sfx.alert();
            }
        }
        if (e.type === 'assoc') {
            if (Math.random() < 0.02) e.dir = Math.floor(Math.random()*4);
            let s = 0.3;
            if (e.dir===0) e.y-=s; else if(e.dir===1) e.y+=s; else if(e.dir===2) e.x-=s; else e.x+=s;
        }
        if (e.type === 'runner') {
            if (Math.random() < 0.05) e.dir = Math.floor(Math.random()*4);
            let s = 0.8; 
            let nx = e.x, ny = e.y;
            if (e.dir===0) ny-=s; else if(e.dir===1) ny+=s; else if(e.dir===2) nx-=s; else nx+=s;
            if (!checkCol(nx, ny)) { e.x = nx; e.y = ny; }
            else e.dir = Math.floor(Math.random()*4); 
        }
    });
}

function updateBoss() {
    const b = GAME.boss;
    const p = GAME.player;
    
    document.getElementById('boss-hud').style.display = 'block';
    document.getElementById('boss-name-el').innerText = b.name;
    updateBossHud();

    // Dynamic Taunt Logic
    let hpPct = b.hp / b.maxHp;
    if (b.tauntThresholds.length > 0 && hpPct < b.tauntThresholds[0]) {
         b.tauntThresholds.shift(); 
         const currentGen = GAME.genId;
         // Custom prompt for Simon vs others
         let prompt = b.name === "SIMON UNGLAUBE" ? 
             "You are Simon Unglaube, turning into a super boss. Threaten the player with termination and entropy. Max 6 words." :
             `Generate a 5-word taunt from a video game boss named ${b.name}. Warehouse themed.`;

        callGemini(prompt, "taunt").then(text => {
            if (GAME.state === 'BOSS' && GAME.genId === currentGen) {
                 // Pause game for taunt
                 showDialog(text, b.name, b.name === "SIMON UNGLAUBE" ? GFX.simonBoss : GFX.boss_manager, true);
            }
        });
    }

    // FIX: Check if b.x and b.y are valid
    if (isNaN(b.x) || isNaN(b.y)) return;

    // Collision check for Boss to prevent wall clipping
    let dx = 0, dy = 0;
    let dist = Math.hypot(p.x - b.x, p.y - b.y);
    
    if (dist > 50) {
        let angle = Math.atan2(p.y - b.y, p.x - b.x);
        dx = Math.cos(angle) * b.speed;
        dy = Math.sin(angle) * b.speed;
        
        // Wall Collision Check for Boss
        if (!checkCol(b.x + dx, b.y)) b.x += dx;
        if (!checkCol(b.x, b.y + dy)) b.y += dy;
    }

    b.timer++;
    if (b.timer > b.attackDelay) {
        b.timer = 0;
        for (let i = -1; i <= 1; i++) {
            let angle = Math.atan2(p.y - b.y, p.x - b.x) + (i * 0.3);
            // Spawn projectile slightly offset to avoid instant self-collision if near wall
            GAME.projectiles.push({ 
                type: 'req', 
                x: b.x + 16 + Math.cos(angle)*10, 
                y: b.y + 16 + Math.sin(angle)*10, 
                vx: Math.cos(angle)*2.5, 
                vy: Math.sin(angle)*2.5, 
                life: 100, 
                boss: true,
                grace: 10 // Ignore walls for 10 frames
            });
        }
        AudioSys.sfx.alert();
        GAME.shake = 5; 
    }
}

function updateProjectiles() {
    for(let i=GAME.projectiles.length-1; i>=0; i--) {
        let p = GAME.projectiles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.grace > 0) p.grace--; // Decrement grace period
        
        // Only check wall collision if grace period is over
        if (p.grace <= 0 && checkCol(p.x, p.y)) { GAME.projectiles.splice(i,1); continue; }
        
        if (p.life <= 0) { GAME.projectiles.splice(i,1); continue; }
        
        // Player Hit
        if ((p.type === 'req') && Math.hypot(p.x-GAME.player.x, p.y-GAME.player.y) < 10) {
            if (GAME.player.iframe<=0) {
                GAME.lives--;
                GAME.player.iframe = 120; 
                GAME.shake = 10; // Violent Shake
                GAME.flash = 10; // Flash
                AudioSys.sfx.hurt();
                updateHud();
                if (GAME.lives<=0 && !GAME.gameOverTriggered) { 
                    triggerGameOver("OVERWHELMED!");
                }
            }
            GAME.projectiles.splice(i,1);
        }

        // Boss Hit
        if (p.type === 'book' && GAME.state === 'BOSS' && GAME.boss) {
             if (Math.hypot(p.x - (GAME.boss.x+16), p.y - (GAME.boss.y+16)) < 24) {
                 GAME.boss.hp--;
                 updateBossHud();
                 AudioSys.sfx.bossHit();
                 GAME.shake = 5;
                 spawnParticle(p.x, p.y, '#ff0000', -2);
                 GAME.projectiles.splice(i,1);
                 if (GAME.boss.hp <= 0) winGame();
                 continue;
             }
        }

        // Ops/Simon Hit
        if (p.type === 'book' && GAME.state === 'PLAY') {
            let simon = GAME.entities.find(e => e.type === 'simon');
            if (simon && Math.hypot(p.x-simon.x, p.y-simon.y) < 12) {
                 GAME.simonHits++;
                 AudioSys.sfx.angry();
                 GAME.projectiles.splice(i,1);
                 if (GAME.simonHits === 1) showDialog("Hey! Watch it! I write your paycheck.", "Simon Unglaube", GFX.simonFace);
                 else if (GAME.simonHits === 2) showDialog("Strike two. Do not test my patience.", "Simon Unglaube", GFX.simonFace);
                 else if (GAME.simonHits >= 3) initSimonBoss(); // TRIGGER SUPER SIMON BOSS
                 continue;
            }

            let hit = false;
            GAME.entities.forEach(e => {
                if (e.type === 'ops' && Math.hypot(p.x-e.x, p.y-e.y) < 12) {
                    e.type = 'assoc';
                    AudioSys.sfx.hit();
                    spawnParticle(e.x, e.y, '#fff', -2);
                    GAME.opsPushed++; // Stat

                    const opsBannerEl = document.getElementById('slogan-display');
                    const bannerVisible = opsBannerEl && opsBannerEl.style.display !== 'none';
                    const banterChance = bannerVisible ? 0.2 : 0.1;
                    if (opsBannerEl && Math.random() < banterChance) {
                        const currentGen = GAME.genId;
                        callGemini("Generate snarky OPS banter after being pushed back. Max 12 words. Keep it dramatic.", "banter").then(line => {
                            if (GAME.state === 'PLAY' && GAME.genId === currentGen) {
                                opsBannerEl.innerText = "OPS: " + line;
                            }
                        });
                    }

                    hit = true;
                }
            });
            if (hit) GAME.projectiles.splice(i,1);
        }
    }
}

function updateParticles() {
    for(let i=GAME.particles.length-1; i>=0; i--) {
        let p = GAME.particles[i];
        p.life--;
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2; // Gravity
        
        // Bounce Floor (Mock floor at p.y original + 5)
        if (p.y > p.groundY) {
            p.y = p.groundY;
            p.vy *= -0.6; // Bounce
        }
        
        if (p.life <= 0) GAME.particles.splice(i,1);
    }
}

function spawnParticle(x, y, color, forceY = 0) { 
    // Spawn debris with physics
    GAME.particles.push({
        x:x, y:y, color:color, life:40, 
        vx: (Math.random() - 0.5) * 2,
        vy: forceY || (Math.random() * -2),
        groundY: y + 5
    }); 
}

function throwBook() {
    const p = GAME.player;
    if (p.cooldown > 0) return;
    p.cooldown = 120; 
    GAME.booksFired++; // Stat

    let vx=0, vy=0;
    if (GAME.state === 'BOSS' && GAME.boss) {
        let angle = Math.atan2((GAME.boss.y+16) - p.y, (GAME.boss.x+16) - p.x);
        vx = Math.cos(angle) * 4; vy = Math.sin(angle) * 4;
    } else {
        let target = null; let minDist = 200;
        GAME.entities.forEach(e => {
            if (e.type === 'ops') {
                let d = Math.hypot(e.x - p.x, e.y - p.y);
                if (d < minDist) { minDist = d; target = e; }
            }
        });
        if (target) {
            let angle = Math.atan2(target.y - p.y, target.x - p.x);
            vx = Math.cos(angle) * 4; vy = Math.sin(angle) * 4;
        } else {
            if (KEYS.up) vy=-4; else if (KEYS.down) vy=4; else if (KEYS.left) vx=-4; else vx=4;
        }
    }
    GAME.projectiles.push({ type:'book', x:p.x+8, y:p.y+8, vx, vy, life:40 });
    AudioSys.sfx.throw();
}

function tryInteract() {
    const p = GAME.player;
    for (let i=0; i<GAME.entities.length; i++) {
        let e = GAME.entities[i];
        if (e.type === 'runner' && Math.hypot(p.x-e.x, p.y-e.y) < 20) {
             e.type = 'assoc'; 
             GAME.issuesFixed++; updateHud(); AudioSys.sfx.fix();
             if (GAME.issuesFixed >= 5) { initBossEncounter(); } 
             else {
                 showDialog("✨ Analyzing Runner...", "System", null, true);
                 const currentGen = GAME.genId;
                 callGemini("You are Simon Unglaube, WHS Manager. You just caught someone running. Scold them with dry humor. Mention physics or forms. Max 20 words.", "runners").then(tip => {
                    if (GAME.state === 'DIALOG' && GAME.genId === currentGen) showDialog(`Fixed: Runner!\n${tip}`, "Simon Unglaube", GFX.simonFace, true);
                 });
             }
             return true;
        }
    }
    for(let h of GAME.activeIssues) {
        if (!h.fixed && Math.hypot(p.x-h.x, p.y-h.y) < 20) {
            h.fixed = true;
            GAME.issuesFixed++; updateHud(); AudioSys.sfx.fix();
            if (GAME.issuesFixed >= 5) { initBossEncounter(); } 
            else {
                showDialog(`✨ Analyzing ${h.data.name}...`, "System", null, true);
                const currentGen = GAME.genId;
                callGemini(`You are Simon Unglaube. A coordinator fixed a "${h.data.name}". Give a dry, witty safety compliment. Mention avoiding lawsuits, physics, or paperwork. Max 20 words.`, "hazard", { hazardName: h.data.name }).then(tip => {
                    if (GAME.state === 'DIALOG' && GAME.genId === currentGen) showDialog(`Fixed: ${h.data.name}!\n${tip}`, "Simon Unglaube", GFX.simonFace, true);
                });
            }
            return true;
        }
    }
    return false;
}

function triggerGameOver(reason) {
    GAME.gameOverTriggered = true;
    GAME.nextState = 'TITLE';
    document.getElementById('boss-hud').style.display = 'none';
    
    const time = Math.floor((Date.now() - GAME.startTime)/1000);
    
    if (reason === "FIRED!") {
        showDialog("YOU ARE FIRED!\nSimon has had enough of your unsafe behavior.\n\n(Press Space)", "HR", null, false);
    } else {
        showDialog("OVERWHELMED!\nSimon is writing up your review...", "Simon Unglaube", GFX.simonFace, false);
        const currentGen = GAME.genId;
        const prompt = `You are Simon Unglaube. Write a detailed performance review (max 50 words) for a coordinator who failed after ${time}s, threw ${GAME.booksFired} books, and pushed back ${GAME.opsPushed} Ops. Tone: Dark, cynical, disappointed father.`;
        
        callGemini(prompt, "reviews_loss").then(review => {
             if (GAME.state === 'DIALOG' && GAME.genId === currentGen) {
                 showDialog(`AUDIT FAILED\n\n"${review}"\n\nStats:\nTime: ${time}s\nBooks: ${GAME.booksFired}\nOps: ${GAME.opsPushed}\n(Press Space)`, "Simon Unglaube", GFX.simonFace, true);
             }
        });
    }
}

function winGame() {
    AudioSys.sfx.start();
    GAME.nextState = 'TITLE';
    document.getElementById('boss-hud').style.display = 'none';
    showDialog("BOSS DEFEATED!\nCalculating Safety Score...", "System", null, true);
    const currentGen = GAME.genId;
    const time = Math.floor((Date.now() - GAME.startTime)/1000);
    const prompt = `You are Simon Unglaube. Write a detailed performance review (max 50 words) for a coordinator who survived ${time}s, threw ${GAME.booksFired} safety books, and pushed back ${GAME.opsPushed} Ops managers. Tone: Proud but dark and bureaucratic.`;

    callGemini(prompt, "reviews_win").then(praise => {
        if (GAME.state === 'DIALOG' && GAME.genId === currentGen) showDialog(`OUTSTANDING!\n"${praise}"\n\nStats:\nTime: ${time}s\nBooks: ${GAME.booksFired}\nOps: ${GAME.opsPushed}\n(Press Space)`, "Simon Unglaube", GFX.simonFace, true);
    });
}

function updateBossHud() {
    if(GAME.boss) {
        const pct = Math.max(0, (GAME.boss.hp / GAME.boss.maxHp) * 100);
        document.getElementById('boss-health-el').style.width = pct + '%';
    }
}

function checkCol(x, y) {
    let tx = Math.floor((x+8)/TILE_SIZE);
    let ty = Math.floor((y+8)/TILE_SIZE);
    if (tx<0||tx>=MAP_W||ty<0||ty>=MAP_H) return true;
    return GAME.map[ty][tx] !== 0;
}

// --- RENDER ---
function draw() {
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);

    // Shake Effect
    let dxShake = 0, dyShake = 0;
    if (GAME.shake > 0) {
        dxShake = (Math.random() - 0.5) * GAME.shake;
        dyShake = (Math.random() - 0.5) * GAME.shake;
    }
    
    ctx.save();
    ctx.translate(dxShake, dyShake);

    if (GAME.state === 'LOGO') { 
        let alpha = 1.0;
        if(GAME.stateTimer < 30) alpha = GAME.stateTimer / 30;
        if(GAME.stateTimer > 200) alpha = (240 - GAME.stateTimer) / 40;
        ctx.globalAlpha = Math.max(0, Math.min(1, alpha));
        let offset = Math.max(0, 100 - GAME.stateTimer * 2);
        ctx.drawImage(GFX.logo, 28 - offset, 90);
        if (GAME.stateTimer > 80) {
            ctx.fillStyle = '#fff'; ctx.font = '10px monospace'; ctx.fillText("ERWIN ESENER", 80, 105);
            ctx.fillStyle = '#eab308'; ctx.font = '14px monospace'; ctx.fillText("PRODUCTIONS", 80, 125);
        }
        if(GAME.stateTimer > 60 && GAME.stateTimer < 65) { ctx.fillStyle='white'; ctx.fillRect(0,0,256,224); }
        ctx.restore();
        return; 
    }
    
    if (GAME.state === 'INTRO') { 
        ctx.fillStyle='#eab308'; ctx.fillText("THE WAREHOUSE...", 20, 60); 
        ctx.fillStyle='#fff';
        ctx.fillText("Ops Managers obsess over rates.", 20, 90);
        ctx.fillText("They throw Crazy Requests.", 20, 110);
        ctx.fillText("You must protect Safety.", 20, 130);
        ctx.fillText("Stop runners. Fix hazards.", 20, 150);
        ctx.fillStyle='#888'; ctx.fillText("[SPACE TO SKIP]", 80, 200);
        ctx.restore();
        return; 
    }
    
    if (GAME.state === 'STORY') {
        ctx.fillStyle='#eab308'; ctx.font='10px monospace'; 
        ctx.fillText("MISSION BRIEFING", 20, 40);
        ctx.fillStyle='#fff';
        ctx.fillText("Simon Unglaube asks you to:", 20, 70);
        ctx.fillText("- Do the safety audit", 20, 90);
        ctx.fillText("- Dodge crazy Ops requests", 20, 110);
        ctx.fillText("- Push back with rules", 20, 130);
        ctx.fillText("- Deal with 'visitors'", 20, 150);
        ctx.fillStyle='#888'; ctx.fillText("[PRESS SPACE]", 80, 200);
        ctx.restore();
        return;
    }
    
    if (GAME.state === 'TITLE') {
        // SCROLLING GRID
        let offset = (Date.now() / 20) % 256;
        ctx.strokeStyle = '#004400'; ctx.lineWidth = 1;
        for(let i=0; i<20; i++) {
            ctx.beginPath(); ctx.moveTo(0, i*20 + (offset%20)); ctx.lineTo(256, i*20 + (offset%20)); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(i*20, 0); ctx.lineTo(i*20, 224); ctx.stroke();
        }
        
        ctx.fillStyle='#eab308'; ctx.font='20px monospace'; ctx.fillText("AMZL WHS QUEST", 40, 60); 
        ctx.font='10px monospace'; ctx.fillStyle='#fff'; ctx.fillText("PRESS SPACE TO START", 60, 120); 
        ctx.fillStyle='#888'; ctx.fillText("Code by Erwin", 85, 200); 
        ctx.restore();
        return; 
    }
    
    if (GAME.state === 'HOWTO') {
        ctx.fillStyle='#fff'; ctx.font='12px monospace';
        ctx.fillText("HOW TO PLAY", 80, 30);
        ctx.font='10px monospace';
        ctx.fillStyle='#eab308'; ctx.fillText("WASD / ARROWS : MOVE", 20, 60);
        ctx.fillStyle='#aaa'; ctx.fillText("Navigate the warehouse.", 20, 75);
        ctx.fillStyle='#eab308'; ctx.fillText("SPACE : INTERACT / SHOOT", 20, 100);
        ctx.fillStyle='#aaa'; ctx.fillText("Fix hazards or throw rules.", 20, 115);
        ctx.fillStyle='#eab308'; ctx.fillText("GOAL: FIND 5 HAZARDS", 20, 140);
        ctx.fillStyle='#aaa'; ctx.fillText("Then defeat the boss!", 20, 155);
        ctx.fillStyle='#fff'; ctx.fillText("[PRESS SPACE]", 80, 190);
        ctx.restore();
        return;
    }

    if (GAME.state === 'SELECT') {
        ctx.fillStyle = '#0a0a0a'; ctx.fillRect(12, 20, 232, 50);
        ctx.fillStyle = '#111'; ctx.fillRect(12, 80, 232, 120);

        ctx.fillStyle='#eab308'; ctx.font='12px monospace'; ctx.fillText("CHOOSE COORDINATOR", 40, 50);
        ctx.fillStyle='#888'; ctx.font='8px monospace'; ctx.fillText("ARROWS TO BROWSE | SPACE TO START", 26, 64);

        let name = GAME.charList[GAME.charIndex];
        let data = CHAR_DATA[name];

        ctx.save();
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(GFX.chars[name], 34, 104, 48, 48);
        ctx.restore();

        ctx.fillStyle='#eab308'; ctx.font='12px monospace'; ctx.fillText("< " + name + " >", 100, 108);
        ctx.font='8px monospace';
        ctx.fillStyle='#00ffff'; ctx.fillText("ROLE: " + data.role, 100, 124);

        const wrapText = (text, maxChars = 28) => {
            const words = text.split(' ');
            const lines = [];
            let line = '';
            words.forEach(word => {
                const candidate = line.length ? line + ' ' + word : word;
                if (candidate.length > maxChars) {
                    lines.push(line);
                    line = word;
                } else {
                    line = candidate;
                }
            });
            if (line) lines.push(line);
            return lines;
        };

        const backstoryLines = wrapText(data.backstory, 32).slice(0, 3);
        ctx.fillStyle='#fff';
        backstoryLines.forEach((l, idx) => ctx.fillText(l, 24, 150 + idx * 12));

        ctx.fillStyle='#ff00ff'; ctx.fillText("ATTACK: " + data.attack, 24, 192);

        ctx.fillStyle='#888'; ctx.font='10px monospace'; ctx.fillText("PRESS SPACE", 92, 210);
        ctx.restore();
        return;
    }

    // BOSS INTRO CUTSCENE
    if (GAME.state === 'BOSS_INTRO' && GAME.boss) {
        ctx.fillStyle = '#222'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#eab308'; ctx.font = '16px monospace';
        ctx.fillText("WARNING", 80, 50);
        
        ctx.fillStyle = '#ff0000'; ctx.font = '12px monospace';
        ctx.fillText(GAME.boss.name.toUpperCase(), 20, 90);
        
        ctx.fillStyle = '#fff'; ctx.font = '8px monospace';
        ctx.fillText(GAME.boss.title, 20, 110);
        ctx.fillStyle = '#888';
        ctx.fillText(GAME.boss.desc, 20, 130);
        
        ctx.fillStyle = '#eab308'; ctx.fillText("ATTACK: " + GAME.boss.attackName, 20, 160);
        
        ctx.fillStyle = '#fff'; ctx.fillText("[PRESS SPACE TO FIGHT]", 50, 200);
        ctx.restore();
        return;
    }

    // GAMEPLAY DRAW
    const cx = Math.floor(GAME.camera.x);
    const cy = Math.floor(GAME.camera.y);

    let sx = Math.floor(cx/TILE_SIZE); let ex = sx + 17;
    let sy = Math.floor(cy/TILE_SIZE); let ey = sy + 15;
    for(let y=sy; y<=ey; y++) {
        for(let x=sx; x<=ex; x++) {
            if(x>=0 && x<MAP_W && y>=0 && y<MAP_H) {
                let t = GAME.map[y][x];
                let dx = x*TILE_SIZE - cx; let dy = y*TILE_SIZE - cy;
                if (t===0) ctx.drawImage(GFX.floor, dx, dy);
                if (t===1) ctx.drawImage(GFX.wall, dx, dy);
                if (t===2) { ctx.drawImage(GFX.floor, dx, dy); ctx.drawImage(GFX.shelf, dx, dy); }
                if (t===3) { ctx.drawImage(GFX.wall, dx, dy); ctx.drawImage(GFX.door, dx, dy); }
            }
        }
    }

    GAME.clutter.forEach(c => { let img = GFX.clutter[c.type]; if(img) ctx.drawImage(img, c.x-cx, c.y-cy); });

    GAME.activeIssues.forEach(h => {
        if(!h.fixed) {
            let img = GFX.hazards[h.data.type] || GFX.hazards.box;
            ctx.drawImage(img, h.x-cx, h.y-cy);
        }
    });

    let renderList = [GAME.player, ...GAME.entities, ...GAME.projectiles];
    if (GAME.state === 'BOSS' && GAME.boss) renderList.push(GAME.boss);
    
    renderList.sort((a,b) => a.y - b.y);

    renderList.forEach(e => {
        let dx = Math.floor(e.x - cx);
        let dy = Math.floor(e.y - cy);
        
        if (e.maxHp) { // Boss
            let img = e.name === "SIMON UNGLAUBE" ? GFX.simonBoss : GFX.boss_manager;
            // Special check for specific bosses
            if (e.name.includes("Sebastian")) img = GFX.boss_sebastian;
            if (e.name.includes("Avetta")) img = GFX.boss_avetta;
            if (e.name.includes("Bot")) img = GFX.boss_bot;
            
            ctx.drawImage(img, dx, dy, 32, 32);
        } else {
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath(); ctx.ellipse(dx+8, dy+14, 6, 3, 0, 0, Math.PI*2); ctx.fill();

            if (e.type === 'simon') ctx.drawImage(GFX.simon, dx, dy);
            else if (e.type === 'ops') ctx.drawImage(GFX.ops, dx, dy);
            else if (e.type === 'assoc') ctx.drawImage(GFX.assoc, dx, dy);
            else if (e.type === 'runner') ctx.drawImage(GFX.runner, dx, dy);
            else if (e === GAME.player) {
                if (e.iframe%4 < 2) ctx.drawImage(GFX.chars[GAME.selectedChar], dx, dy);
                // Cooldown Bar
                if (e.cooldown > 0) {
                    ctx.fillStyle = '#555'; ctx.fillRect(dx, dy-4, 16, 2);
                    ctx.fillStyle = '#00ffff'; ctx.fillRect(dx, dy-4, 16 * (1 - e.cooldown/120), 2);
                } else {
                    ctx.fillStyle = '#00ff00'; ctx.fillRect(dx+6, dy-6, 4, 4); // Ready dot
                }
            }
            else if (e.type === 'book') ctx.drawImage(GFX.book, dx, dy);
            else if (e.type === 'req') {
                 if (e.boss) ctx.drawImage(GFX.bossProj, dx, dy);
                 else ctx.drawImage(GFX.req, dx, dy);
            }
        }
    });

    GAME.particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x-cx, p.y-cy, 2, 2); });

    // Flash Effect
    if (GAME.flash > 0) {
        ctx.globalAlpha = GAME.flash / 10;
        ctx.fillStyle = 'white'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.globalAlpha = 1.0;
    }
    
    ctx.restore();
}

function updateCamera() {
    GAME.camera.x = Math.max(0, Math.min(GAME.player.x - 120, MAP_W*TILE_SIZE - 256));
    GAME.camera.y = Math.max(0, Math.min(GAME.player.y - 100, MAP_H*TILE_SIZE - 224));
}

function updateHud() {
    document.getElementById('life-val').innerText = "❤️".repeat(Math.max(0, GAME.lives));
    document.getElementById('score-val').innerText = GAME.issuesFixed + "/5";
}

function showDialog(text, speaker, portrait, isAI = false) {
    GAME.state = 'DIALOG';
    GAME.dialogText = (speaker ? speaker + ":\n" : "") + text;
    GAME.dialogVisible = "";
    
    const box = document.getElementById('dialog-box');
    const badge = document.getElementById('gemini-badge');
    const port = document.getElementById('portrait');
    const pCtx = port.getContext('2d');
    
    box.style.display = 'flex';
    document.getElementById('text-content').innerText = ""; // Clear
    
    if (isAI) badge.style.display = 'block';
    else badge.style.display = 'none';
    
    pCtx.fillStyle = '#000'; pCtx.fillRect(0,0,32,32);
    if (portrait) pCtx.drawImage(portrait, 0, 0); 
    else { pCtx.fillStyle='#fff'; pCtx.fillText("!", 10, 20); }
    
    AudioSys.sfx.text();
}

function closeDialog() {
    AudioSys.sfx.step();
    document.getElementById('dialog-box').style.display = 'none';
    GAME.state = GAME.nextState;
    if (GAME.state === 'PLAY' && GAME.issuesFixed >= 5 && !GAME.boss) {
         // Redundant check to ensure we don't get stuck if logic fails
         initBossEncounter();
    }
    updateMusicForState();
}

function updateMusicForState() {
    if (['LOGO', 'INTRO', 'STORY', 'TITLE'].includes(GAME.state)) {
        MusicSys.play('title');
    } else if (['HOWTO', 'SELECT'].includes(GAME.state)) {
        MusicSys.play('menu');
    } else if (GAME.state === 'PLAY') {
        MusicSys.play('ingame');
    } else if (GAME.state === 'BOSS' || GAME.state === 'BOSS_INTRO') {
        MusicSys.play('boss');
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

init();
</script>
</body>
</html>
