<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMZL WHS Coordinator Quest</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root { --bg-color: #050505; }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
            font-family: 'Press Start 2P', monospace; color: white; user-select: none;
        }

        #game-wrapper {
            position: relative; width: 768px; height: 672px;
            background: #000; border: 20px solid #222; border-radius: 20px;
            box-shadow: 0 0 100px rgba(0,0,0,1); overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        #crt-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%; pointer-events: none; z-index: 900;
            animation: flicker 0.15s infinite;
        }

        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none; z-index: 901; border-radius: 10px;
        }

        @keyframes flicker { 0% { opacity: 0.95; } 100% { opacity: 1; } }

        #ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: flex-end; padding: 20px; box-sizing: border-box; z-index: 1000;
        }

        #dialog-box {
            width: 100%; min-height: 140px; background: #0000a0; 
            border: 4px solid #fff; border-radius: 8px; display: none;
            flex-direction: row; padding: 16px; box-sizing: border-box;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5); pointer-events: auto; 
        }

        #portrait {
            width: 64px; height: 64px; background: #000; border: 2px solid white;
            margin-right: 20px; flex-shrink: 0; image-rendering: pixelated;
        }

        #text-content {
            flex-grow: 1; font-size: 14px; line-height: 1.6; color: white;
            text-shadow: 2px 2px #000; white-space: pre-wrap;
        }

        #press-space-hint {
            font-size: 10px; color: #ffff00; margin-top: 10px;
            animation: blink 1s infinite; display: block;
        }
        
        .gemini-badge {
            font-size: 10px; color: #00ffff; margin-bottom: 8px; display: none;
            text-transform: uppercase; text-shadow: 0 0 5px #00ffff;
        }
        
        .loading-dots::after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }
        
        /* Banner hidden as requested */
        #slogan-display {
            display: none; 
        }
        
        @keyframes blink { 50% { opacity: 0; } }

        .hud-text {
            position: absolute; top: 20px; right: 20px; color: white;
            text-align: right; text-shadow: 2px 2px black; font-size: 12px;
            background: rgba(0,0,0,0.5); padding: 10px; border: 2px solid white;
        }
        
        #boss-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 60%; display: none;
        }
        
        .boss-bar-bg { width: 100%; height: 10px; background: #333; border: 2px solid white; }
        .boss-bar-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }
        .boss-name { color: #ff0000; text-align: center; font-size: 10px; margin-bottom: 4px; text-shadow: 1px 1px black; }
        
        #ai-status {
            display: none !important; 
            position: absolute; top: 10px; left: 10px; font-size: 10px; color: #00ffff;
            background: rgba(0,0,0,0.8); padding: 4px; border: 1px solid #00ffff; pointer-events: none;
            z-index: 2000; 
        }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="ai-status">AI Status: Init</div>
        <canvas id="gameCanvas" width="256" height="224"></canvas>
        <div id="crt-overlay"></div>
        <div id="vignette"></div>

        <div id="ui-overlay">
            <div id="slogan-display"></div>

            <div class="hud-text" id="hud-layer" style="display:none;">
                <div style="color:#ff4444; margin-bottom:5px;">LIFE <span id="life-val">❤️❤️❤️❤️❤️</span></div>
                <div style="color:#44ff44;">HAZARDS: <span id="score-val">0/5</span></div>
            </div>
        
            <div id="boss-hud">
                <div class="boss-name" id="boss-name-el">BOSS NAME</div>
                <div class="boss-bar-bg"><div class="boss-bar-fill" id="boss-health-el"></div></div>
            </div>

            <div id="dialog-box">
                <canvas id="portrait" width="32" height="32"></canvas>
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div id="gemini-badge" class="gemini-badge">✨ SIMON IS ANALYZING...</div>
                    <div id="text-content"></div>
                    <div id="press-space-hint">▼ PRESS SPACE</div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
// --- CONFIG ---
let apiKey = null;
let apiKeyPromise = null;
const MODEL_NAME = "gemini-2.0-flash-lite";

// --- BANTER DATA ---
const BANTER_DB = {
    ops: [
        "TPH is down!", "Walk faster!", "No talking!", "VTO?",
        "Scan scan scan!", "Where's your vest?", "Audit panic!",
        "My bonus!", "TOT!", "Bad rate!", "Let's go!",
        "Chase blue line!", "Less chatter!", "Time is rate!", "Trim that idle!",
        "Metrics don't nap!", "Pick it up!", "Stay in lanes!"
    ],
    assoc: [
        "My feet...", "Break time?", "Box heavy...", "Ugh...",
        "Safety shoes hurt", "Where's HR?", "Need coffee...",
        "Too early...", "Night shift...", "Pizza party?",
        "Belt keeps eating me", "Where's my badge?", "Snacks when?",
        "Scanner dying...", "Stuck in pack?", "Shift never ends"
    ]
};

// --- CHARACTER DATA ---
const CHAR_DATA = {
    "Carrie": {
        role: "The 5S Monk",
        backstory: "Precision hawk who spots crooked tape from 50 meters and breathes calm into chaotic clusters.",
        attack: "Label Maker Burst",
        speed: 1.5,
        lives: 5
    },
    "Nevena": {
        role: "The Oracle",
        backstory: "Safety oracle who predicts mishaps, carries emergency Palatschinken, and documents everything twice.",
        attack: "Clipboard Shockwave",
        speed: 1.5,
        lives: 5
    },
    "Joao": {
        role: "The Siren",
        backstory: "Espresso cannon whose warnings ring louder than the fire alarm and kick energy through the floor.",
        attack: "Sonic Shout",
        speed: 1.5,
        lives: 5
    },
    "Roman": {
        role: "The Ghost",
        backstory: "Bald audit phantom. Appears, fixes, vanishes. Hazards straighten themselves when he is near.",
        attack: "Stealth Audit",
        speed: 1.5,
        lives: 5
    },
    "Erwin": {
        role: "The Manager",
        backstory: "Rolls in with a kid-sized Tesla and slides into briefings faster than gossip spreads.",
        attack: "Tesla Energy Pulse",
        speed: 2.0,
        lives: 1
    }
};

const ATTACKS = {
    "Carrie": { name: "Label Maker Burst", sprite: "attack_carrie", speed: 4.2, cooldown: 110, color: "#a855f7", text: "Aligned!" },
    "Nevena": { name: "Clipboard Shockwave", sprite: "attack_nevena", speed: 4.0, cooldown: 120, color: "#0ea5e9", text: "Documented!" },
    "Joao": { name: "Sonic Shout", sprite: "attack_joao", speed: 4.6, cooldown: 105, color: "#f97316", text: "Heard!" },
    "Roman": { name: "Stealth Audit Pulse", sprite: "attack_roman", speed: 4.0, cooldown: 115, color: "#94a3b8", text: "Noted." },
    "Erwin": { name: "Tesla Drift", sprite: "attack_erwin", speed: 5.0, cooldown: 140, color: "#22d3ee", text: "Zapped!" },
    default: { name: "Rule Book", sprite: "book", speed: 4.0, cooldown: 120, color: "#00ffff", text: "Hit!" }
};

function getAttackData(name) {
    return ATTACKS[name] || ATTACKS.default;
}

function getCharStats(name) {
    const data = CHAR_DATA[name] || {};
    return {
        speed: data.speed ?? 1.5,
        lives: data.lives ?? 5
    };
}

// --- SIMULATED AI DATABASE (FALLBACKS) ---
const SIMULATED_AI = {
    tips: [
        "Blocked exit? That box is your tombstone. Move it.",
        "Chemical spill? Entropy leaking. Contain it before you dissolve.",
        "Debris? Chaos on the floor leads to chaos in the soul. Clean it.",
        "Trip hazard? Gravity does not care about your excuses.",
        "Unstable stack? Newton is rolling in his grave. Fix it.",
        "Fire equipment blocked? Do you plan to fight fire with optimism?"
    ],
    runners: [
        "Halt! Kinetic energy is not your friend. Slow down.",
        "You are not a photon. You have mass. Walk.",
        "Running? I've seen glaciers move with more purpose.",
        "We fight entropy, not the clock. Walk."
    ],
    taunts: [
        "My spreadsheet predicts your failure!",
        "You cannot audit the inevitable!",
        "I am the final regulation!",
        "Compliance dropping... Termination imminent!",
        "Resistance is a safety violation!"
    ],
    simon_taunts: [
        "I AM THE SAFETY STANDARD!",
        "YOU CANNOT ESCAPE THE AUDIT!",
        "ENTROPY COMES FOR US ALL!",
        "YOUR PPE IS INSUFFICIENT!"
    ],
    simon_warnings: [
        "First warning: Stop flinging manuals. Compliance is not a contact sport.",
        "Final warning: Holster the rule books or I escalate this audit into a boss fight."
    ],
    reviews_win: [
        "Performance: IMPROBABLE. You survived. I am... adequately pleased.",
        "You fought chaos and won. For today.",
        "Adequate. Nothing to write up. Feels strange."
    ],
    reviews_loss: [
        "Performance: CATASTROPHIC. Entropy won.",
        "You failed. Gravity and stupidity destroyed us.",
        "Safety is binary. You are a zero."
    ]
};

// --- AI STATUS HELPERS ---
const aiStatusEl = document.getElementById('ai-status');
let aiStatus = "init";

function setAIStatus(message, level = 'info') {
    aiStatus = level;
    console.log(`[AI STATUS ${level}]: ${message}`);
}

function personalizeAIText(text) {
    if (!text) return text;
    const name = (typeof GAME !== 'undefined' && GAME.selectedChar) ? GAME.selectedChar : 'Coordinator';
    const patterns = [
        /\[\s*player\s*name\s*\]/gi,
        /\{\s*player\s*name\s*\}/gi,
        /<\s*player\s*name\s*>/gi,
        /player name/gi,
        /\[\s*player\s*\]/gi,
        /\{\s*player\s*\}/gi,
        /<\s*player\s*>/gi
    ];
    let cleaned = text;
    patterns.forEach(p => { cleaned = cleaned.replace(p, name); });
    return cleaned;
}

async function fetchApiKeyFromNetlify() {
    try {
        const res = await fetch('/.netlify/functions/get-gemini-key', { cache: 'no-store' });
        if (!res.ok) throw new Error(`Netlify key endpoint returned ${res.status}`);
        const data = await res.json();
        const key = (data && data.apiKey ? String(data.apiKey) : '').trim();
        if (!key) throw new Error('No apiKey field in Netlify response');
        apiKey = key;
        return apiKey;
    } catch (err) {
        return null;
    }
}

async function ensureApiKey() {
    if (apiKey) return apiKey;
    if (!apiKeyPromise) apiKeyPromise = fetchApiKeyFromNetlify();
    return apiKeyPromise;
}

// --- GEMINI API ---
async function callGemini(prompt, category = 'generic', context = {}) {
    const activeKey = await ensureApiKey();
    if (!activeKey) {
        return personalizeAIText(getRandomFallback(prompt, category, context));
    }

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${activeKey}`;
    const payload = { 
        contents: [{ 
            parts: [{ text: prompt }] 
        }] 
    };
    const timeout = new Promise((r) => setTimeout(() => r("TIMEOUT"), 10000));

    try {
        const fetchPromise = fetch(url, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
        });
        const response = await Promise.race([fetchPromise, timeout]);
        
        if (response === "TIMEOUT") return personalizeAIText(getRandomFallback(prompt, category, context));
        if (!response.ok) return personalizeAIText(getRandomFallback(prompt, category, context));
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text) return personalizeAIText(text.trim());
        return personalizeAIText(getRandomFallback(prompt, category, context));

    } catch (e) {
        return personalizeAIText(getRandomFallback(prompt, category, context));
    }
}

function getRandomFallback(prompt, category = 'generic', context = {}) {
    const hazardName = context.hazardName;
    const stats = context.stats;
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const is = (key) => category === key || prompt.includes(key);

    if (is("runners")) return pick(SIMULATED_AI.runners);
    if (is("simon_warning")) {
        const warnings = SIMULATED_AI.simon_warnings || [];
        const idx = Math.min(context.warningIndex || 0, warnings.length - 1);
        return warnings.length ? warnings[Math.max(0, idx)] : pick(SIMULATED_AI.taunts);
    }
    if (is("taunt")) { 
         if(prompt.includes("Simon")) return pick(SIMULATED_AI.simon_taunts);
         return pick(SIMULATED_AI.taunts);
    }
    if ((is("reviews_loss") || is("reviews_win")) && stats) {
        const time = stats.time ?? "?";
        const hazards = stats.hazards ?? "?";
        const books = stats.books ?? "?";
        const ops = stats.ops ?? "?";
        if (is("reviews_loss")) {
            return `Audit recap: ${hazards}/5 hazards, ${books} rule books thrown, ${ops} ops nudged in ${time}s. Safety tip: hydrate, then try again.`;
        }
        return `Victory recap: ${hazards}/5 hazards cleared in ${time}s, ${books} rule books launched, ${ops} ops redirected. Celebrate, then keep exits clear.`;
    }
    if (is("reviews_loss")) return pick(SIMULATED_AI.reviews_loss);
    if (is("reviews_win")) return pick(SIMULATED_AI.reviews_win);
    if (is("hazard") || is("tips")) {
        if(hazardName) return `Hazard "${hazardName}" cleared. Paperwork avoided.`;
        return pick(SIMULATED_AI.tips);
    }
    if (is("banter_ops")) return pick(BANTER_DB.ops);
    if (is("banter_assoc")) return pick(BANTER_DB.assoc);

    return pick(SIMULATED_AI.tips);
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 16;
const MAP_W = 60;
const MAP_H = 40;

// --- TTS SYSTEM ---
const TTSSys = {
    synth: window.speechSynthesis,
    voice: null,
    init: function() {
        const loadVoices = () => {
            const voices = this.synth.getVoices();
            this.voice = voices.find(v => v.name.includes("Google US English")) || voices[0];
        };
        if (this.synth.onvoiceschanged !== undefined) this.synth.onvoiceschanged = loadVoices;
        loadVoices();
    },
    speak: function(text, speakerName = "System") {
        if (!this.synth || !text) return;
        this.synth.cancel(); 
        const utterance = new SpeechSynthesisUtterance(text);
        if (this.voice) utterance.voice = this.voice;
        
        if (speakerName.includes("Simon")) { utterance.pitch = 0.6; utterance.rate = 0.85; } 
        else if (["Carrie", "Nevena"].some(n => speakerName.includes(n))) { utterance.pitch = 1.2; }
        else { utterance.pitch = 0.9; }

        this.synth.speak(utterance);
    },
    cancel: function() { if (this.synth) this.synth.cancel(); }
};
TTSSys.init();


// --- AUDIO ---
const AudioSys = {
    ctx: null,
    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        if(!this.ctx) this.ctx = new AudioContext();
    },
    resume: function() { if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
    playTone: function(freq, type, duration, vol=0.1) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    playNoise: function(duration, vol=0.1) {
        if(!this.ctx) return;
        const bufferSize = this.ctx.sampleRate * duration;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        noise.connect(gain);
        gain.connect(this.ctx.destination);
        noise.start();
    },
    sfx: {
        step: () => AudioSys.playNoise(0.05, 0.05),
        throw: () => AudioSys.playTone(400, 'square', 0.1, 0.1),
        hit: () => { AudioSys.playNoise(0.1, 0.2); AudioSys.playTone(100, 'sawtooth', 0.1, 0.2); },
        bossHit: () => { AudioSys.playNoise(0.2, 0.3); AudioSys.playTone(80, 'sawtooth', 0.2, 0.3); },
        alert: () => AudioSys.playTone(600, 'square', 0.2, 0.1),
        text: () => AudioSys.playTone(800, 'square', 0.03, 0.05),
        fix: () => { [440, 554, 659].forEach((f,i) => setTimeout(()=>AudioSys.playTone(f,'sine',0.2,0.1), i*100)); },
        hurt: () => AudioSys.playTone(150, 'sawtooth', 0.3, 0.2),
        start: () => { [440,440,440,660].forEach((f,i)=>setTimeout(()=>AudioSys.playTone(f,'square',0.2,0.2), i*150)); },
        angry: () => AudioSys.playTone(150, 'square', 0.5, 0.2),
        select: () => AudioSys.playTone(550, 'square', 0.1, 0.1),
        bossIntro: () => { 
            AudioSys.playTone(100, 'sawtooth', 1.0, 0.3);
            setTimeout(() => AudioSys.playTone(80, 'sawtooth', 1.0, 0.3), 200);
        },
        pop: () => AudioSys.playTone(1200, 'sine', 0.05, 0.1) // New pop sound for banter
    }
};

const MusicSys = {
    tracks: {
        title: new Audio('Pixel Reverie.mp3'),
        menu: new Audio('Game Over But Not Really.mp3'),
        ingame: new Audio('Pixel Warehouse Crawl.mp3'),
        boss: new Audio('Pixel Panic.mp3'),
        victory: new Audio('Pixel Victory.mp3')
    },
    currentName: null,
    currentRate: 1,
    init() {
        Object.values(this.tracks).forEach(a => {
            a.loop = true; a.volume = 0.35; a.preload = 'auto';
        });
    },
    play(name, rate = 1) {
        const track = this.tracks[name];
        if (!track) return;
        if (this.currentName === name) {
            this.currentRate = rate;
            track.playbackRate = rate;
            if (track.paused) track.play().catch(() => {});
            return;
        }
        if (this.currentName && this.currentName !== name) this.stop();
        this.currentName = name;
        this.currentRate = rate;
        track.playbackRate = rate;
        track.currentTime = 0;
        track.play().catch(() => {});
    },
    stop() {
        if (this.currentName && this.tracks[this.currentName]) {
            const current = this.tracks[this.currentName];
            current.pause(); current.currentTime = 0;
        }
        this.currentName = null;
    },
    resume() {
        if (this.currentName && this.tracks[this.currentName]?.paused) {
            this.tracks[this.currentName].playbackRate = this.currentRate || 1;
            this.tracks[this.currentName].play().catch(() => {});
        }
    }
};

// --- ASSETS ---
const GFX = {};
function generateAssets() {
    const c = (w,h,f) => { const c=document.createElement('canvas');c.width=w;c.height=h;f(c.getContext('2d'));return c;};

    GFX.logo = c(40, 40, ctx => { ctx.fillStyle = '#eab308'; ctx.fillRect(0, 0, 40, 40); ctx.fillStyle = '#fff'; ctx.font = '24px monospace'; ctx.fillText("EE", 5, 28); });

    GFX.chars = {
        "Carrie": c(16,16, ctx => {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(2,1,12,5); ctx.fillRect(3,2,10,2); // black hair
            ctx.fillStyle = '#f5d0a0'; ctx.fillRect(5,6,6,5); // face
            ctx.fillStyle = '#000'; ctx.fillRect(6,8,1,1); ctx.fillRect(9,8,1,1); // eyes
            ctx.fillStyle = '#22c55e'; ctx.fillRect(5,11,6,1); // headset band
            ctx.fillStyle = '#a855f7'; ctx.fillRect(3,11,10,5); // robe
            ctx.fillStyle = '#c4b5fd'; ctx.fillRect(7,12,2,2); // sash highlight
            ctx.fillStyle = '#1e3a8a'; ctx.fillRect(4,15,3,1); ctx.fillRect(9,15,3,1); // boots
        }),
        "Nevena": c(16,16, ctx => {
            ctx.fillStyle = '#7c2d12'; ctx.fillRect(3,2,10,4); ctx.fillRect(2,3,2,5); // brown hair
            ctx.fillStyle = '#f5c89a'; ctx.fillRect(5,6,6,5); // face
            ctx.fillStyle = '#000'; ctx.fillRect(6,8,1,1); ctx.fillRect(9,8,1,1); // eyes
            ctx.fillStyle = '#0ea5e9'; ctx.fillRect(4,3,8,2); // headband
            ctx.fillStyle = '#7f1d1d'; ctx.fillRect(3,11,10,5); // jacket
            ctx.fillStyle = '#eab308'; ctx.fillRect(4,12,2,2); ctx.fillRect(10,12,2,2); // clipboard corners
            ctx.fillStyle = '#334155'; ctx.fillRect(5,15,2,1); ctx.fillRect(9,15,2,1); // boots
        }),
        "Joao": c(16,16, ctx => {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(4,1,8,3); ctx.fillRect(6,0,4,1); // black hair
            ctx.fillStyle = '#f0a16b'; ctx.fillRect(5,4,6,5); // face
            ctx.fillStyle = '#000'; ctx.fillRect(6,6,1,1); ctx.fillRect(9,6,1,1); // eyes
            ctx.fillStyle = '#22d3ee'; ctx.fillRect(4,9,8,1); // mic wire
            ctx.fillStyle = '#fb923c'; ctx.fillRect(3,10,10,6); // vest
            ctx.fillStyle = '#f97316'; ctx.fillRect(4,12,2,2); ctx.fillRect(10,12,2,2); // armbands
            ctx.fillStyle = '#0ea5e9'; ctx.fillRect(5,15,2,1); ctx.fillRect(9,15,2,1); // shoes
        }),
        "Roman": c(16,16, ctx => {
            ctx.fillStyle = '#f5d0a0'; ctx.fillRect(5,4,6,6); // bald head/face
            ctx.fillStyle = '#000'; ctx.fillRect(6,7,1,1); ctx.fillRect(9,7,1,1); // eyes
            ctx.fillStyle = '#1f2937'; ctx.fillRect(4,10,8,2); // collar shadow
            ctx.fillStyle = '#111827'; ctx.fillRect(3,11,10,5); // stealth coat
            ctx.fillStyle = '#94a3b8'; ctx.fillRect(4,12,2,2); ctx.fillRect(10,12,2,2); // cuffs
            ctx.fillStyle = '#0b1224'; ctx.fillRect(4,15,3,1); ctx.fillRect(9,15,3,1); // boots
        }),
        "Erwin": c(16,16, ctx => {
            ctx.fillStyle = '#6b7280'; ctx.fillRect(2,9,12,5); // Tesla body
            ctx.fillStyle = '#9ca3af'; ctx.fillRect(1,12,3,2); ctx.fillRect(12,12,3,2); // wheels
            ctx.fillStyle = '#d1d5db'; ctx.fillRect(3,8,10,2); // hood line
            ctx.fillStyle = '#22d3ee'; ctx.fillRect(4,10,8,2); // windshield glow
            ctx.fillStyle = '#f5d0a0'; ctx.fillRect(6,5,4,3); // face
            ctx.fillStyle = '#111827'; ctx.fillRect(5,4,6,3); // black hair
            ctx.fillStyle = '#0b1224'; ctx.fillRect(6,6,4,2); // beard
            ctx.fillStyle = '#000'; ctx.fillRect(7,6,1,1); ctx.fillRect(9,6,1,1); // eyes
            ctx.fillStyle = '#eab308'; ctx.fillRect(7,7,2,1); // smirk
            ctx.fillStyle = '#0b1224'; ctx.fillRect(4,14,8,2); // bumper
        })
    };

    GFX.attacks = {
        "Carrie": c(12,12, ctx => {
            ctx.fillStyle = '#a855f7'; ctx.fillRect(1,4,10,4);
            ctx.fillStyle = '#c4b5fd'; ctx.fillRect(2,5,8,2);
            ctx.fillStyle = '#10b981'; ctx.fillRect(5,3,2,6);
        }),
        "Nevena": c(12,12, ctx => {
            ctx.fillStyle = '#0ea5e9'; ctx.fillRect(2,2,8,8);
            ctx.fillStyle = '#f8fafc'; ctx.fillRect(3,3,6,6);
            ctx.fillStyle = '#334155'; ctx.fillRect(4,4,4,1);
            ctx.fillStyle = '#94a3b8'; ctx.fillRect(5,7,2,2);
        }),
        "Joao": c(12,12, ctx => {
            ctx.fillStyle = '#f97316'; ctx.beginPath(); ctx.moveTo(1,6); ctx.lineTo(5,2); ctx.lineTo(5,10); ctx.fill();
            ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.moveTo(4,6); ctx.lineTo(9,1); ctx.lineTo(9,11); ctx.fill();
            ctx.fillStyle = '#22d3ee'; ctx.beginPath(); ctx.moveTo(8,6); ctx.lineTo(11,3); ctx.lineTo(11,9); ctx.fill();
        }),
        "Roman": c(12,12, ctx => {
            ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(6,6,4,0,Math.PI*2); ctx.stroke();
            ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.arc(6,6,2,0,Math.PI*2); ctx.fill();
        }),
        "Erwin": c(12,12, ctx => {
            ctx.fillStyle = '#9ca3af'; ctx.fillRect(1,5,10,4);
            ctx.fillStyle = '#6b7280'; ctx.fillRect(2,4,8,3);
            ctx.fillStyle = '#22d3ee'; ctx.fillRect(3,5,6,2);
            ctx.fillStyle = '#0ea5e9'; ctx.fillRect(0,6,3,2); ctx.fillRect(9,6,3,2);
        })
    };
    GFX.simon = c(16,16, ctx => { ctx.fillStyle = '#222'; ctx.fillRect(4,1,8,5); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,5,8,4); ctx.fillStyle = '#000'; ctx.fillRect(4,7,8,1); ctx.fillStyle = '#aaddff'; ctx.fillRect(5,7,2,1); ctx.fillRect(9,7,2,1); ctx.fillStyle = '#eab308'; ctx.fillRect(3,9,10,6); ctx.fillStyle = '#fff'; ctx.fillRect(6,11,4,4); });
    GFX.simonFace = c(32,32, ctx => { ctx.imageSmoothingEnabled=false; ctx.drawImage(GFX.simon,0,0,16,16,0,0,32,32); });
    
    GFX.simonBoss = c(32,32, ctx => { 
        ctx.fillStyle = '#222'; ctx.fillRect(8,2,16,10); ctx.fillStyle = '#ffcc99'; ctx.fillRect(8,12,16,8);
        ctx.fillStyle = '#000'; ctx.fillRect(8,14,16,2); ctx.fillStyle = '#ff0000'; ctx.fillRect(10,14,4,2); ctx.fillRect(18,14,4,2);
        ctx.fillStyle = '#eab308'; ctx.fillRect(6,20,20,12);
    });

    GFX.ops = c(16,16, ctx => { ctx.fillStyle = '#333'; ctx.fillRect(4,2,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#dc2626'; ctx.fillRect(3,10,10,5); ctx.fillStyle = '#000'; ctx.fillRect(5,7,2,1); ctx.fillRect(9,7,2,1); });
    GFX.boss_manager = c(16,16, ctx => { ctx.fillStyle = '#0f172a'; ctx.fillRect(2,1,12,5); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,5); ctx.fillStyle = '#111827'; ctx.fillRect(3,10,10,6); ctx.fillStyle = '#ef4444'; ctx.fillRect(7,11,2,3); ctx.fillStyle = '#000'; ctx.fillRect(6,8,1,1); ctx.fillRect(9,8,1,1); });
    GFX.boss_inspector = c(16,16, ctx => { ctx.fillStyle = '#9ca3af'; ctx.fillRect(3,1,10,4); ctx.fillStyle = '#f5cba7'; ctx.fillRect(4,5,8,5); ctx.fillStyle = '#000'; ctx.fillRect(5,7,2,1); ctx.fillRect(9,7,2,1); ctx.fillStyle = '#facc15'; ctx.fillRect(3,10,10,6); ctx.fillStyle = '#0ea5e9'; ctx.fillRect(4,11,2,2); ctx.fillRect(10,11,2,2); ctx.fillStyle = '#1f2937'; ctx.fillRect(5,15,2,1); ctx.fillRect(9,15,2,1); });
    GFX.boss_compliance = c(16,16, ctx => { ctx.fillStyle = '#0b162a'; ctx.fillRect(3,1,10,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(5,5,6,5); ctx.fillStyle = '#000'; ctx.fillRect(6,7,1,1); ctx.fillRect(9,7,1,1); ctx.fillStyle = '#22d3ee'; ctx.fillRect(3,10,10,6); ctx.fillStyle = '#14b8a6'; ctx.fillRect(7,11,2,3); ctx.fillStyle = '#c084fc'; ctx.fillRect(5,15,2,1); ctx.fillRect(9,15,2,1); });
    GFX.boss_regional = c(16,16, ctx => { ctx.fillStyle = '#312e81'; ctx.fillRect(2,1,12,5); ctx.fillStyle = '#f5d0a0'; ctx.fillRect(4,6,8,5); ctx.fillStyle = '#000'; ctx.fillRect(6,8,1,1); ctx.fillRect(9,8,1,1); ctx.fillStyle = '#581c87'; ctx.fillRect(3,10,10,6); ctx.fillStyle = '#fbbf24'; ctx.fillRect(7,11,2,3); ctx.fillStyle = '#cbd5e1'; ctx.fillRect(5,15,2,1); ctx.fillRect(9,15,2,1); });
    GFX.boss_sebastian = c(16,16, ctx => { ctx.fillStyle = '#f5d0a0'; ctx.fillRect(5,2,6,6); ctx.fillStyle = '#1d4ed8'; ctx.fillRect(3,8,10,1); ctx.fillStyle = '#2563eb'; ctx.fillRect(2,9,12,6); ctx.fillStyle = '#f97316'; ctx.fillRect(7,11,2,2); ctx.fillStyle = '#000'; ctx.fillRect(6,4,1,1); ctx.fillRect(9,4,1,1); ctx.fillStyle = '#eab308'; ctx.fillRect(3,1,10,2); });
    GFX.boss_jelly = c(16,16, ctx => { ctx.fillStyle = '#ec4899'; ctx.fillRect(3,1,10,5); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,5,8,5); ctx.fillStyle = '#000'; ctx.fillRect(5,7,2,1); ctx.fillRect(9,7,2,1); ctx.fillStyle = '#22c55e'; ctx.fillRect(3,10,10,6); ctx.fillStyle = '#f5f5f5'; ctx.fillRect(6,12,4,2); ctx.fillStyle = '#10b981'; ctx.fillRect(2,9,2,2); });
    GFX.boss_avetta = c(16,16, ctx => { ctx.fillStyle = '#0f172a'; ctx.fillRect(2,2,12,12); ctx.fillStyle = '#22d3ee'; ctx.fillRect(3,3,10,10); ctx.fillStyle = '#0ea5e9'; ctx.fillRect(5,5,6,2); ctx.fillRect(5,9,6,2); ctx.fillStyle = '#34d399'; ctx.fillRect(4,7,8,1); ctx.fillStyle = '#fcd34d'; ctx.fillRect(7,6,2,4); });
    GFX.boss_bot = c(16,16, ctx => { ctx.fillStyle = '#475569'; ctx.fillRect(2,2,12,12); ctx.fillStyle = '#1e293b'; ctx.fillRect(3,3,10,2); ctx.fillStyle = '#7dd3fc'; ctx.fillRect(5,6,2,2); ctx.fillRect(9,6,2,2); ctx.fillStyle = '#22c55e'; ctx.fillRect(4,10,8,3); ctx.fillStyle = '#9ca3af'; ctx.fillRect(7,0,2,2); ctx.fillStyle = '#ef4444'; ctx.fillRect(7,12,2,2); });

    GFX.mechaJeff = c(64,64, ctx => {
        // cockpit frame
        ctx.fillStyle = '#0b1224'; ctx.fillRect(0,0,64,64);
        ctx.fillStyle = '#111827'; ctx.fillRect(4,4,56,56);
        ctx.fillStyle = '#1f2937'; ctx.fillRect(8,8,48,48);
        // Bezos chrome collar
        ctx.fillStyle = '#0ea5e9'; ctx.fillRect(10,44,44,10);
        ctx.fillStyle = '#38bdf8'; ctx.fillRect(14,46,36,6);
        ctx.fillStyle = '#9ca3af'; ctx.fillRect(8,40,48,6);
        // shiny bald dome
        ctx.fillStyle = '#fcd7b6'; ctx.fillRect(18,14,28,22);
        ctx.fillStyle = '#fbbf77'; ctx.fillRect(20,12,24,10);
        ctx.fillStyle = '#fed7aa'; ctx.fillRect(22,10,20,10);
        ctx.fillStyle = '#fde68a'; ctx.fillRect(30,8,10,4);
        // eyebrows and eyes
        ctx.fillStyle = '#111827'; ctx.fillRect(22,24,8,2); ctx.fillRect(34,24,8,2);
        ctx.fillStyle = '#0ea5e9'; ctx.fillRect(24,27,6,5); ctx.fillRect(36,27,6,5);
        ctx.fillStyle = '#fff'; ctx.fillRect(25,28,2,2); ctx.fillRect(37,28,2,2);
        ctx.fillStyle = '#000'; ctx.fillRect(27,29,1,1); ctx.fillRect(39,29,1,1);
        // stern mouth plate
        ctx.fillStyle = '#1f2937'; ctx.fillRect(26,36,12,4);
        ctx.fillStyle = '#0ea5e9'; ctx.fillRect(26,38,12,2);
        // shoulder plates with arrow smile motif
        ctx.fillStyle = '#9ca3af'; ctx.fillRect(12,32,8,10); ctx.fillRect(44,32,8,10);
        ctx.fillStyle = '#22c55e'; ctx.fillRect(14,34,4,6); ctx.fillRect(46,34,4,6);
        ctx.fillStyle = '#f59e0b'; ctx.fillRect(20,48,24,4);
        ctx.fillStyle = '#f97316'; ctx.fillRect(24,50,16,2);
    });
    GFX.assoc = c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(4,2,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#eab308'; ctx.fillRect(3,10,10,5); });
    GFX.runner = c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(4,2,8,4); ctx.fillStyle = '#ffcc99'; ctx.fillRect(4,6,8,4); ctx.fillStyle = '#eab308'; ctx.fillRect(3,10,10,5); ctx.fillStyle = '#fff'; ctx.fillRect(1, 12, 2, 1); ctx.fillRect(14, 10, 2, 1); });

    GFX.van = c(34,18, ctx => {
        ctx.fillStyle = '#020617'; ctx.fillRect(0,12,34,6);
        ctx.fillStyle = '#0b1224'; ctx.fillRect(1,10,32,8);
        ctx.fillStyle = '#1d4ed8'; ctx.fillRect(2,4,30,10);
        ctx.fillStyle = '#1e3a8a'; ctx.fillRect(2,10,30,2);
        ctx.fillStyle = '#2563eb'; ctx.fillRect(4,6,26,8);
        ctx.fillStyle = '#60a5fa'; ctx.fillRect(6,7,14,5);
        ctx.fillStyle = '#c7d2fe'; ctx.fillRect(20,6,8,6);
        ctx.fillStyle = '#0ea5e9'; ctx.fillRect(22,9,6,2);
        ctx.fillStyle = '#0f172a'; ctx.fillRect(6,14,8,4); ctx.fillRect(22,14,8,4);
        ctx.fillStyle = '#eab308'; ctx.fillRect(4,12,2,2); ctx.fillRect(28,12,2,2);
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(14,5,2,2);
        ctx.fillStyle = '#0f172a'; ctx.font = '6px monospace'; ctx.fillText('DSP', 6, 11);
        ctx.fillStyle = '#94a3b8'; ctx.fillRect(0,15,4,3); ctx.fillRect(30,15,4,3);
    });

    GFX.truck = c(52,20, ctx => {
        ctx.fillStyle = '#020617'; ctx.fillRect(0,14,52,6);
        ctx.fillStyle = '#0b1224'; ctx.fillRect(1,12,50,8);
        ctx.fillStyle = '#cbd5e1'; ctx.fillRect(4,4,44,12);
        ctx.fillStyle = '#e5e7eb'; ctx.fillRect(6,6,40,10);
        ctx.fillStyle = '#94a3b8'; ctx.fillRect(6,8,18,8);
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(24,8,24,8);
        ctx.fillStyle = '#dbeafe'; ctx.fillRect(6,6,14,3);
        ctx.fillStyle = '#1d4ed8'; ctx.fillRect(8,6,20,2);
        ctx.fillStyle = '#0ea5e9'; ctx.fillRect(8,12,34,2);
        ctx.fillStyle = '#0f172a'; ctx.fillRect(10,15,10,4); ctx.fillRect(34,15,10,4);
        ctx.fillStyle = '#facc15'; ctx.fillRect(4,4,4,10);
        ctx.fillStyle = '#0f172a'; ctx.font = '7px monospace'; ctx.fillText('PRIME', 22, 13);
        ctx.fillStyle = '#64748b'; ctx.fillRect(2,10,6,6);
        ctx.fillStyle = '#fbbf24'; ctx.fillRect(40,6,6,2);
        ctx.fillStyle = '#c2410c'; ctx.fillRect(0,16,52,1);
    });

    GFX.flyingBox = c(14,14, ctx => {
        ctx.fillStyle = '#78350f'; ctx.fillRect(1,3,12,10);
        ctx.fillStyle = '#a16207'; ctx.fillRect(2,2,10,10);
        ctx.fillStyle = '#f59e0b'; ctx.fillRect(2,6,10,2);
        ctx.fillStyle = '#111827'; ctx.fillRect(4,4,2,2); ctx.fillRect(8,4,2,2);
        ctx.fillStyle = '#fbbf24'; ctx.fillRect(6,1,2,2);
    });
    
    GFX.clutter = { cart: c(16,16, ctx => { ctx.fillStyle = '#444'; ctx.fillRect(2,6,12,8); ctx.fillStyle = '#8b4513'; ctx.fillRect(4,4,8,6); }), coffee: c(8,8, ctx => { ctx.fillStyle='#fff'; ctx.fillRect(2,2,4,5); }), paper: c(8,8, ctx => { ctx.fillStyle='#eee'; ctx.fillRect(1,3,6,4); }), tape: c(8,8, ctx => { ctx.fillStyle='#d97706'; ctx.beginPath(); ctx.arc(4,4,3,0,Math.PI*2); ctx.fill(); }) };
   GFX.hazards = {
    // --- Liquids / Spills ---
    spill: c(16,16, ctx => {
        // dark base
        ctx.fillStyle = '#15803d';
        ctx.beginPath();
        ctx.ellipse(8,10,7,5,0,0,Math.PI*2);
        ctx.fill();
        // main puddle
        ctx.fillStyle = '#16a34a';
        ctx.beginPath();
        ctx.ellipse(8,9,6,4,0,0,Math.PI*2);
        ctx.fill();
        // highlight
        ctx.fillStyle = '#22c55e';
        ctx.beginPath();
        ctx.ellipse(6,7,3.5,2.5,0,0,Math.PI*2);
        ctx.fill();
        // shiny reflection
        ctx.fillStyle = '#bbf7d0';
        ctx.fillRect(9,10,3,2);
    }),

    // --- Boxes / Generic obstacles ---
    box: c(16,16, ctx => {
        // shadow
        ctx.fillStyle = '#78350f';
        ctx.fillRect(1,5,14,9);
        // front face
        ctx.fillStyle = '#a16207';
        ctx.fillRect(2,4,12,9);
        // top flap layers
        ctx.fillStyle = '#fbbf24';
        ctx.fillRect(2,3,12,2);
        ctx.fillStyle = '#ca8a04';
        ctx.fillRect(2,5,12,1);
        // tape
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(5,8,6,2);
        // label
        ctx.fillStyle = '#111';
        ctx.fillRect(7,6,2,2);
    }),

    // --- Chemical drum / unlabeled chem ---
    drum: c(16,16, ctx => {
        // body
        ctx.fillStyle = '#1d4ed8';
        ctx.fillRect(4,3,8,10);
        // top ellipse
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.ellipse(8,3,4,2,0,0,Math.PI*2);
        ctx.fill();
        // bands
        ctx.fillRect(4,6,8,2);
        ctx.fillRect(4,10,8,2);
        // hazard label
        ctx.fillStyle = '#f97373';
        ctx.fillRect(6,7,4,3);
        ctx.fillStyle = '#111';
        ctx.fillRect(7,8,2,1);
    }),

    // --- Tall pallet stacks ---
    tall_pallet: c(16,16, ctx => {
        // main stack
        ctx.fillStyle = '#d97706';
        ctx.fillRect(3,1,10,13);
        // box layers
        ctx.fillStyle = '#ea580c';
        ctx.fillRect(4,2,8,2);
        ctx.fillRect(4,6,8,2);
        ctx.fillRect(4,10,8,2);
        // vertical slats
        ctx.fillStyle = '#b45309';
        ctx.fillRect(5,1,1,13);
        ctx.fillRect(10,1,1,13);
        // pallet base
        ctx.fillStyle = '#f59e0b';
        ctx.fillRect(3,14,10,1);
    }),

    // --- Debris / broken pallets ---
    debris: c(16,16, ctx => {
        ctx.save();
        ctx.translate(8,9);
        ctx.rotate(0.4);
        // main plank
        ctx.fillStyle = '#92400e';
        ctx.fillRect(-7,-2,14,4);
        // broken edge
        ctx.fillStyle = '#f97316';
        ctx.fillRect(-3,-2,3,4);
        ctx.restore();

        // extra small chunks
        ctx.fillStyle = '#b45309';
        ctx.fillRect(3,12,2,2);
        ctx.fillRect(11,11,2,2);
    }),

    // --- Pallet jack / pump truck ---
    jack: c(16,16, ctx => {
        // base
        ctx.fillStyle = '#e11d48';
        ctx.fillRect(2,9,12,3);
        ctx.fillStyle = '#fca5a5';
        ctx.fillRect(4,8,8,2);
        // handle
        ctx.strokeStyle = '#111';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(5,8);
        ctx.lineTo(5,4);
        ctx.lineTo(8,3);
        ctx.stroke();
        // wheels
        ctx.fillStyle = '#111';
        ctx.fillRect(3,11,3,3);
        ctx.fillRect(10,11,3,3);
    }),

    // --- Conveyor / chute ---
    conveyor: c(16,16, ctx => {
        // frame
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(1,5,14,7);
        // belt
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(2,6,12,5);
        // rollers
        ctx.fillStyle = '#94a3b8';
        ctx.fillRect(2,5,3,2);
        ctx.fillRect(11,5,3,2);
        // package jam indicator
        ctx.fillStyle = '#ef4444';
        ctx.fillRect(7,6,2,4);
        // tiny package on top
        ctx.fillStyle = '#eab308';
        ctx.fillRect(6,4,4,2);
    }),

    // --- Batteries / acid trail ---
    battery: c(16,16, ctx => {
        // body
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(3,5,10,7);
        // terminals
        ctx.fillStyle = '#facc15';
        ctx.fillRect(5,4,2,2);
        ctx.fillRect(9,4,2,2);
        // lightning symbol
        ctx.fillStyle = '#fbbf24';
        ctx.beginPath();
        ctx.moveTo(8,6);
        ctx.lineTo(6,10);
        ctx.lineTo(8,10);
        ctx.lineTo(7,13);
        ctx.lineTo(10,9);
        ctx.lineTo(8,9);
        ctx.closePath();
        ctx.fill();
        // leak puddle
        ctx.fillStyle = '#34d399';
        ctx.beginPath();
        ctx.arc(8,13,4,Math.PI,Math.PI*2);
        ctx.fill();
    }),

    // --- Cords / cables / scanner ---
    cord: c(16,16, ctx => {
        // curly cable
        ctx.strokeStyle = '#facc15';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(2,3);
        ctx.bezierCurveTo(6,7,10,1,14,6);
        ctx.stroke();
        // plug body
        ctx.fillStyle = '#111827';
        ctx.fillRect(10,6,4,5);
        // prongs
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(11,11,1,2);
        ctx.fillRect(13,11,1,2);
    }),

    // --- Tote / bin ---
    tote: c(16,16, ctx => {
        // body
        ctx.fillStyle = '#1d4ed8';
        ctx.fillRect(2,6,12,7);
        // rim
        ctx.fillStyle = '#2563eb';
        ctx.fillRect(2,4,12,3);
        // inner line
        ctx.fillStyle = '#60a5fa';
        ctx.fillRect(3,7,10,2);
        // label
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(6,9,4,3);
        // handles
        ctx.fillStyle = '#bfdbfe';
        ctx.fillRect(3,5,2,1);
        ctx.fillRect(11,5,2,1);
    }),

    // --- Stretch wrap / loose foil ---
    wrap: c(16,16, ctx => {
        // main crumpled foil
        ctx.fillStyle = '#e5e7eb';
        ctx.beginPath();
        ctx.moveTo(3,4);
        ctx.lineTo(13,6);
        ctx.lineTo(10,13);
        ctx.lineTo(4,12);
        ctx.closePath();
        ctx.fill();
        // tension stripe
        ctx.fillStyle = '#9ca3af';
        ctx.fillRect(5,6,6,2);
        // torn edge
        ctx.fillStyle = '#d1d5db';
        ctx.fillRect(8,11,3,2);
    }),

    // --- Roller cage / cart cage ---
    cage: c(16,16, ctx => {
        // frame
        ctx.fillStyle = '#4b5563';
        ctx.fillRect(3,2,10,11);
        // bars
        ctx.fillStyle = '#9ca3af';
        for (let x = 4; x <= 11; x += 2) {
            ctx.fillRect(x,3,1,9);
        }
        ctx.fillRect(3,6,10,1);
        ctx.fillRect(3,9,10,1);
        // wheels
        ctx.fillStyle = '#111827';
        ctx.fillRect(4,13,3,2);
        ctx.fillRect(9,13,3,2);
    }),

    // --- Flat cart / blue cart ---
    cart: c(16,16, ctx => {
        // platform
        ctx.fillStyle = '#1d4ed8';
        ctx.fillRect(2,9,12,3);
        ctx.fillStyle = '#3b82f6';
        ctx.fillRect(2,8,12,2);
        // handle
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(3,4,2,4);
        ctx.fillRect(3,4,8,2);
        // wheels
        ctx.fillStyle = '#111';
        ctx.fillRect(3,12,3,3);
        ctx.fillRect(10,12,3,3);
    }),

    // --- Fire door + wedge hazard ---
    door: c(16,16, ctx => {
        // door leaf
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(4,2,8,12);
        // frame
        ctx.strokeStyle = '#9ca3af';
        ctx.lineWidth = 1;
        ctx.strokeRect(4.5,2.5,7,11);
        // push bar
        ctx.fillStyle = '#64748b';
        ctx.fillRect(6,8,4,1);
        // wedge
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.moveTo(5,14);
        ctx.lineTo(8,14);
        ctx.lineTo(8,12);
        ctx.closePath();
        ctx.fill();
    }),

    // --- Dock area / dock plate ---
    dock: c(16,16, ctx => {
        // pit
        ctx.fillStyle = '#020617';
        ctx.fillRect(2,6,12,7);
        // plate
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(3,7,10,5);
        // yellow safety edge
        ctx.fillStyle = '#eab308';
        ctx.fillRect(3,7,10,1);
        ctx.fillRect(3,11,10,1);
        // warning stripes
        ctx.fillStyle = '#f97316';
        ctx.fillRect(3,5,3,1);
        ctx.fillRect(10,5,3,1);
    }),

    // --- General facility hazard (bollard, column, etc.) ---
    facility: c(16,16, ctx => {
        // column
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(6,2,4,11);
        // yellow/black stripes
        ctx.fillStyle = '#eab308';
        ctx.fillRect(5,9,6,4);
        ctx.fillStyle = '#111827';
        ctx.fillRect(5,10,6,1);
        ctx.fillRect(5,12,6,1);
        // small crack
        ctx.fillStyle = '#9ca3af';
        ctx.fillRect(7,5,2,1);
    }),

    // --- NPC / associate ---
    npc: c(16,16, ctx => {
        // head
        ctx.fillStyle = '#facc15';
        ctx.beginPath();
        ctx.arc(8,4,3,0,Math.PI*2);
        ctx.fill();
        // body (vest)
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(5,7,6,6);
        // hi-vis stripes
        ctx.fillStyle = '#fbbf24';
        ctx.fillRect(5,8,6,1);
        ctx.fillRect(5,10,6,1);
        // legs
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(5,13,2,2);
        ctx.fillRect(9,13,2,2);
    }),

    // --- Forklift / FLT ---
    forklift: c(16,16, ctx => {
        // body
        ctx.fillStyle = '#f59e0b';
        ctx.fillRect(4,7,7,5);
        // cabin
        ctx.fillStyle = '#fbbf24';
        ctx.fillRect(4,5,5,3);
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(5,6,3,2);
        // mast
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(10,3,2,9);
        // forks
        ctx.fillRect(11,11,3,1);
        ctx.fillRect(11,12,3,1);
        // wheels
        ctx.fillStyle = '#111827';
        ctx.fillRect(4,11,3,3);
        ctx.fillRect(8,11,3,3);
    }),

    // --- Yard / van area ---
    yard: c(16,16, ctx => {
        // road
        ctx.fillStyle = '#020617';
        ctx.fillRect(1,4,14,10);
        // lane markings
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(4,9,2,1);
        ctx.fillRect(7,9,2,1);
        ctx.fillRect(10,9,2,1);
        // van silhouette
        ctx.fillStyle = '#1d4ed8';
        ctx.fillRect(4,5,8,4);
        ctx.fillStyle = '#3b82f6';
        ctx.fillRect(5,6,6,2);
        // wheels
        ctx.fillStyle = '#111827';
        ctx.fillRect(5,9,2,2);
        ctx.fillRect(9,9,2,2);
    }),

    // --- Compliance / documentation / SIR spike ---
    compliance: c(16,16, ctx => {
        // paper sheet
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(4,2,8,12);
        // folded corner
        ctx.fillStyle = '#cbd5f5';
        ctx.fillRect(9,2,3,3);
        // lines
        ctx.fillStyle = '#94a3b8';
        ctx.fillRect(5,5,6,1);
        ctx.fillRect(5,7,5,1);
        ctx.fillRect(5,9,4,1);
        // exclamation mark
        ctx.fillStyle = '#ef4444';
        ctx.fillRect(8,10,1,3);
        ctx.fillRect(8,14,1,1);
    }),

    // --- Box cutter / blade hazard ---
    blade: c(16,16, ctx => {
        // handle
        ctx.fillStyle = '#ef4444';
        ctx.fillRect(3,7,8,4);
        // grip
        ctx.fillStyle = '#b91c1c';
        ctx.fillRect(4,8,2,2);
        // blade
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(10,8,4,2);
        // blade edge line
        ctx.fillStyle = '#9ca3af';
        ctx.fillRect(11,9,3,1);
    })
};
    GFX.door = c(16,16, ctx => { ctx.fillStyle = '#16a34a'; ctx.fillRect(2,2,12,14); ctx.fillStyle='#fff'; ctx.fillRect(3,4,10,2); });
    GFX.floor = c(16,16, ctx => { ctx.fillStyle = '#4a4a4a'; ctx.fillRect(0,0,16,16); ctx.fillStyle = '#404040'; ctx.fillRect(0,15,16,1); });
    GFX.wall = c(16,16, ctx => { ctx.fillStyle = '#3e2723'; ctx.fillRect(0,0,16,16); ctx.fillStyle = '#5d4037'; ctx.fillRect(0,6,16,10); });
    GFX.shelf = c(16,16, ctx => { ctx.fillStyle = '#f59e0b'; ctx.fillRect(2,0,2,16); ctx.fillRect(12,0,2,16); ctx.fillStyle = '#d97706'; ctx.fillRect(2,4,12,2); });
    GFX.book = c(8,8, ctx => { ctx.fillStyle = '#fff'; ctx.fillRect(0,0,8,8); ctx.fillStyle='green'; ctx.fillRect(2,2,4,4); });
    GFX.req = c(10,10, ctx => { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(5,0); ctx.lineTo(10,5); ctx.lineTo(5,10); ctx.lineTo(0,5); ctx.fill(); ctx.fillStyle='red'; ctx.font='8px sans'; ctx.fillText("!",3,8); });
    GFX.bossProj = c(12,12, ctx => { ctx.fillStyle = '#ff00ff'; ctx.beginPath(); ctx.arc(6,6,5,0,Math.PI*2); ctx.fill(); });

    GFX.erwinFace = c(96,96, ctx => {
        ctx.fillStyle = '#111827'; ctx.fillRect(0,0,96,96);
        ctx.fillStyle = '#1f2937'; ctx.fillRect(6,6,84,84);
        ctx.fillStyle = '#0f172a'; ctx.fillRect(4,60,88,20);
        ctx.fillStyle = '#f5d0a0'; ctx.fillRect(26,26,44,40);
        ctx.fillStyle = '#d1a878'; ctx.fillRect(30,30,36,30);
        ctx.fillStyle = '#0b1224'; ctx.fillRect(30,40,36,6);
        ctx.fillStyle = '#0f172a'; ctx.fillRect(32,36,10,4); ctx.fillRect(54,36,10,4);
        ctx.fillStyle = '#eab308'; ctx.fillRect(44,52,8,4);
        ctx.fillStyle = '#0b1224'; ctx.fillRect(34,56,28,10);
        ctx.fillStyle = '#e5e7eb'; ctx.fillRect(22,22,52,6);
        ctx.fillStyle = '#4b5563'; ctx.fillRect(18,18,60,6);
        ctx.fillStyle = '#6b7280'; ctx.fillRect(32,68,32,10);
    });
}
// --- GAME STATE ---
const GAME = {
    state: 'LOGO',
    stateTimer: 0,
    nextState: 'PLAY',
    ticks: 0,
    player: null,
    selectedChar: "Carrie",
    charList: ["Carrie", "Nevena", "Joao", "Roman", "Erwin"],
    charIndex: 0,
    camera: { x: 0, y: 0 },
    map: [], clutter: [], entities: [], projectiles: [], particles: [], floatingTexts: [],
    activeIssues: [],
    issuesFixed: 0, lives: 5, genId: 0, gameOverTriggered: false, simonHits: 0, boss: null, pendingBossIntro: false,
    hiddenDoor: null, yard: null, mecha: null,
    shake: 0, flash: 0,
    dialogText: "", dialogVisible: "", dialogTimer: 0,
    splashTimer: 0, aiResultText: null,
    startTime: 0, booksFired: 0, opsPushed: 0,
    lastAIBanterTime: 0, // Throttle AI requests

    bossTypes: [
        { name: "Labour Inspector", sprite: "boss_inspector", hp: 10, speed: 1.2, attackDelay: 50, title: "The Enforcer", desc: "Checks every corner.", attackName: "Citation Storm" },
        { name: "Compliance Auditor", sprite: "boss_compliance", hp: 12, speed: 0.8, attackDelay: 70, title: "The Watcher", desc: "Nothing escapes.", attackName: "Audit Trail" },
        { name: "Sebastian Sprigade", sprite: "boss_sebastian", hp: 15, speed: 1.0, attackDelay: 60, title: "Delivery Station Mgr", desc: "Obsessed with TPH.", attackName: "Volume Spike" },
        { name: "Regional OPS MGR", sprite: "boss_regional", hp: 14, speed: 0.6, attackDelay: 90, title: "The Executive", desc: "Metrics first.", attackName: "Budget Cut" },
        { name: "Avetta Platform", sprite: "boss_avetta", hp: 18, speed: 0.4, attackDelay: 100, title: "Risk Mgmt AI", desc: "Judges all.", attackName: "Compliance Block" },
        { name: "Jelena \"Jelly\"", sprite: "boss_jelly", hp: 13, speed: 0.9, attackDelay: 65, title: "HR Guardian", desc: "HR legend who never forgets a policy.", attackName: "Policy Shock" }
    ]
};

const HAZARD_POOL = [
    { name: "Runaway Roller Cage", type: "cage" },
    { name: "Rogue Blue Cart", type: "cart" },
    { name: "Mysterious Wet Spot", type: "spill" },
    { name: "Leaking Ice Pack", type: "spill" },
    { name: "Misplaced Fire Door Wedge", type: "door" },
    { name: "Unplugged Dock Plate Sensor", type: "dock" },
    { name: "Crumbling Pallet Kingdom", type: "tall_pallet" },
    { name: "Jammed Chute Monster", type: "conveyor" },
    { name: "DIY Stair Railing", type: "facility" },
    { name: "Slippery Floor Tape", type: "spill" },
    
    // Funny but realistic WHS chaos
    { name: "Coffee Lake at Standup", type: "spill" },
    { name: "Mysterious Lunchbox Leak", type: "spill" },
    { name: "The Legendary Flying Tote", type: "tote" },
    { name: "Forbidden Pallet Tower of Vienna", type: "tall_pallet" },
    { name: "Beeping Scanner of Doom", type: "cord" },
    { name: "Random Orange Cone", type: "facility" },
    { name: "Breakroom Soup Catastrophe", type: "spill" },
    { name: "Sweaty Floor From Peak Shift", type: "spill" },
    
    // Real-life Amazon classics
    { name: "DSP Van Oil Drip", type: "spill" },
    { name: "On-Road Safety Cone Family", type: "facility" },
    { name: "Fallen Exit Sign", type: "facility" },
    { name: "Poorly Parked Pump Truck", type: "jack" },
    { name: "Stray Shipping Label", type: "debris" },
    { name: "Half-Dead Emergency Light", type: "facility" },
    { name: "Box with Surprises (Unknown Contents)", type: "box" },
    { name: "Missing Bollard Protector", type: "facility" },
    { name: "Frayed Box Cutter Lanyard", type: "cord" },
    { name: "Untrained Pallet Jack Driver", type: "jack" },
    
    // Peak Season specials
    { name: "Gift Wrap Glitter Spill", type: "spill" },
    { name: "Overfilled Holiday Tote", type: "tote" },
    { name: "Candy Cane Slippage Hazard", type: "spill" },
    { name: "Runaway Santa Sweater Fibers", type: "debris" },

    // NPC-related hazards
    { name: "Associate Napping Behind Gaylord", type: "npc" },
    { name: "Speedwalking Manager", type: "npc" },
    { name: "New Hire in Wrong Area", type: "npc" },
    { name: "Stower Dancing to Headphones", type: "npc" },
    { name: "Driver With 8 Empty Coffee Cups", type: "npc" },

    // Funny DS chaos
    { name: "Unexplained Forklift Beeping", type: "forklift" },
    { name: "Van Driver Doing a 27-Point Turn", type: "yard" },
    { name: "Dock Door That Won’t Stay Open", type: "dock" },
    { name: "Dock Door That Won’t Stay Closed", type: "dock" },
    { name: "Leaning Tower of Mis-Sorted Packages", type: "tall_pallet" },
    { name: "Bag of Air Pillows on the Loose", type: "debris" },
    { name: "Crushed Amazon Fresh Bag", type: "spill" },
    { name: "Open Knife Left on Cart", type: "blade" },
    { name: "Bermuda Triangle of Missing Totes", type: "tote" },

    // Tech weirdness
    { name: "Glitching Voice Pick Headset", type: "cord" },
    { name: "Scanner That Randomly Reboots", type: "cord" },
    { name: "Mystery Bluetooth Interference", type: "cord" },

    // High comedy hazards
    { name: "Associate Riding Pallet Jack Like Scooter", type: "jack" },
    { name: "Box Labelled 'Definitely Not Dangerous'", type: "box" },
    { name: "Stack Held Together by Hope", type: "tall_pallet" },
    { name: "Employee Who Thinks He’s Faster Than Conveyor", type: "npc" },
    { name: "The Forbidden Shortcut", type: "facility" },
    { name: "Random Banana Peel", type: "spill" },

    // Yard area special for your yard music level
    { name: "Leaking Coolant from DSP Van", type: "spill" },
    { name: "Loose Yard Sign Flapping Menacingly", type: "facility" },
    { name: "Stray Wheel Chock", type: "debris" },
    { name: "Wet Leaves From Delivery Vans", type: "spill" },
    { name: "Van Door Hinge Failure", type: "yard" },

    // Simon Unglaube tribute hazards (WHS manager boss fight)
    { name: "SIR Spike on Whiteboard", type: "compliance" },
    { name: "Outdated Risk Assessment", type: "compliance" },
    { name: "Unapproved Process Change", type: "compliance" },
];

function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function pickRandomHazards(count) {
    const picks = shuffleArray([...HAZARD_POOL]);
    return picks.slice(0, Math.min(count, picks.length));
}

function randomDoorPlacement() {
    const side = ['top', 'bottom', 'left', 'right'][Math.floor(Math.random() * 4)];
    const buffer = 2;
    let doorX = 0, doorY = 0, hazardX = 0, hazardY = 0;

    if (side === 'top') {
        doorY = 0; doorX = Math.floor(Math.random() * (MAP_W - buffer * 2)) + buffer;
        hazardX = doorX; hazardY = 1;
    } else if (side === 'bottom') {
        doorY = MAP_H - 1; doorX = Math.floor(Math.random() * (MAP_W - buffer * 2)) + buffer;
        hazardX = doorX; hazardY = MAP_H - 2;
    } else if (side === 'left') {
        doorX = 0; doorY = Math.floor(Math.random() * (MAP_H - buffer * 2)) + buffer;
        hazardX = 1; hazardY = doorY;
    } else {
        doorX = MAP_W - 1; doorY = Math.floor(Math.random() * (MAP_H - buffer * 2)) + buffer;
        hazardX = MAP_W - 2; hazardY = doorY;
    }

    return { doorX, doorY, hazardX, hazardY };
}

function isTileFree(tx, ty) {
    if (GAME.map[ty][tx] !== 0) return false;
    return !GAME.activeIssues.some(h => Math.round(h.x / TILE_SIZE) === tx && Math.round(h.y / TILE_SIZE) === ty);
}

function pickRandomFloorTile() {
    let attempts = 0;
    while (attempts < 500) {
        const tx = Math.floor(Math.random() * (MAP_W - 2)) + 1;
        const ty = Math.floor(Math.random() * (MAP_H - 2)) + 1;
        if (isTileFree(tx, ty)) return { tx, ty };
        attempts++;
    }
    return { tx: 1, ty: 1 };
}

// --- INPUT ---
const KEYS = { up: false, down: false, left: false, right: false, action: false };
window.addEventListener('keydown', e => {
    if(e.key==='w'||e.key==='ArrowUp') KEYS.up=true;
    if(e.key==='s'||e.key==='ArrowDown') KEYS.down=true;
    if(e.key==='a'||e.key==='ArrowLeft') KEYS.left=true;
    if(e.key==='d'||e.key==='ArrowRight') KEYS.right=true;
    if(e.code==='Space') { if(!KEYS.action) handleAction(); KEYS.action=true; }
});
window.addEventListener('keyup', e => {
    if(e.key==='w'||e.key==='ArrowUp') KEYS.up=false;
    if(e.key==='s'||e.key==='ArrowDown') KEYS.down=false;
    if(e.key==='a'||e.key==='ArrowLeft') KEYS.left=false;
    if(e.key==='d'||e.key==='ArrowRight') KEYS.right=false;
    if(e.code==='Space') KEYS.action=false;
});

function handleAction() {
    AudioSys.init(); AudioSys.resume(); MusicSys.init(); MusicSys.resume(); updateMusicForState();
    if (GAME.state === 'LOSE_SPLASH' || GAME.state === 'WIN_SPLASH') return;
    if (GAME.state === 'LOGO') { advanceState(); }
    else if (['INTRO', 'STORY'].includes(GAME.state)) { AudioSys.sfx.start(); advanceState(); }
    else if (['TITLE', 'HOWTO'].includes(GAME.state)) { 
        GAME.state = (GAME.state==='TITLE')?'HOWTO':'SELECT'; AudioSys.sfx.select(); updateMusicForState();
    }
    else if (GAME.state === 'SELECT') { AudioSys.sfx.select(); GAME.selectedChar = GAME.charList[GAME.charIndex]; resetGame(); }
    else if (GAME.state === 'DIALOG') {
        if (GAME.dialogVisible.length < GAME.dialogText.length) {
            GAME.dialogVisible = GAME.dialogText; document.getElementById('text-content').innerText = GAME.dialogVisible;
        } else { closeDialog(); }
    }
    else if (GAME.state === 'VISITOR_SPLASH') { initBossEncounter(); }
    else if (GAME.state === 'BOSS_INTRO') { GAME.state = 'BOSS'; GAME.nextState = 'BOSS'; updateMusicForState(); }
    else if (GAME.state === 'YARD_INTRO') { startYardLevel(); }
    else if (GAME.state === 'MECHA_BOSS_INTRO') { GAME.state = 'MECHA_BOSS'; GAME.stateTimer = 0; updateMusicForState(); }
    else if (GAME.state === 'CREDITS') {
        if (GAME.stateTimer > 600) { GAME.state = 'TITLE'; updateMusicForState(); }
    }
    else if (GAME.state === 'GAMEOVER' || GAME.state === 'WIN') {
        document.getElementById('boss-hud').style.display = 'none'; GAME.state = 'TITLE'; updateMusicForState();
    }
    else if (['PLAY','BOSS','MECHA_BOSS'].includes(GAME.state)) { if (GAME.state === 'PLAY' && tryInteract()) return; throwBook(); }
}

function init() {
    generateAssets();
    GAME.state = 'LOGO';
    updateMusicForState();
    requestAnimationFrame(loop);
}

function advanceState() {
    GAME.stateTimer = 0;
    if (GAME.state === 'LOGO') GAME.state = 'INTRO';
    else if (GAME.state === 'INTRO') GAME.state = 'STORY';
    else if (GAME.state === 'STORY') GAME.state = 'TITLE';
    else if (GAME.state === 'TITLE') GAME.state = 'HOWTO'; 
    updateMusicForState();
}

function resetGame() {
    GAME.state = 'PLAY';
    GAME.genId++;
    GAME.gameOverTriggered = false;
    const stats = getCharStats(GAME.selectedChar);
    GAME.player = { x: 100, y: 100, dir: 0, speed: stats.speed, iframe: 0, cooldown: 0, cooldownMax: 120 };
    GAME.entities = []; GAME.projectiles = []; GAME.particles = []; GAME.floatingTexts = [];
    GAME.activeIssues = []; GAME.clutter = [];
    GAME.issuesFixed = 0; GAME.lives = stats.lives; GAME.simonHits = 0; GAME.boss = null; GAME.pendingBossIntro = false;
    GAME.hiddenDoor = null; GAME.yard = null; GAME.mecha = null;
    GAME.nextState = 'PLAY'; GAME.aiResultText = null;
    GAME.startTime = Date.now(); GAME.booksFired = 0; GAME.opsPushed = 0;
    
    generateMap();
    GAME.entities.push({ type: 'simon', x: 100, y: 80, w: 16, h: 16 });
    document.getElementById('hud-layer').style.display = 'block'; updateHud();
    document.getElementById('boss-hud').style.display = 'none';
    
    // --- CHANGED: SHOW LOADING STATE INSTEAD OF HARDCODED TEXT ---
    const currentGen = GAME.genId;
    showThinking("Simon Unglaube", GFX.simonFace); // Shows "..." dialog

    callGemini(`You are Simon Unglaube, WHS Senior Regional Manager for Amazon MEU. Greet ${GAME.selectedChar} with dry humor and one quick, relevant safety reminder for starting the shift. Keep it witty. Max 18 words.`, "intro").then(text => {
        if (GAME.state === 'DIALOG' && GAME.genId === currentGen) {
             let finalText = text.replace(/\[.*?\]/g, GAME.selectedChar);
             showDialog(finalText, "Simon Unglaube", GFX.simonFace, true);
        }
    });
    updateMusicForState();
}

function generateMap() {
    GAME.map = [];
    for(let y=0; y<MAP_H; y++) {
        GAME.map[y] = [];
        for(let x=0; x<MAP_W; x++) {
            if (x===0 || x===MAP_W-1 || y===0 || y===MAP_H-1) GAME.map[y][x] = 1;
            else if (x > 5 && x < 55 && y % 5 === 0 && x % 3 !== 0) GAME.map[y][x] = 2;
            else {
                GAME.map[y][x] = 0;
                if (Math.random() < 0.05) {
                    const type = ['coffee','paper','tape'][Math.floor(Math.random()*3)];
                    GAME.clutter.push({x: x*TILE_SIZE + 4, y: y*TILE_SIZE + 4, type: type});
                }
            }
        }
    }
    for(let y=15; y<25; y++) for(let x=25; x<35; x++) GAME.map[y][x] = 0;

    const door = randomDoorPlacement();
    GAME.map[door.doorY][door.doorX] = 3;
    GAME.map[door.hazardY][door.hazardX] = 0;
    GAME.hiddenDoor = { ...door, unlocked: false };
    GAME.activeIssues.push({ x: door.hazardX*TILE_SIZE, y: door.hazardY*TILE_SIZE, data: {name: "Blocked Exit", type: "box"}, fixed: false, hiddenDoor: true });

    spawnEntity('runner'); spawnEntity('runner');

    const hazardList = pickRandomHazards(3);
    hazardList.forEach(rHazard => {
        const { tx, ty } = pickRandomFloorTile();
        GAME.activeIssues.push({ x: tx*TILE_SIZE, y: ty*TILE_SIZE, data: rHazard, fixed: false });
    });
    for(let i=0; i<8; i++) spawnEntity('ops');
    for(let i=0; i<10; i++) spawnEntity('assoc');
}

function spawnEntity(type) {
    let tx, ty;
    do { tx = Math.floor(Math.random()*(MAP_W-2))+1; ty = Math.floor(Math.random()*(MAP_H-2))+1; } while(GAME.map[ty][tx]!==0);
    GAME.entities.push({ type:type, x:tx*TILE_SIZE, y:ty*TILE_SIZE, dir:0, timer:0 });
}

function initSimonBoss() {
    GAME.state = 'BOSS_INTRO';
    AudioSys.sfx.bossIntro();
    GAME.boss = {
        name: "MEGA SIMON", sprite: "simonBoss", hp: 25, speed: 1.5, attackDelay: 30, 
        title: "THE WHS FINAL BOSS", desc: "He is not impressed.", attackName: "TERMINATION PROTOCOL",
        tauntsTriggered: [], tauntThresholds: [0.75, 0.5, 0.25], maxHp: 25,
        x: MAP_W * TILE_SIZE / 2, y: MAP_H * TILE_SIZE / 2, timer: 0 
    };
    GAME.entities = []; GAME.projectiles = [];
    updateMusicForState();
}

function initBossEncounter() {
    GAME.state = 'BOSS_INTRO';
    GAME.stateTimer = 0;
    GAME.pendingBossIntro = false;
    GAME.nextState = 'BOSS';
    AudioSys.sfx.bossIntro();
    const bossData = GAME.bossTypes[Math.floor(Math.random() * GAME.bossTypes.length)];
    GAME.boss = { ...bossData, x: MAP_W * TILE_SIZE / 2, y: MAP_H * TILE_SIZE / 2, w: 32, h: 32, maxHp: bossData.hp, timer: 0, tauntsTriggered: [], tauntThresholds: [0.75, 0.5, 0.25] };
    GAME.entities = []; GAME.projectiles = [];
    updateMusicForState();
}

function startYardLevel() {
    GAME.state = 'YARD_LEVEL';
    GAME.stateTimer = 0;
    const h = 520;
    GAME.yard = {
        height: h,
        cameraY: 0,
        playerX: canvas.width / 2 - 8,
        playerY: h - 32,
        speed: getCharStats(GAME.selectedChar).speed * 0.9,
        vehicles: [],
        flying: [],
        flyTimer: 120,
        tauntShown: false,
        tauntLine: ['You dare clock out without my permission?', 'Prime compliance at 0%. Unacceptable.', 'Little coordinator, big mistake.'][Math.floor(Math.random()*3)],
        tauntTimer: 260,
        maxAirBoxes: 7,
        throwers: [
            { x: 10, y: 26, cooldown: 70, variance: 40, timer: 60 },
            { x: canvas.width - 26, y: 26, cooldown: 70, variance: 40, timer: 80 }
        ],
        lanes: [
            { y: h - 90, dir: 1, speed: 0.8, timer: 90 },
            { y: h - 150, dir: -1, speed: 0.9, timer: 95 },
            { y: h - 210, dir: 1, speed: 1.0, timer: 100 },
            { y: h - 270, dir: -1, speed: 0.85, timer: 105 }
        ]
    };
    GAME.player.speed = GAME.yard.speed;
    GAME.projectiles = [];
    GAME.particles = [];
    GAME.floatingTexts = [];
    updateMusicForState();
}

function beginMechaEncounter() {
    GAME.state = 'MECHA_BOSS_INTRO';
    GAME.stateTimer = 0;
    GAME.mecha = {
        hp: 36,
        maxHp: 36,
        x: canvas.width / 2 - 32,
        y: 18,
        timer: 0,
        attackPhase: 0,
        attackTimer: 0,
        projectiles: [],
        shadows: [],
        beam: null
    };
    GAME.player.x = canvas.width / 2 - 8;
    GAME.player.y = canvas.height - 28;
    GAME.boss = { name: 'MECHA JEFF', hp: 36, maxHp: 36 };
    document.getElementById('boss-name-el').innerText = 'MECHA JEFF';
    document.getElementById('boss-hud').style.display = 'block';
    updateBossHud();
    updateMusicForState();
}

function startCredits() {
    GAME.state = 'CREDITS';
    GAME.stateTimer = 0;
    GAME.boss = null;
    document.getElementById('boss-hud').style.display = 'none';
    GAME.projectiles = [];
    GAME.particles = [];
    GAME.floatingTexts = [];
    updateMusicForState();
}

function queueVisitorSplash() {
    if (GAME.pendingBossIntro || GAME.boss) return;
    GAME.pendingBossIntro = true;
    GAME.nextState = 'VISITOR_SPLASH';
}

function showVisitorSplash() {
    GAME.state = 'VISITOR_SPLASH';
    GAME.stateTimer = 0;
    GAME.nextState = 'BOSS_INTRO';
    AudioSys.sfx.bossIntro();
    updateMusicForState();
}

function update() {
    GAME.ticks++;
    GAME.stateTimer++;
    if (GAME.shake > 0) GAME.shake--;
    if (GAME.flash > 0) GAME.flash--;

    if (GAME.state === 'LOSE_SPLASH' || GAME.state === 'WIN_SPLASH') {
        GAME.splashTimer--;
        const ready = GAME.aiResultText !== null;
        const waitedEnough = GAME.splashTimer <= 0;
        const fallbackTimer = -600;

        if (ready && waitedEnough) {
            const isWin = GAME.state === 'WIN_SPLASH';
            const speaker = isWin ? "Simon Unglaube" : "Simon Unglaube";
            let finalText = GAME.aiResultText.replace(/\[.*?\]/g, GAME.selectedChar);
            let header = isWin ? `OUTSTANDING!\n"${finalText}"\n` : `AUDIT FAILED\n"${finalText}"\n`;
            let stats = `\nStats:\nTime Spent: ${Math.floor((Date.now() - GAME.startTime)/1000)}s\nSafety Rules used: ${GAME.booksFired}\nOPS pushed back: ${GAME.opsPushed}\n(Press Space)`;
            showDialog(header + stats, speaker, GFX.simonFace, true);
            GAME.state = 'DIALOG'; GAME.nextState = 'TITLE';
        } else if (!ready && GAME.splashTimer <= fallbackTimer) {
            GAME.aiResultText = 'System could not load live review. Using cached performance log.';
        }
        return;
    }

    if (GAME.state === 'LOGO' && GAME.stateTimer > 240) advanceState();
    
    if (GAME.state === 'SELECT') {
        let changed = false;
        if (KEYS.left && GAME.ticks % 10 === 0) { GAME.charIndex--; AudioSys.sfx.step(); changed = true; }
        if (KEYS.right && GAME.ticks % 10 === 0) { GAME.charIndex++; AudioSys.sfx.step(); changed = true; }
        if (changed) {
            if (GAME.charIndex < 0) GAME.charIndex = GAME.charList.length - 1;
            if (GAME.charIndex >= GAME.charList.length) GAME.charIndex = 0;
            TTSSys.speak(GAME.charList[GAME.charIndex], "System");
        }
        return;
    }

    if (GAME.state === 'DIALOG') {
        if (GAME.dialogVisible.length < GAME.dialogText.length) {
            if (GAME.ticks % 2 === 0) {
                GAME.dialogVisible += GAME.dialogText[GAME.dialogVisible.length];
                document.getElementById('text-content').innerText = GAME.dialogVisible;
                AudioSys.sfx.text();
            }
        }
        return;
    }

    if (['LOGO', 'INTRO', 'STORY', 'TITLE', 'HOWTO', 'BOSS_INTRO', 'VISITOR_SPLASH'].includes(GAME.state)) return;

    if (GAME.state === 'YARD_LEVEL') { updateYardLevel(); updateParticles(); updateFloatingTexts(); return; }
    if (GAME.state === 'MECHA_BOSS') { updateMechaBattle(); updateParticles(); updateFloatingTexts(); return; }
    if (['YARD_INTRO', 'MECHA_BOSS_INTRO', 'CREDITS'].includes(GAME.state)) return;

    if (GAME.state === 'PLAY' || GAME.state === 'BOSS') {
        updatePlayer(); updateProjectiles(); updateParticles(); updateFloatingTexts(); updateCamera();
    }

    if (GAME.state === 'PLAY') updateEntities();
    if (GAME.state === 'BOSS') updateBoss();
}

function updatePlayer() {
    const p = GAME.player;
    if (p.iframe>0) p.iframe--; if (p.cooldown>0) p.cooldown--;
    let dx=0, dy=0;
    if (KEYS.up) dy = -p.speed; if (KEYS.down) dy = p.speed; if (KEYS.left) dx = -p.speed; if (KEYS.right) dx = p.speed;
    if (dx!==0 && dy!==0) { dx *= 0.707; dy *= 0.707; }
    if (dx!==0 || dy!==0) {
        if (!checkCol(p.x+dx, p.y)) p.x+=dx;
        if (!checkCol(p.x, p.y+dy)) p.y+=dy;
        if (GAME.ticks % 20 === 0) { AudioSys.sfx.step(); spawnParticle(p.x+8, p.y+16, '#555', 0); }
    }
}

function updateYardLevel() {
    if (!GAME.yard) return;
    const y = GAME.yard;
    GAME.player.x = y.playerX; GAME.player.y = y.playerY;

    let dx = 0, dy = 0;
    if (KEYS.up) dy = -y.speed; if (KEYS.down) dy = y.speed; if (KEYS.left) dx = -y.speed; if (KEYS.right) dx = y.speed;
    if (dx!==0 && dy!==0) { dx *= 0.707; dy *= 0.707; }
    y.playerX = Math.max(0, Math.min(canvas.width - 16, y.playerX + dx));
    y.playerY = Math.max(10, Math.min(y.height - 22, y.playerY + dy));
    GAME.player.x = y.playerX; GAME.player.y = y.playerY;

    const viewAnchor = y.playerY - canvas.height * 0.55;
    y.cameraY = Math.max(0, Math.min(y.height - canvas.height, viewAnchor));

    // flying package gauntlet near the top
    y.flyTimer--;
    const inSky = y.playerY < 200;
    if (inSky) {
        y.throwers.forEach(th => {
            th.timer--;
            if (th.timer <= 0 && y.flying.length < y.maxAirBoxes) {
                const target = y.playerX + 8 + (Math.random() * 16 - 8);
                const horiz = Math.max(-1.45, Math.min(1.45, (target - th.x) / 70));
                const rise = 0.85 + Math.random() * 0.25;
                y.flying.push({ x: th.x, y: th.y + 6, vx: horiz, vy: rise, w: 14, h: 14, t: 0 });
                th.timer = th.cooldown + Math.random() * th.variance;
            }
        });
        if (y.flyTimer <= 0 && y.flying.length < y.maxAirBoxes) {
            const fromLeft = Math.random() < 0.5;
            const startX = fromLeft ? -18 : canvas.width + 4;
            const speedX = (fromLeft ? 1 : -1) * (0.65 + Math.random() * 0.35);
            const wobble = 0.45 + Math.random() * 0.25;
            y.flying.push({ x: startX, y: 44 + Math.random() * 32, vx: speedX, vy: wobble, w: 14, h: 14, t: 0 });
            y.flyTimer = 70 + Math.random() * 40;
        }
        y.tauntTimer--;
        if (y.tauntTimer <= 0) {
            const jeffLines = [
                'Still climbing? I have prime time to waste.',
                'The skyboxes belong to me.',
                'You are late. Again.'
            ];
            y.tauntLine = jeffLines[Math.floor(Math.random() * jeffLines.length)];
            y.tauntTimer = 260;
        }
    } else {
        y.flyTimer = Math.min(y.flyTimer, 50);
        y.tauntTimer = Math.max(y.tauntTimer, 120);
    }

    y.lanes.forEach(lane => {
        lane.timer--;
        if (lane.timer <= 0) {
            const type = Math.random() < 0.6 ? 'van' : 'truck';
            const w = type === 'van' ? 34 : 52;
            const h = type === 'van' ? 16 : 20;
            const x = lane.dir === 1 ? -w : canvas.width + w;
            y.vehicles.push({ type, x, y: lane.y - h/2, w, h, dir: lane.dir, speed: lane.speed + Math.random()*0.2 });
            lane.timer = 90 + Math.random() * 90;
        }
    });

    for (let i = y.vehicles.length - 1; i >= 0; i--) {
        const v = y.vehicles[i];
        v.x += v.dir * v.speed;
        if (v.x < -80 || v.x > canvas.width + 80) { y.vehicles.splice(i,1); continue; }
        if (Math.abs((v.x + v.w/2) - (y.playerX + 8)) < (v.w/2 + 6) && Math.abs((v.y + v.h/2) - (y.playerY + 8)) < (v.h/2 + 6)) {
            if (GAME.player.iframe <= 0) {
                GAME.lives--; GAME.player.iframe = 90; GAME.flash = 8; AudioSys.sfx.hurt(); updateHud();
                y.playerX = canvas.width / 2 - 8; y.playerY = y.height - 32; y.cameraY = Math.max(0, y.height - canvas.height);
                if (GAME.lives <= 0 && !GAME.gameOverTriggered) { triggerGameOver('OVERWHELMED!'); return; }
            }
        }
    }

    for (let i = y.flying.length - 1; i >= 0; i--) {
        const f = y.flying[i];
        f.t++;
        f.x += f.vx;
        f.y += Math.sin(f.t / 12) * 0.4 + f.vy;
        if (f.x < -32 || f.x > canvas.width + 32 || f.y > 180) { y.flying.splice(i,1); continue; }
        if (Math.abs((f.x + f.w/2) - (y.playerX + 8)) < (f.w/2 + 6) && Math.abs((f.y + f.h/2) - (y.playerY + 8)) < (f.h/2 + 6)) {
            if (GAME.player.iframe <= 0) {
                GAME.lives--; GAME.player.iframe = 90; GAME.flash = 10; AudioSys.sfx.hurt(); updateHud();
                y.playerX = canvas.width / 2 - 8; y.playerY = Math.min(y.height - 32, y.playerY + 60); y.cameraY = Math.max(0, y.height - canvas.height);
                if (GAME.lives <= 0 && !GAME.gameOverTriggered) { triggerGameOver('OVERWHELMED!'); return; }
            }
        }
    }

    if (y.playerY <= 12) {
        GAME.nextState = 'MECHA_BOSS_INTRO';
        const jeffLines = [
            'You dare clock out without my permission?',
            'Prime compliance at 0%. Unacceptable.',
            'Your audit ends under my orbital beam.',
            'Little coordinator, big mistake.'
        ];
        if (!y.tauntShown) {
            y.tauntShown = true;
            y.tauntLine = jeffLines[Math.floor(Math.random()*jeffLines.length)];
            showDialog(y.tauntLine, 'Mecha Jeff', GFX.mechaJeff);
            return;
        }
        showDialog('The yard opens to something colossal...', 'Simon Unglaube', GFX.simonFace, true);
        return;
    }
}

function updateMechaBattle() {
    const m = GAME.mecha; if (!m) return;
    const p = GAME.player;
    if (p.iframe>0) p.iframe--; if (p.cooldown>0) p.cooldown--;

    let dx = 0, dy = 0;
    if (KEYS.up) dy = -p.speed; if (KEYS.down) dy = p.speed; if (KEYS.left) dx = -p.speed; if (KEYS.right) dx = p.speed;
    if (dx!==0 && dy!==0) { dx *= 0.707; dy *= 0.707; }
    p.x = Math.max(4, Math.min(canvas.width - 20, p.x + dx));
    p.y = Math.max(20, Math.min(canvas.height - 20, p.y + dy));

    m.timer++;
    m.attackTimer++;
    if (m.attackTimer > 320) { m.attackTimer = 0; m.attackPhase = (m.attackPhase + 1) % 3; m.shadows = []; m.beam = null; }

    if (m.attackPhase === 0 && m.timer % 90 === 0) {
        const activeDrones = m.projectiles.filter(pr => pr.type === 'drone').length;
        if (activeDrones < 2) {
            m.projectiles.push({ type: 'drone', x: m.x + 32, y: m.y + 24, vx: 0, vy: 0.35, life: 320 });
        }
    }
    if (m.attackPhase === 1 && m.timer % 65 === 0) {
        m.shadows.push({ x: Math.random() * (canvas.width - 20) + 4, timer: 50 });
    }
    if (m.attackPhase === 2 && !m.beam && m.timer % 150 === 0) {
        m.beam = { x: Math.random() * (canvas.width - 30) + 10, telegraph: 80, active: 28 };
    }

    for (let i = m.projectiles.length - 1; i >= 0; i--) {
        const pr = m.projectiles[i];
        if (pr.type === 'drone') {
            const angle = Math.atan2(p.y - pr.y, p.x - pr.x);
            const targetVx = Math.cos(angle) * 0.45;
            const targetVy = Math.sin(angle) * 0.45;
            pr.vx = pr.vx * 0.88 + targetVx * 0.12;
            pr.vy = pr.vy * 0.88 + targetVy * 0.12;
        } else if (pr.type === 'box') {
            pr.vy += 0.04;
        }
        pr.x += pr.vx || 0; pr.y += pr.vy || 0; pr.life = (pr.life || 200) - 1;
        if (pr.y > canvas.height + 40 || pr.life <= 0) { m.projectiles.splice(i,1); continue; }
        if (Math.abs((pr.x + 8) - (p.x + 8)) < 10 && Math.abs((pr.y + 8) - (p.y + 8)) < 12) {
            if (p.iframe <= 0) {
                GAME.lives--; p.iframe = 90; GAME.flash = 8; AudioSys.sfx.hurt(); updateHud();
                if (GAME.lives <= 0 && !GAME.gameOverTriggered) { triggerGameOver('OVERWHELMED!'); return; }
            }
            m.projectiles.splice(i,1);
        }
    }

    for (let i = m.shadows.length - 1; i >= 0; i--) {
        m.shadows[i].timer--;
        if (m.shadows[i].timer <= 0) {
            const x = m.shadows[i].x;
            m.projectiles.push({ type: 'box', x, y: -16, vy: 1.2, vx: 0, life: 260 });
            m.shadows.splice(i,1);
        }
    }

    if (m.beam) {
        if (m.beam.telegraph > 0) m.beam.telegraph--;
        else if (m.beam.active > 0) {
            m.beam.active--;
            if (p.x + 8 > m.beam.x && p.x + 8 < m.beam.x + 14 && p.iframe <= 0) {
                GAME.lives--; p.iframe = 90; GAME.flash = 10; AudioSys.sfx.hurt(); updateHud();
                if (GAME.lives <= 0 && !GAME.gameOverTriggered) { triggerGameOver('OVERWHELMED!'); return; }
            }
        } else { m.beam = null; }
    }

    for (let i = GAME.projectiles.length - 1; i >= 0; i--) {
        const a = GAME.projectiles[i];
        a.x += a.vx; a.y += a.vy; a.life--;
        if (a.x < -20 || a.x > canvas.width + 20 || a.y < -20 || a.y > canvas.height + 20 || a.life <= 0) { GAME.projectiles.splice(i,1); continue; }
        if (Math.abs((a.x + 6) - (m.x + 32)) < 32 && Math.abs((a.y + 6) - (m.y + 32)) < 32) {
            m.hp--; GAME.boss.hp = m.hp; updateBossHud(); GAME.projectiles.splice(i,1); AudioSys.sfx.bossHit(); spawnFloatingText(m.x+32, m.y+12, 'Hit!', '#ff2e63');
            if (m.hp <= 0) {
                GAME.nextState = 'CREDITS';
                showDialog('Impressive. You actually crushed Evil Jeff Bezos. Audit notes: flawless.', 'Simon Unglaube', GFX.simonFace);
                return;
            }
        }
    }
}

// --- BANTER SYSTEM ---
function spawnFloatingText(x, y, text, color='#fff') {
    GAME.floatingTexts.push({
        x: x + 8, y: y, 
        text: text, color: color, 
        life: 210, vy: -0.2 // Slower, longer life (3.5s)
    });
    AudioSys.sfx.pop();
}

function triggerBanter(entity) {
    if (!entity || Math.random() > 0.8) return; // Don't trigger every time
    
    const now = Date.now();
    const useAI = (now - GAME.lastAIBanterTime > 15000) && (Math.random() < 0.3); // 30% chance if cooldown over
    const category = (entity.type === 'ops') ? 'banter_ops' : 'banter_assoc';
    
    if (useAI && apiKey) {
        GAME.lastAIBanterTime = now;
        let prompt = "";
        if (entity.type === 'ops') prompt = "Short, funny bark (max 3 words) from an Amazon Warehouse Ops Manager yelling about productivity.";
        else prompt = "Short, funny thought (max 3 words) from a tired Amazon Warehouse Associate.";

        // ASYNC CALL - DOES NOT BLOCK GAME
        callGemini(prompt, category).then(text => {
            // Check if entity still alive/relevant, otherwise just spawn near player or drop
            if (GAME.entities.includes(entity)) {
                 spawnFloatingText(entity.x, entity.y, text, (entity.type==='ops'?'#ffcc00':'#ccc'));
            }
        });
    } else {
        // Hardcoded fallback
        const text = getRandomFallback(category, category);
        spawnFloatingText(entity.x, entity.y, text, (entity.type==='ops'?'#ffcc00':'#ccc'));
    }
}

function updateEntities() {
    GAME.entities.forEach(e => {
        if (e.type === 'simon') return;
        
        // Banter Trigger (Random Chance)
        if (Math.random() < 0.002) triggerBanter(e); // Low chance per tick

        if (e.type === 'ops') {
            let d = Math.hypot(GAME.player.x - e.x, GAME.player.y - e.y);
            if (d < 100) {
                if (GAME.player.x > e.x) e.x += 0.4; else e.x -= 0.4;
                if (GAME.player.y > e.y) e.y += 0.4; else e.y -= 0.4;
            }
            if (d < 80 && Math.random() < 0.01) {
                let angle = Math.atan2(GAME.player.y - e.y, GAME.player.x - e.x);
                GAME.projectiles.push({ type: 'req', x: e.x, y: e.y, vx: Math.cos(angle)*2, vy: Math.sin(angle)*2, life: 80 });
                AudioSys.sfx.alert();
            }
        }
        if (e.type === 'assoc') {
            if (Math.random() < 0.02) e.dir = Math.floor(Math.random()*4);
            let s = 0.3;
            if (e.dir===0) e.y-=s; else if(e.dir===1) e.y+=s; else if(e.dir===2) e.x-=s; else e.x+=s;
        }
        if (e.type === 'runner') {
            if (Math.random() < 0.05) e.dir = Math.floor(Math.random()*4);
            let s = 0.8; 
            let nx = e.x, ny = e.y;
            if (e.dir===0) ny-=s; else if(e.dir===1) ny+=s; else if(e.dir===2) nx-=s; else nx+=s;
            if (!checkCol(nx, ny)) { e.x = nx; e.y = ny; } else e.dir = Math.floor(Math.random()*4); 
        }
    });
}

function updateBoss() {
    const b = GAME.boss; const p = GAME.player;
    document.getElementById('boss-hud').style.display = 'block'; document.getElementById('boss-name-el').innerText = b.name; updateBossHud();
    
    let hpPct = b.hp / b.maxHp;
    if (b.tauntThresholds.length > 0 && hpPct < b.tauntThresholds[0]) {
         b.tauntThresholds.shift(); 
         const currentGen = GAME.genId;
         let prompt = b.name === "SIMON UNGLAUBE" ? "Simon Unglaube final warning. Max 25 words." : `Taunt from boss ${b.name}. Max 25 words.`;
         
         let portrait = b.name.includes("Simon") ? GFX.simonBoss : GFX.boss_manager;
         
         // --- CHANGED: IMMEDIATE PAUSE WITH LOADING DIALOG ---
         showThinking(b.name, portrait);

         callGemini(prompt, "taunt").then(text => {
            if (GAME.state === 'DIALOG' && GAME.genId === currentGen) {
                 showDialog(text, b.name, portrait, true);
            }
        });
    }
    if (isNaN(b.x) || isNaN(b.y)) return;
    let dx = 0, dy = 0; let dist = Math.hypot(p.x - b.x, p.y - b.y);
    if (dist > 50) {
        let angle = Math.atan2(p.y - b.y, p.x - b.x);
        dx = Math.cos(angle) * b.speed; dy = Math.sin(angle) * b.speed;
        if (!checkCol(b.x + dx, b.y)) b.x += dx; if (!checkCol(b.x, b.y + dy)) b.y += dy;
    }
    b.timer++;
    if (b.timer > b.attackDelay) {
        b.timer = 0;
        for (let i = -1; i <= 1; i++) {
            let angle = Math.atan2(p.y - b.y, p.x - b.x) + (i * 0.3);
            GAME.projectiles.push({ type: 'req', x: b.x + 16 + Math.cos(angle)*10, y: b.y + 16 + Math.sin(angle)*10, vx: Math.cos(angle)*2.5, vy: Math.sin(angle)*2.5, life: 100, boss: true, grace: 10 });
        }
        AudioSys.sfx.alert(); GAME.shake = 5; 
    }
}

function updateProjectiles() {
    for(let i=GAME.projectiles.length-1; i>=0; i--) {
        let p = GAME.projectiles[i];
        p.x += p.vx; p.y += p.vy; p.life--; if(p.grace > 0) p.grace--;
        if (p.grace <= 0 && checkCol(p.x, p.y)) { GAME.projectiles.splice(i,1); continue; }
        if (p.life <= 0) { GAME.projectiles.splice(i,1); continue; }
        if ((p.type === 'req') && Math.hypot(p.x-GAME.player.x, p.y-GAME.player.y) < 10) {
            if (GAME.player.iframe<=0) {
                GAME.lives--; GAME.player.iframe = 120; GAME.shake = 10; GAME.flash = 10; AudioSys.sfx.hurt(); updateHud();
                if (GAME.lives<=0 && !GAME.gameOverTriggered) triggerGameOver("OVERWHELMED!");
            }
            GAME.projectiles.splice(i,1);
        }
        if (p.type === 'attack') {
            const attackMeta = getAttackData(p.owner);
            if (GAME.state === 'BOSS' && GAME.boss) {
                if (Math.hypot(p.x - (GAME.boss.x+16), p.y - (GAME.boss.y+16)) < 24) {
                    GAME.boss.hp--; updateBossHud(); AudioSys.sfx.bossHit(); GAME.shake = 5; spawnParticle(p.x, p.y, attackMeta.color || '#ff0000', -2); GAME.projectiles.splice(i,1);
                    spawnFloatingText(GAME.boss.x+16, GAME.boss.y+8, attackMeta.text || 'Hit!', attackMeta.color || '#ff0000');
                    if (GAME.boss.hp <= 0) winGame(); continue;
                }
            }
            if (GAME.state === 'PLAY') {
                let simon = GAME.entities.find(e => e.type === 'simon');
                if (simon && Math.hypot(p.x-simon.x, p.y-simon.y) < 12) {
                     GAME.simonHits++; AudioSys.sfx.angry(); GAME.projectiles.splice(i,1);
                     if (GAME.simonHits <= 2) {
                         const warningIndex = GAME.simonHits - 1;
                         const currentGen = GAME.genId;
                         GAME.nextState = 'PLAY';

                         // --- CHANGED: REMOVED HARDCODED FALLBACK DISPLAY. SHOW LOADING. ---
                         showThinking("Simon Unglaube", GFX.simonFace);

                         callGemini(`You are Simon Unglaube. Deliver a ${warningIndex === 0 ? "first" : "final"} warning to the coordinator who keeps throwing rule books at you. Keep it sharp, under 24 words.`, "simon_warning", { warningIndex }).then(text => {
                             if (GAME.genId === currentGen && GAME.state === 'DIALOG') {
                                  showDialog(text, "Simon Unglaube", GFX.simonFace, true);
                             }
                         });
                     }
                     else if (GAME.simonHits >= 3) initSimonBoss();
                     continue;
                }
                let hit = false;
                GAME.entities.forEach(e => {
                    if (e.type === 'ops' && Math.hypot(p.x-e.x, p.y-e.y) < 12) {
                        e.type = 'assoc'; AudioSys.sfx.hit(); spawnParticle(e.x, e.y, attackMeta.color || '#fff', -2); GAME.opsPushed++;
                        spawnFloatingText(e.x, e.y, attackMeta.text || "My Rates!", attackMeta.color || "#ff0000");
                        hit = true;
                    }
                });
                if (hit) GAME.projectiles.splice(i,1);
            }
        }
    }
}

function updateParticles() {
    for(let i=GAME.particles.length-1; i>=0; i--) {
        let p = GAME.particles[i]; p.life--; p.x += p.vx; p.y += p.vy; p.vy += 0.2;
        if (p.y > p.groundY) { p.y = p.groundY; p.vy *= -0.6; }
        if (p.life <= 0) GAME.particles.splice(i,1);
    }
}

function updateFloatingTexts() {
    for(let i=GAME.floatingTexts.length-1; i>=0; i--) {
        let t = GAME.floatingTexts[i];
        t.y += t.vy; t.life--;
        if (t.life <= 0) GAME.floatingTexts.splice(i,1);
    }
}

function spawnParticle(x, y, color, forceY = 0) { 
    GAME.particles.push({ x:x, y:y, color:color, life:40, vx: (Math.random() - 0.5) * 2, vy: forceY || (Math.random() * -2), groundY: y + 5 }); 
}

function throwBook() {
    const p = GAME.player; if (p.cooldown > 0) return; const attackMeta = getAttackData(GAME.selectedChar); p.cooldown = attackMeta.cooldown || 120; p.cooldownMax = attackMeta.cooldown || 120; GAME.booksFired++;
    const speed = attackMeta.speed || 4;
    let vx=0, vy=0;
    if (GAME.state === 'BOSS' && GAME.boss) {
        let angle = Math.atan2((GAME.boss.y+16) - p.y, (GAME.boss.x+16) - p.x); vx = Math.cos(angle) * speed; vy = Math.sin(angle) * speed;
    } else if (GAME.state === 'MECHA_BOSS' && GAME.mecha) {
        let angle = Math.atan2((GAME.mecha.y+32) - p.y, (GAME.mecha.x+32) - p.x); vx = Math.cos(angle) * speed; vy = Math.sin(angle) * speed;
    } else {
        let target = null; let minDist = 200;
        GAME.entities.forEach(e => { if (e.type === 'ops') { let d = Math.hypot(e.x - p.x, e.y - p.y); if (d < minDist) { minDist = d; target = e; } } });
        if (target) { let angle = Math.atan2(target.y - p.y, target.x - p.x); vx = Math.cos(angle) * speed; vy = Math.sin(angle) * speed; }
        else { if (KEYS.up) vy=-speed; else if (KEYS.down) vy=speed; else if (KEYS.left) vx=-speed; else vx=speed; }
    }
    GAME.projectiles.push({ type:'attack', owner: GAME.selectedChar, sprite: attackMeta.sprite, color: attackMeta.color, x:p.x+8, y:p.y+8, vx, vy, life:attackMeta.life || 40, text: attackMeta.text }); AudioSys.sfx.throw();
}

function tryInteract() {
    const p = GAME.player;
    for (let i=0; i<GAME.entities.length; i++) {
        let e = GAME.entities[i];
        if (e.type === 'runner' && Math.hypot(p.x-e.x, p.y-e.y) < 20) {
             e.type = 'assoc'; GAME.issuesFixed++; updateHud(); AudioSys.sfx.fix();
             spawnFloatingText(e.x, e.y, "Safe!", "#00ff00");
             
             if (GAME.issuesFixed >= 5) { queueVisitorSplash(); }

             // SIMON COMMENTARY
             const currentGen = GAME.genId;
             
             // --- CHANGED: Show thinking state immediately for responsiveness ---
             showThinking("Simon Unglaube", GFX.simonFace);

             callGemini(
                 "You are Simon Unglaube, WHS Senior Regional Manager. The player stopped a runner. Praise the player with dry, professional humor and add a witty safety reminder about slowing down. Max 22 words.",
                 "runners"
             ).then(tip => {
                if (GAME.genId === currentGen) showDialog(`Fixed: Runner!\n${tip}`, "Simon Unglaube", GFX.simonFace, true);
             });
             return true;
        }
    }
    for(let h of GAME.activeIssues) {
        if (!h.fixed && Math.hypot(p.x-h.x, p.y-h.y) < 20) {
            h.fixed = true; GAME.issuesFixed++; updateHud(); AudioSys.sfx.fix();
            if (h.hiddenDoor && GAME.hiddenDoor) GAME.hiddenDoor.unlocked = true;
            spawnFloatingText(h.x, h.y, "Fixed!", "#00ff00");
            
            if (GAME.issuesFixed >= 5) { queueVisitorSplash(); }

            // SIMON COMMENTARY
            const currentGen = GAME.genId;
            
            // --- CHANGED: Show thinking state immediately ---
            showThinking("Simon Unglaube", GFX.simonFace);

            callGemini(
                `You are Simon Unglaube, WHS Senior Regional Manager. A hazard "${h.data.name}" was fixed. Praise the player with dry, professional humor and share one specific safety tip tied to that hazard. Max 32 words.`,
                "hazard",
                { hazardName: h.data.name }
            ).then(tip => {
                if (GAME.genId === currentGen) showDialog(`Fixed: ${h.data.name}!\n${tip}`, "Simon Unglaube", GFX.simonFace, true);
            });
            return true;
        }
    }
    if (GAME.hiddenDoor && GAME.hiddenDoor.unlocked) {
        const dx = GAME.player.x - GAME.hiddenDoor.doorX * TILE_SIZE;
        const dy = GAME.player.y - GAME.hiddenDoor.doorY * TILE_SIZE;
        if (Math.hypot(dx, dy) < 18) {
            GAME.state = 'YARD_INTRO';
            GAME.stateTimer = 0;
            GAME.nextState = 'YARD_LEVEL';
            GAME.projectiles = [];
            updateMusicForState();
            return true;
        }
    }
    return false;
}

function triggerGameOver(reason) {
    GAME.gameOverTriggered = true; GAME.nextState = 'TITLE'; GAME.state = 'LOSE_SPLASH'; GAME.splashTimer = 260; GAME.aiResultText = null; GAME.stateTimer = 0;
    document.getElementById('boss-hud').style.display = 'none'; document.getElementById('dialog-box').style.display = 'none';
    document.getElementById('hud-layer').style.display = 'none';
    const time = Math.floor((Date.now() - GAME.startTime)/1000); const currentGen = GAME.genId;
    if (reason === "FIRED!") { GAME.aiResultText = "Terminated for unsafe behavior."; }
    else {
        const stats = { time, hazards: GAME.issuesFixed, books: GAME.booksFired, ops: GAME.opsPushed };
        callGemini(`You are Simon Unglaube, WHS Senior Regional Manager. Coordinator failed after ${time}s with ${GAME.issuesFixed}/5 hazards fixed, ${GAME.booksFired} rule books thrown, ${GAME.opsPushed} ops pushed. Deliver a scathing yet funny performance review that weaves those stats into a safety lesson. Max 50 words.`, "reviews_loss", { stats }).then(review => {
             if (GAME.genId === currentGen) { GAME.aiResultText = review; }
        });
    }
}

function winGame() {
    AudioSys.sfx.start(); MusicSys.play('victory'); GAME.nextState = 'TITLE'; GAME.state = 'WIN_SPLASH'; GAME.splashTimer = 260; GAME.aiResultText = null; GAME.stateTimer = 0;
    document.getElementById('boss-hud').style.display = 'none'; document.getElementById('dialog-box').style.display = 'none';
    document.getElementById('hud-layer').style.display = 'none';
    const currentGen = GAME.genId; const time = Math.floor((Date.now() - GAME.startTime)/1000);
    const stats = { time, hazards: GAME.issuesFixed, books: GAME.booksFired, ops: GAME.opsPushed };
    callGemini(`You are Simon Unglaube, WHS Senior Regional Manager. Coordinator won in ${time}s clearing ${GAME.issuesFixed}/5 hazards, tossing ${GAME.booksFired} rule books, redirecting ${GAME.opsPushed} ops. Give warm but witty praise plus one practical safety takeaway using those stats. Max 55 words.`, "reviews_win", { stats }).then(praise => {
        if (GAME.genId === currentGen) GAME.aiResultText = praise;
    });
}

function updateBossHud() { if(GAME.boss) document.getElementById('boss-health-el').style.width = Math.max(0, (GAME.boss.hp / GAME.boss.maxHp) * 100) + '%'; }

function checkCol(x, y) {
    let tx = Math.floor((x+8)/TILE_SIZE); let ty = Math.floor((y+8)/TILE_SIZE);
    if (tx<0||tx>=MAP_W||ty<0||ty>=MAP_H) return true;
    return GAME.map[ty][tx] !== 0;
}

function updateHud() { document.getElementById('life-val').innerText = "❤️".repeat(Math.max(0, GAME.lives)); document.getElementById('score-val').innerText = GAME.issuesFixed + "/5"; }

function showDialog(text, speaker, portrait, isAI = false) {
    GAME.state = 'DIALOG'; GAME.dialogText = (speaker ? speaker + ":\n" : "") + text; GAME.dialogVisible = "";
    const box = document.getElementById('dialog-box'); const badge = document.getElementById('gemini-badge'); const port = document.getElementById('portrait'); const pCtx = port.getContext('2d');
    box.style.display = 'flex'; document.getElementById('text-content').innerText = ""; 
    badge.style.display = isAI ? 'block' : 'none';
    badge.innerHTML = isAI ? "✨ SIMON IS ANALYZING..." : ""; // Reset badge text
    pCtx.fillStyle = '#000'; pCtx.fillRect(0,0,32,32);
    if (portrait) pCtx.drawImage(portrait, 0, 0); else { pCtx.fillStyle='#fff'; pCtx.fillText("!", 10, 20); }
    AudioSys.sfx.text();
    if (speaker) TTSSys.speak(text.replace(speaker + ":\n", "").replace(/\n/g, ' '), speaker);
}

// --- NEW FUNCTION: Show "Thinking" state ---
function showThinking(speaker, portrait) {
    GAME.state = 'DIALOG';
    GAME.dialogText = ""; // No typed text yet
    GAME.dialogVisible = "";
    const box = document.getElementById('dialog-box');
    const badge = document.getElementById('gemini-badge');
    const port = document.getElementById('portrait');
    const pCtx = port.getContext('2d');
    
    box.style.display = 'flex';
    document.getElementById('text-content').innerHTML = "<span class='loading-dots'>PROCESSING</span>"; // Loading animation
    
    badge.style.display = 'block';
    badge.innerText = "✨ UPLINK ESTABLISHED...";
    
    pCtx.fillStyle = '#000'; pCtx.fillRect(0,0,32,32);
    if (portrait) pCtx.drawImage(portrait, 0, 0);
    
    AudioSys.sfx.text();
}

function closeDialog() {
    TTSSys.cancel(); AudioSys.sfx.step(); document.getElementById('dialog-box').style.display = 'none';
    GAME.state = GAME.nextState;

    if (GAME.state === 'VISITOR_SPLASH') { showVisitorSplash(); return; }

    if (GAME.state === 'YARD_LEVEL') { startYardLevel(); return; }
    if (GAME.state === 'MECHA_BOSS_INTRO') { beginMechaEncounter(); return; }
    if (GAME.state === 'CREDITS') { startCredits(); return; }

    if (GAME.state === 'PLAY' && GAME.pendingBossIntro && !GAME.boss) {
        showVisitorSplash();
        return;
    }
    if (GAME.state === 'PLAY' && GAME.issuesFixed >= 5 && !GAME.boss && !GAME.pendingBossIntro) {
        queueVisitorSplash();
        showVisitorSplash();
        return;
    }

    updateMusicForState();
}

function updateMusicForState() {
    let rate = 1;
    let track = 'title';

    if (['LOGO', 'INTRO', 'STORY', 'TITLE'].includes(GAME.state)) track = 'title';
    else if (['HOWTO', 'SELECT'].includes(GAME.state)) track = 'menu';
    else if (['PLAY', 'YARD_INTRO', 'YARD_LEVEL'].includes(GAME.state)) track = 'ingame';
    else if (GAME.state === 'VISITOR_SPLASH') track = 'boss';
    else if (GAME.state === 'BOSS' || GAME.state === 'BOSS_INTRO') track = 'boss';
    else if (GAME.state === 'MECHA_BOSS' || GAME.state === 'MECHA_BOSS_INTRO') { track = 'boss'; rate = 0.85; }
    else if (GAME.state === 'CREDITS') track = 'victory';

    MusicSys.play(track, rate);
}

function drawSnesSplash(isWin) {
    const t = GAME.stateTimer;
    const primary = isWin ? '#0d1b4c' : '#2d0a0f';
    const accent = isWin ? '#7dd3fc' : '#f87171';
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, isWin ? '#0a102a' : '#1a0408');
    gradient.addColorStop(0.5, primary);
    gradient.addColorStop(1, '#000');
    ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Moving scanlines
    for (let y = 0; y < canvas.height; y += 8) {
        const offset = Math.sin((t / 8) + y * 0.12) * 3;
        ctx.fillStyle = `rgba(255,255,255,${isWin ? 0.05 : 0.04})`;
        ctx.fillRect(offset, y, canvas.width, 2);
    }

    // Mode-7 style horizon lines
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height * 0.65);
    for (let i = 0; i < 18; i++) {
        const scale = (i + 1) / 18;
        const wave = Math.sin((t / 10) + i * 0.6) * 4;
        const w = canvas.width * (1.1 - scale * 0.6);
        const y = i * 12 + wave;
        ctx.strokeStyle = `${accent}80`;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(-w / 2, y);
        ctx.lineTo(w / 2, y);
        ctx.stroke();
    }
    ctx.restore();

    // Star glints
    for (let i = 0; i < 14; i++) {
        const x = (Math.sin((t + i * 13) / 6) * 0.5 + 0.5) * canvas.width;
        const y = (i * 37 + t * 2) % canvas.height;
        const alpha = 0.25 + ((i % 3) * 0.1);
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.fillRect(x, y, 2, 2);
        ctx.fillRect(x - 2, y, 6, 1);
        ctx.fillRect(x, y - 2, 1, 6);
    }

    ctx.textAlign = 'center';
    ctx.fillStyle = '#000';
    ctx.font = '22px monospace';
    const text = isWin ? 'COMPLIANT!' : 'TERMINATED';
    const shadowOffsets = [[2,2],[-2,2],[2,-2],[-2,-2]];
    shadowOffsets.forEach(([dx, dy]) => ctx.fillText(text, canvas.width/2 + dx, canvas.height/2 - 6 + dy));

    ctx.fillStyle = accent;
    ctx.fillText(text, canvas.width/2, canvas.height/2 - 6);
    ctx.font = '11px monospace';
    ctx.fillStyle = '#fef9c3';
    const sub = isWin ? 'CALCULATING SAFETY SCORE...' : 'PREPARING EXIT INTERVIEW...';
    ctx.fillText(sub, canvas.width/2, canvas.height/2 + 20);
    ctx.textAlign = 'start';
}

function drawYardLevel() {
    const y = GAME.yard;
    const camY = y ? y.cameraY || 0 : 0;
    const yardHeight = y ? y.height : canvas.height;

    ctx.save();
    ctx.translate(0, -camY);

    // asphalt base with SNES-style tiling and parallax skyline
    ctx.fillStyle = '#0b1224'; ctx.fillRect(0,0,canvas.width, yardHeight);
    ctx.fillStyle = '#0f172a';
    for (let ty = -8; ty < yardHeight + 16; ty += 16) {
        for (let tx = (ty % 32 === 0 ? 0 : 8); tx < canvas.width; tx += 16) {
            ctx.fillRect(tx, ty, 12, 12);
        }
    }
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    for (let ty = 0; ty < yardHeight; ty += 8) {
        for (let tx = 4; tx < canvas.width; tx += 16) ctx.fillRect(tx, ty + ((tx + ty) % 16 === 0 ? 2 : 0), 2, 2);
    }

    // skyline silhouettes
    ctx.fillStyle = '#0f172a';
    for (let x=0; x<canvas.width; x+=40) {
        const h = 30 + (Math.sin(x * 0.3) * 6 + 6);
        ctx.fillRect(x, 4, 24, h);
        ctx.fillStyle = '#111827'; ctx.fillRect(x+10, 2, 18, h+6); ctx.fillStyle = '#0f172a';
    }
    ctx.fillStyle = '#1f2937'; ctx.fillRect(0, 32, canvas.width, 6);
    ctx.fillStyle = '#94a3b8'; for (let x=8; x<canvas.width; x+=28) ctx.fillRect(x, 30, 6, 2);

    // curbs and dock edges
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0, yardHeight - 18, canvas.width, 18);
    ctx.fillStyle = '#334155'; ctx.fillRect(0, yardHeight - 22, canvas.width, 4);
    ctx.fillStyle = '#64748b'; for (let x=0; x<canvas.width; x+=14) ctx.fillRect(x, yardHeight - 16, 8, 3);
    ctx.fillStyle = '#fef08a'; ctx.fillRect(0,2,canvas.width,3);
    ctx.fillStyle = '#22c55e'; ctx.fillRect(0,0,canvas.width,2);

    // painted dock goal
    ctx.fillStyle = '#14532d'; ctx.fillRect(0,0,canvas.width,10);
    ctx.fillStyle = '#facc15'; ctx.fillRect(0,10,canvas.width,2);
    ctx.fillStyle = '#94a3b8'; ctx.fillRect(0,12,canvas.width,3);
    ctx.fillStyle = '#0ea5e9'; for (let x=6; x<canvas.width; x+=34) ctx.fillRect(x,14,14,2);

    // lane bands and markings
    if (y) {
        ctx.setLineDash([8, 10]);
        ctx.strokeStyle = '#facc15'; ctx.lineWidth = 2;
        y.lanes.forEach(lane => {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0, lane.y - 20, canvas.width, 40);
            ctx.fillStyle = '#111827'; ctx.fillRect(0, lane.y - 14, canvas.width, 28);
            ctx.beginPath(); ctx.moveTo(0, lane.y); ctx.lineTo(canvas.width, lane.y); ctx.stroke();
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, lane.y - 22, canvas.width, 2);
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, lane.y + 20, canvas.width, 2);
        });
        ctx.setLineDash([]);
    }

    // chainlink and palettes
    ctx.fillStyle = '#1f2937'; for (let x=0; x<canvas.width; x+=32) ctx.fillRect(x+2, 32, 28, 4);
    ctx.fillStyle = '#0ea5e9'; for (let x=0; x<canvas.width; x+=26) ctx.fillRect(x+6, 28, 2, 8);
    ctx.fillStyle = '#f97316'; for (let x=10; x<canvas.width; x+=60) ctx.fillRect(x, yardHeight - 36, 8, 16);
    ctx.fillStyle = '#9ca3af'; for (let x=6; x<canvas.width; x+=50) ctx.fillRect(x, yardHeight - 48, 14, 6);
    ctx.fillStyle = '#1e293b'; ctx.fillRect(0, 62, canvas.width, 18);
    ctx.fillStyle = '#0ea5e9'; for (let x=8; x<canvas.width; x+=44) ctx.fillRect(x, 66, 14, 6);
    ctx.fillStyle = '#f8fafc'; for (let x=14; x<canvas.width; x+=36) ctx.fillRect(x, 64, 6, 2);

    if (y) {
        y.vehicles.forEach(v => {
            const sprite = v.type === 'van' ? GFX.van : GFX.truck;
            ctx.drawImage(sprite, v.x, v.y);
        });
        y.flying.forEach(f => {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(f.x + 7, f.y + 14, 8, 3, 0, 0, Math.PI*2); ctx.fill();
            ctx.drawImage(GFX.flyingBox, f.x, f.y);
        });
        if (y.throwers) {
            y.throwers.forEach(th => {
                ctx.fillStyle = 'rgba(0,0,0,0.25)';
                ctx.beginPath(); ctx.ellipse(th.x + 8, th.y + 18, 7, 3, 0, 0, Math.PI*2); ctx.fill();
                ctx.drawImage(GFX.assoc, th.x, th.y);
            });
        }
        if ((y.tauntShown || y.playerY < 120) && y.tauntLine) {
            ctx.drawImage(GFX.mechaJeff, canvas.width/2 - 32, y.cameraY + 2, 64, 64);
            ctx.fillStyle = '#0ea5e9'; ctx.font = '9px monospace'; ctx.textAlign = 'center';
            ctx.fillText(y.tauntLine.toUpperCase(), canvas.width/2, y.cameraY + 70);
            ctx.textAlign = 'left';
        }
    }

    ctx.drawImage(GFX.chars[GAME.selectedChar], GAME.player.x, GAME.player.y);
    ctx.fillStyle = '#facc15'; ctx.font = '8px monospace'; ctx.fillText('GOAL', 8, 8);
    ctx.restore();
}

function drawMechaBattle() {
    ctx.fillStyle = '#0b1020'; ctx.fillRect(0,0,canvas.width, canvas.height);
    for (let i=0; i<80; i++) { ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.2})`; ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 1,1); }
    ctx.fillStyle = '#1f2937'; ctx.fillRect(0,30,canvas.width, canvas.height-30);
    ctx.fillStyle = '#0ea5e9'; ctx.fillRect(0,30,canvas.width,2);

    const m = GAME.mecha;
    if (m) ctx.drawImage(GFX.mechaJeff, m.x, m.y);

    ctx.drawImage(GFX.chars[GAME.selectedChar], GAME.player.x, GAME.player.y);

    if (m) {
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        m.shadows.forEach(s => { ctx.beginPath(); ctx.ellipse(s.x+8, canvas.height-18, 10, 4, 0, 0, Math.PI*2); ctx.fill(); });
        m.projectiles.forEach(pr => {
            if (pr.type === 'drone') { ctx.fillStyle = '#22d3ee'; ctx.fillRect(pr.x, pr.y, 12, 12); ctx.fillStyle = '#0ea5e9'; ctx.fillRect(pr.x+2, pr.y+2, 8,8); }
            if (pr.type === 'box') { ctx.fillStyle = '#f59e0b'; ctx.fillRect(pr.x, pr.y, 14,14); ctx.fillStyle = '#92400e'; ctx.fillRect(pr.x+2, pr.y+10, 10,2); }
        });
        if (m.beam) {
            if (m.beam.telegraph > 0) { ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(m.beam.x, 30, 14, canvas.height-30); }
            else { ctx.fillStyle = 'rgba(14,165,233,0.5)'; ctx.fillRect(m.beam.x, 30, 14, canvas.height-30); ctx.fillStyle = '#38bdf8'; ctx.fillRect(m.beam.x+4, 30, 6, canvas.height-30); }
        }
    }

    GAME.particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2); });
    GAME.floatingTexts.forEach(t => { ctx.fillStyle = t.color; ctx.fillText(t.text, t.x, t.y); });
}

function drawCredits() {
    const t = GAME.stateTimer;
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = '#1f2937'; ctx.fillRect(6,6,canvas.width-12, canvas.height-12);
    ctx.drawImage(GFX.erwinFace, canvas.width/2 - 48, 12, 96, 96);
    ctx.fillStyle = '#eab308'; ctx.font = '10px monospace'; ctx.textAlign = 'center';
    ctx.fillText('CONGRATULATIONS! HIDDEN LEVEL CLEARED.', canvas.width/2, 118);

    const credits = [
        'Lead Developer: Erwin Esener',
        'Art Director: Erwin Esener',
        'Sound Engineer: Erwin Esener',
        'QA Lead: Erwin Esener',
        'Logistics Wizard: Erwin Esener',
        'Catering: Erwin Esener',
        'Moral Support: Erwin Esener',
        'Everything Else: Erwin Esener'
    ];
    const startY = canvas.height + 20 - t * 0.25;
    ctx.fillStyle = '#fff'; ctx.font = '9px monospace';
    credits.forEach((line, i) => { ctx.fillText(line, canvas.width/2, startY + i*16); });
    ctx.textAlign = 'left';
    if (GAME.stateTimer > 600) {
        ctx.fillStyle = '#94a3b8'; ctx.font = '8px monospace';
        ctx.fillText('[SPACE TO SKIP]', 8, canvas.height - 10);
    }
}

function draw() {
    if (GAME.state === 'LOSE_SPLASH') { drawSnesSplash(false); return; }
    if (GAME.state === 'WIN_SPLASH') { drawSnesSplash(true); return; }

    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
    let dxShake = 0, dyShake = 0;
    if (GAME.shake > 0) { dxShake = (Math.random() - 0.5) * GAME.shake; dyShake = (Math.random() - 0.5) * GAME.shake; }
    ctx.save(); ctx.translate(dxShake, dyShake);

    if (GAME.state === 'LOGO') { 
        let alpha = 1.0; if(GAME.stateTimer < 30) alpha = GAME.stateTimer / 30; if(GAME.stateTimer > 200) alpha = (240 - GAME.stateTimer) / 40;
        ctx.globalAlpha = Math.max(0, Math.min(1, alpha)); let offset = Math.max(0, 100 - GAME.stateTimer * 2);
        ctx.drawImage(GFX.logo, 28 - offset, 90);
        if (GAME.stateTimer > 80) { ctx.fillStyle = '#fff'; ctx.font = '10px monospace'; ctx.fillText("ERWIN ESENER", 80, 105); ctx.fillStyle = '#eab308'; ctx.font = '14px monospace'; ctx.fillText("PRODUCTIONS", 80, 125); }
        if(GAME.stateTimer > 60 && GAME.stateTimer < 65) { ctx.fillStyle='white'; ctx.fillRect(0,0,256,224); }
        ctx.restore(); return; 
    }
    if (GAME.state === 'INTRO') { 
        ctx.fillStyle='#eab308'; ctx.fillText("THE WAREHOUSE...", 20, 60); ctx.fillStyle='#fff';
        ctx.fillText("Ops Managers obsess over rates.", 20, 90); ctx.fillText("They throw Crazy Requests.", 20, 110);
        ctx.fillText("You must protect Safety.", 20, 130); ctx.fillText("Stop runners. Fix hazards.", 20, 150);
        ctx.fillStyle='#888'; ctx.fillText("[SPACE TO SKIP]", 80, 200); ctx.restore(); return; 
    }
    if (GAME.state === 'STORY') {
        ctx.fillStyle='#eab308'; ctx.font='10px monospace'; ctx.fillText("MISSION BRIEFING", 20, 40); ctx.fillStyle='#fff';
        ctx.fillText("Simon Unglaube asks you to:", 20, 70); ctx.fillText("- Do the safety audit", 20, 90);
        ctx.fillText("- Dodge crazy Ops requests", 20, 110); ctx.fillText("- Push back with rules", 20, 130);
        ctx.fillText("- Deal with 'visitors'", 20, 150); ctx.fillStyle='#888'; ctx.fillText("[PRESS SPACE]", 80, 200); ctx.restore(); return;
    }
    if (GAME.state === 'TITLE') {
        let offset = (Date.now() / 20) % 256; ctx.strokeStyle = '#004400'; ctx.lineWidth = 1;
        for(let i=0; i<20; i++) { ctx.beginPath(); ctx.moveTo(0, i*20 + (offset%20)); ctx.lineTo(256, i*20 + (offset%20)); ctx.stroke(); ctx.beginPath(); ctx.moveTo(i*20, 0); ctx.lineTo(i*20, 224); ctx.stroke(); }
        ctx.fillStyle='#eab308'; ctx.font='20px monospace'; ctx.fillText("AMZL WHS QUEST", 40, 60); 
        ctx.font='10px monospace'; ctx.fillStyle='#fff'; ctx.fillText("PRESS SPACE TO START", 60, 120); 
        ctx.fillStyle='#888'; ctx.fillText("Code by Erwin", 85, 200); ctx.restore(); return; 
    }
    if (GAME.state === 'HOWTO') {
        ctx.fillStyle='#fff'; ctx.font='12px monospace'; ctx.fillText("HOW TO PLAY", 80, 30); ctx.font='10px monospace';
        ctx.fillStyle='#eab308'; ctx.fillText("WASD / ARROWS : MOVE", 20, 60); ctx.fillStyle='#aaa'; ctx.fillText("Navigate the warehouse.", 20, 75);
        ctx.fillStyle='#eab308'; ctx.fillText("SPACE : INTERACT / SHOOT", 20, 100); ctx.fillStyle='#aaa'; ctx.fillText("Fix hazards or throw rules.", 20, 115);
        ctx.fillStyle='#eab308'; ctx.fillText("GOAL: FIND 5 HAZARDS", 20, 140); ctx.fillStyle='#aaa'; ctx.fillText("Then defeat the boss!", 20, 155);
        ctx.fillStyle='#fff'; ctx.fillText("[PRESS SPACE]", 80, 190); ctx.restore(); return;
    }
    if (GAME.state === 'SELECT') {
        const frameX = 14, frameY = 28, frameW = 228, frameH = 168;
        ctx.fillStyle = '#0a0a0a'; ctx.fillRect(frameX, frameY, frameW, frameH);
        ctx.strokeStyle = '#222'; ctx.lineWidth = 2; ctx.strokeRect(frameX - 2, frameY - 2, frameW + 4, frameH + 4);
        ctx.fillStyle = '#111'; ctx.fillRect(frameX + 6, frameY + 30, frameW - 12, frameH - 44);

        ctx.textAlign = 'center';
        ctx.fillStyle='#eab308'; ctx.font='12px monospace';
        ctx.fillText("CHOOSE COORDINATOR", frameX + frameW / 2, frameY + 16);
        ctx.fillStyle='#888'; ctx.font='8px monospace';
        ctx.fillText("ARROWS TO BROWSE | SPACE TO START", frameX + frameW / 2, frameY + 28);

        let name = GAME.charList[GAME.charIndex]; let data = CHAR_DATA[name];
        const portraitX = frameX + 18, portraitY = frameY + 46;
        ctx.fillStyle = '#000'; ctx.fillRect(portraitX - 2, portraitY - 2, 56, 56);
        ctx.strokeStyle = '#333'; ctx.strokeRect(portraitX - 4, portraitY - 4, 60, 60);
        ctx.save(); ctx.imageSmoothingEnabled = false; ctx.drawImage(GFX.chars[name], portraitX, portraitY, 52, 52); ctx.restore();

        ctx.fillStyle='#eab308'; ctx.font='12px monospace';
        ctx.fillText("< " + name + " >", frameX + frameW / 2, frameY + 54);

        ctx.textAlign = 'left';
        ctx.font='8px monospace'; ctx.fillStyle='#00ffff';
        const textStartX = portraitX + 70; const textStartY = frameY + 70;
        ctx.fillText("ROLE: " + data.role, textStartX, textStartY);

        const wrapText = (text, maxChars = 30) => {
            const words = text.split(' '); const lines = []; let line = '';
            words.forEach(word => { const candidate = line.length ? line + ' ' + word : word; if (candidate.length > maxChars) { lines.push(line); line = word; } else { line = candidate; } });
            if (line) lines.push(line); return lines;
        };
        const backstoryLines = wrapText(data.backstory, 30).slice(0, 3);
        ctx.fillStyle='#fff'; backstoryLines.forEach((l, idx) => ctx.fillText(l, textStartX, textStartY + 14 + idx * 12));

        ctx.fillStyle='#ff00ff';
        ctx.fillText("ATTACK: " + data.attack, frameX + 18, frameY + frameH - 30);

        ctx.textAlign = 'center';
        ctx.fillStyle='#888'; ctx.font='10px monospace';
        ctx.fillText("PRESS SPACE", frameX + frameW / 2, frameY + frameH - 12);
        ctx.restore(); return;
    }
    if (GAME.state === 'YARD_INTRO') {
        ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = '#eab308'; ctx.font = '14px monospace'; ctx.fillText('HIDDEN DOOR', 60, 60);
        ctx.fillStyle = '#fff'; ctx.font = '10px monospace';
        ctx.fillText('You sneak into the Amazon Yard.', 20, 100);
        ctx.fillText('Dodge DSP vans and semis.', 20, 120);
        ctx.fillText('Reach the top without getting clipped.', 20, 140);
        ctx.fillStyle = '#9ca3af'; ctx.fillText('[PRESS SPACE TO RUN]', 50, 190);
        ctx.restore(); return;
    }
    if (GAME.state === 'YARD_LEVEL') { drawYardLevel(); ctx.restore(); return; }
    if (GAME.state === 'VISITOR_SPLASH') {
        const t = GAME.stateTimer;
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#1a0f2e');
        gradient.addColorStop(1, '#2a1b44');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let y = -20; y < canvas.height + 20; y += 12) {
            const offset = (t * 2) % 24;
            ctx.fillStyle = y % 24 === 0 ? 'rgba(255,215,0,0.08)' : 'rgba(255,255,255,0.05)';
            ctx.fillRect(((t * 3) + y * 2) % canvas.width, y + offset, canvas.width, 6);
        }

        ctx.save();
        ctx.translate(canvas.width / 2, 90);
        ctx.textAlign = 'center';
        const wobble = 1 + Math.sin(t / 10) * 0.05;
        ctx.scale(wobble, wobble);
        ctx.fillStyle = '#000';
        ctx.font = '16px "Press Start 2P", monospace';
        ctx.fillText("SURPRISE VISITOR!", 0, 0);
        ctx.fillStyle = '#eab308';
        ctx.shadowColor = '#ff00ff';
        ctx.shadowBlur = 8;
        ctx.fillText("SURPRISE VISITOR!", -2, -2);
        ctx.restore();

        ctx.textAlign = 'center';
        ctx.fillStyle = '#ffd166';
        ctx.font = '8px monospace';
        ctx.fillText("An unannounced Visitor is stepping onto the floor...", canvas.width / 2, 148);
        ctx.fillStyle = '#fff';
        ctx.fillText("Simon braces: tighten PPE, breathe, and stand tall.", canvas.width / 2, 166);

        ctx.fillStyle = '#ff00ff';
        ctx.font = '10px monospace';
        ctx.fillText("[PRESS SPACE TO CONTINUE]", canvas.width / 2, 204);
        ctx.textAlign = 'left';
        ctx.restore(); return;
    }
    if (GAME.state === 'MECHA_BOSS_INTRO' && GAME.mecha) {
        ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = '#eab308'; ctx.font = '16px monospace'; ctx.fillText('MECHA JEFF RISES', 30, 40);
        ctx.drawImage(GFX.mechaJeff, 92, 60, 72, 72);
        ctx.fillStyle = '#fff'; ctx.font = '9px monospace';
        ctx.fillText('Prime Drone Swarm', 20, 150);
        ctx.fillText('2-Day Shipping Storm', 20, 166);
        ctx.fillText('Orbital Beam Audit', 20, 182);
        ctx.fillStyle = '#9ca3af'; ctx.fillText('[PRESS SPACE TO DEFY]', 60, 206);
        ctx.restore(); return;
    }
    if (GAME.state === 'MECHA_BOSS') { drawMechaBattle(); ctx.restore(); return; }
    if (GAME.state === 'CREDITS') { drawCredits(); ctx.restore(); return; }
    if (GAME.state === 'BOSS_INTRO' && GAME.boss) {
        ctx.fillStyle = '#222'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#eab308'; ctx.font = '16px monospace'; ctx.fillText("WARNING", 80, 50);
        ctx.fillStyle = '#ff0000'; ctx.font = '12px monospace'; ctx.fillText(GAME.boss.name.toUpperCase(), 20, 90);
        ctx.fillStyle = '#fff'; ctx.font = '8px monospace'; ctx.fillText(GAME.boss.title, 20, 110);
        ctx.fillStyle = '#888'; ctx.fillText(GAME.boss.desc, 20, 130);
        ctx.save();
        ctx.imageSmoothingEnabled = false;
        const portraitFrameX = 170, portraitFrameY = 70, portraitSize = 88;
        ctx.fillStyle = '#000';
        ctx.fillRect(portraitFrameX - 4, portraitFrameY - 4, portraitSize + 8, portraitSize + 8);
        ctx.strokeStyle = '#444';
        ctx.strokeRect(portraitFrameX - 6, portraitFrameY - 6, portraitSize + 12, portraitSize + 12);
        const bossSprite = (GAME.boss.sprite && GFX[GAME.boss.sprite]) ? GFX[GAME.boss.sprite] : GFX.boss_manager;
        ctx.drawImage(bossSprite, portraitFrameX, portraitFrameY, portraitSize, portraitSize);
        ctx.restore();
        ctx.fillStyle = '#eab308'; ctx.fillText("ATTACK: " + GAME.boss.attackName, 20, 160);
        ctx.fillStyle = '#fff'; ctx.fillText("[PRESS SPACE TO FIGHT]", 50, 200); ctx.restore(); return;
    }

    const cx = Math.floor(GAME.camera.x); const cy = Math.floor(GAME.camera.y);
    let sx = Math.floor(cx/TILE_SIZE); let ex = sx + 17; let sy = Math.floor(cy/TILE_SIZE); let ey = sy + 15;
    for(let y=sy; y<=ey; y++) {
        for(let x=sx; x<=ex; x++) {
            if(x>=0 && x<MAP_W && y>=0 && y<MAP_H) {
                let t = GAME.map[y][x]; let dx = x*TILE_SIZE - cx; let dy = y*TILE_SIZE - cy;
                if (t===0) ctx.drawImage(GFX.floor, dx, dy); if (t===1) ctx.drawImage(GFX.wall, dx, dy);
                if (t===2) { ctx.drawImage(GFX.floor, dx, dy); ctx.drawImage(GFX.shelf, dx, dy); }
                if (t===3) { ctx.drawImage(GFX.wall, dx, dy); ctx.drawImage(GFX.door, dx, dy); }
            }
        }
    }

    GAME.clutter.forEach(c => { let img = GFX.clutter[c.type]; if(img) ctx.drawImage(img, c.x-cx, c.y-cy); });
    GAME.activeIssues.forEach(h => { if(!h.fixed) { let img = GFX.hazards[h.data.type] || GFX.hazards.box; ctx.drawImage(img, h.x-cx, h.y-cy); } });

    let renderList = [GAME.player, ...GAME.entities, ...GAME.projectiles];
    if (GAME.state === 'BOSS' && GAME.boss) renderList.push(GAME.boss);
    renderList.sort((a,b) => a.y - b.y);

    renderList.forEach(e => {
        let dx = Math.floor(e.x - cx); let dy = Math.floor(e.y - cy);
        if (e.maxHp) {
            let img = (e.sprite && GFX[e.sprite]) ? GFX[e.sprite] : GFX.boss_manager;
            if (e.name === "SIMON UNGLAUBE") img = GFX.simonBoss;
            ctx.drawImage(img, dx, dy, 32, 32);
        } else {
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(dx+8, dy+14, 6, 3, 0, 0, Math.PI*2); ctx.fill();
            if (e.type === 'simon') ctx.drawImage(GFX.simon, dx, dy);
            else if (e.type === 'ops') ctx.drawImage(GFX.ops, dx, dy);
            else if (e.type === 'assoc') ctx.drawImage(GFX.assoc, dx, dy);
            else if (e.type === 'runner') ctx.drawImage(GFX.runner, dx, dy);
            else if (e === GAME.player) {
                if (e.iframe%4 < 2) ctx.drawImage(GFX.chars[GAME.selectedChar], dx, dy);
                if (e.cooldown > 0) { ctx.fillStyle = '#555'; ctx.fillRect(dx, dy-4, 16, 2); ctx.fillStyle = '#00ffff'; ctx.fillRect(dx, dy-4, 16 * (1 - e.cooldown/Math.max(1, e.cooldownMax || 120)), 2); }
                else { ctx.fillStyle = '#00ff00'; ctx.fillRect(dx+6, dy-6, 4, 4); }
            }
            else if (e.type === 'attack') {
                const sprite = (GFX.attacks && GFX.attacks[e.owner]) ? GFX.attacks[e.owner] : GFX.book;
                ctx.drawImage(sprite, dx+2, dy+4);
            }
            else if (e.type === 'book') ctx.drawImage(GFX.book, dx, dy);
            else if (e.type === 'req') { if (e.boss) ctx.drawImage(GFX.bossProj, dx, dy); else ctx.drawImage(GFX.req, dx, dy); }
        }
    });

    GAME.particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x-cx, p.y-cy, 2, 2); });

    // Render Floating Text
    ctx.font = '8px "Press Start 2P"'; ctx.textAlign = 'center';
    GAME.floatingTexts.forEach(t => {
        let dx = Math.floor(t.x - cx); let dy = Math.floor(t.y - cy);
        ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeText(t.text, dx, dy);
        ctx.fillStyle = t.color; ctx.fillText(t.text, dx, dy);
    });
    ctx.textAlign = 'left'; // Reset

    if (GAME.flash > 0) { ctx.globalAlpha = GAME.flash / 10; ctx.fillStyle = 'white'; ctx.fillRect(0,0,canvas.width, canvas.height); ctx.globalAlpha = 1.0; }
    ctx.restore();
}

function updateCamera() {
    GAME.camera.x = Math.max(0, Math.min(GAME.player.x - 120, MAP_W*TILE_SIZE - 256));
    GAME.camera.y = Math.max(0, Math.min(GAME.player.y - 100, MAP_H*TILE_SIZE - 224));
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
init();
</script>
</body>
</html>
