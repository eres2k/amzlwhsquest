<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AMZL WHS Coordinator Quest - A retro-style warehouse safety adventure game">
    <title>AMZL WHS Coordinator Quest - Modular</title>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/game.css">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
</head>
<body>

<div id="game-container">
    <div id="game-wrapper">
        <div id="ai-status">AI Status: Init</div>
        <canvas id="gameCanvas" width="256" height="224"></canvas>
        <div id="crt-overlay"></div>
        <div id="vignette"></div>

        <div id="ui-overlay">
            <div id="slogan-display"></div>

            <div class="hud-text" id="hud-layer" style="display:none;">
                <div style="color:#ff4444; margin-bottom:5px;">LIFE <span id="life-val">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
                <div style="color:#44ff44;">HAZARDS: <span id="score-val">0/5</span></div>
                <div style="color:#22d3ee; margin-top:3px; font-size:8px;">SP: <span id="sp-val">0</span></div>
                <div style="color:#66aaff; margin-top:3px; font-size:8px;">REGION: <span id="region-val">EU</span></div>
            </div>

            <div id="boss-hud">
                <div class="boss-name" id="boss-name-el">BOSS NAME</div>
                <div class="boss-bar-bg"><div class="boss-bar-fill" id="boss-health-el"></div></div>
            </div>

            <div id="dialog-box">
                <canvas id="portrait" width="48" height="48"></canvas>
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div id="gemini-badge" class="gemini-badge"></div>
                    <div id="text-content"></div>
                    <div id="press-space-hint">‚ñº TAP / SPACE</div>
                </div>
            </div>

            <!-- INTRO CONVERSATION CENTERED PORTRAIT WINDOW -->
            <div id="intro-portrait-window">
                <div id="intro-portrait-frame">
                    <canvas id="intro-portrait" width="96" height="96"></canvas>
                    <div id="intro-speaker-name"></div>
                </div>
                <div id="intro-dialog-content">
                    <div id="intro-gemini-badge" class="gemini-badge"></div>
                    <div id="intro-text-content"></div>
                    <div id="intro-press-space-hint">‚ñº TAP / SPACE</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="mobile-controls">
        <div class="dpad-container">
            <div id="dpad-up" class="dpad-btn">‚ñ≤</div>
            <div id="dpad-left" class="dpad-btn">‚óÄ</div>
            <div class="dpad-center"></div>
            <div id="dpad-right" class="dpad-btn">‚ñ∂</div>
            <div id="dpad-down" class="dpad-btn">‚ñº</div>
            <!-- Gyro indicator overlays the dpad -->
            <div id="gyro-indicator">
                <div class="gyro-dot"></div>
            </div>
        </div>
        <!-- Control mode toggle button in middle -->
        <div id="control-mode-toggle">
            <span class="mode-icon">üéÆ</span>
            <span class="mode-label">DPAD</span>
        </div>
        <div class="action-container">
            <div id="action-btn">A</div>
            <div id="auto-shoot-indicator">AUTO-FIRE</div>
        </div>
    </div>
</div>

<!-- Game Initialization -->
<script type="module">
    import { Game } from './src/core/Game.js';
    import { AudioSystem, MusicSystem } from './src/systems/AudioSystem.js';
    import { TTSSystem } from './src/systems/TTSSystem.js';
    import { InputSystem } from './src/systems/InputSystem.js';

    // Wait for DOM to be ready
    window.addEventListener('DOMContentLoaded', async () => {
        console.log('[Main] DOM loaded, initializing modular game...');

        // Get canvas
        const canvas = document.getElementById('gameCanvas');

        if (!canvas) {
            console.error('[Main] Canvas element not found!');
            return;
        }

        // Initialize systems
        const audioSystem = new AudioSystem();
        const musicSystem = new MusicSystem();
        const ttsSystem = new TTSSystem();
        const inputSystem = new InputSystem();

        audioSystem.init();
        musicSystem.init();
        ttsSystem.init();

        // Expose systems globally for debugging and access from other modules
        window.audioSystem = audioSystem;
        window.musicSystem = musicSystem;
        window.ttsSystem = ttsSystem;
        window.inputSystem = inputSystem;

        // Create game instance
        window.game = new Game(canvas);
        window.GAME = window.game; // Alias for compatibility

        // Initialize game
        const success = await window.game.init();

        if (success) {
            console.log('[Main] Game initialized successfully');

            // Initialize input system with game's action handler
            inputSystem.init(() => {
                if (window.game && window.game.handleAction) {
                    window.game.handleAction();
                }
            });

            // Start game
            window.game.start();

            console.log('[Main] Game started');
        } else {
            console.error('[Main] Game initialization failed');

            // Show error message
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0000';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText('INITIALIZATION FAILED', canvas.width / 2, canvas.height / 2);
            ctx.font = '10px monospace';
            ctx.fillText('Check console for details', canvas.width / 2, canvas.height / 2 + 20);
        }
    });

    // Expose game instance for debugging
    console.log('[Main] Game will be available as window.game');

    // Service worker registration (for PWA)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('[Main] Service Worker registered'))
            .catch(err => console.warn('[Main] Service Worker registration failed:', err));
    }
</script>

<!-- Debug Info -->
<script>
    console.log('%cüéÆ AMZL WHS COORDINATOR QUEST', 'font-size: 16px; font-weight: bold; color: #ffd700;');
    console.log('%cModular Architecture Version', 'font-size: 12px; color: #00ffff;');
    console.log('%c- Separated CSS/JS/HTML', 'color: #22c55e;');
    console.log('%c- ES6 Modules', 'color: #22c55e;');
    console.log('%c- System-based Architecture', 'color: #22c55e;');
    console.log('%c- Data-driven Design', 'color: #22c55e;');
    console.log('%c\nPress F3 to toggle debug mode', 'color: #ff9900;');
</script>
</body>
</html>
